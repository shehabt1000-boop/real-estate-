<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">

    <!-- PWA Settings -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/609/609803.png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Preload Critical Assets -->
    <link rel="preload" as="image" href="https://images.pexels.com/photos/19213018/pexels-photo-19213018.jpeg?auto=compress&cs=tinysrgb&w=800&h=600&dpr=1">
    <link rel="preload" as="image" href="https://images.pexels.com/photos/14270540/pexels-photo-14270540.jpeg?auto=compress&cs=tinysrgb&w=1600&h=900&dpr=1">

    <title>ุงูุณูู ููุงู | ุนูุงุฑุงุช ูุตุฑ</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { 
                extend: { 
                    colors: { navy: '#0f172a', darkbg: '#1e293b', brand: '#10b981' },
                    fontFamily: { sans: ['Cairo', 'sans-serif'] },
                    screens: { 'xs': '400px' },
                    zIndex: { '60': '60', '70': '70', '100': '100' }
                } 
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        html { background-color: #0f172a; }
        body { 
            font-family: 'Cairo', sans-serif; 
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
            background-color: transparent;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .select-none { user-select: none; }

        /* Background */
        #app-background {
            position: fixed; top: 0; left: 0; width: 100%; height: 100vh; height: 100lvh; 
            z-index: -50;
            background-image: url('https://images.pexels.com/photos/14270540/pexels-photo-14270540.jpeg?auto=compress&cs=tinysrgb&w=1600&h=900&dpr=1');
            background-size: cover; background-position: center; background-repeat: no-repeat;
            pointer-events: none; will-change: transform; transform: translate3d(0,0,0);
        }
        #app-background::after { content: ''; position: absolute; inset: 0; background: rgba(241, 245, 249, 0.15); }
        .dark #app-background::after { background: rgba(15, 23, 42, 0.15); }

        /* Animations */
        @keyframes shimmer { 0% { background-position: -1000px 0; } 100% { background-position: 1000px 0; } }
        .skeleton { animation: shimmer 1.5s infinite linear; background: linear-gradient(to right, #f1f5f9 4%, #e2e8f0 25%, #f1f5f9 36%); background-size: 1000px 100%; }
        .dark .skeleton { background: linear-gradient(to right, #1e293b 4%, #334155 25%, #1e293b 36%); }
        @keyframes popIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .animate-pop { animation: popIn 0.15s ease-out forwards; will-change: transform, opacity; }

        /* Modals - High Z-Index */
        .modal-overlay { 
            position: fixed; inset: 0; z-index: 100; 
            background-color: rgba(0,0,0,0.8); 
            display: flex; align-items: center; justify-content: center; 
            padding: 1rem; 
            backdrop-filter: blur(2px);
        }
        .mobile-full-modal { 
            position: relative; width: 100%; max-width: 32rem; 
            background-color: white; 
            display: flex; flex-direction: column; 
            max-height: 90vh; height: auto;
            border-radius: 1.5rem; overflow: hidden; 
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        /* Mobile Full Screen Override */
        @media (max-width: 767px) {
            .mobile-full-modal { height: 100dvh; max-height: 100dvh; border-radius: 0; }
            .modal-overlay { padding: 0; }
        }
        .dark .mobile-full-modal { background-color: #1e293b; }

        /* Header & Nav - Lower Z-Index than Modal */
        .sticky-header { 
            z-index: 40; transform: translateZ(0); 
            background-color: rgba(255, 255, 255, 0.95);
            border-bottom-left-radius: 1.5rem; border-bottom-right-radius: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .dark .sticky-header { background-color: rgba(15, 23, 42, 0.95); }

        .sticky-search-bar {
            position: sticky; top: 3.5rem; z-index: 30; margin: 0 0.5rem 0.5rem 0.5rem; 
            padding: 0.25rem; border-radius: 0.75rem; background: rgba(255, 255, 255, 0.9); 
            border: 1px solid rgba(0,0,0,0.1); box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: transform 0.2s;
        }
        .dark .sticky-search-bar { background: rgba(30, 41, 59, 0.9); border-color: rgba(255,255,255,0.1); }

        #bottom-nav { z-index: 40; }

        /* Splash */
        #splash-screen { 
            position: fixed; inset: 0; z-index: 9999; background-color: #0f172a;
            background-image: linear-gradient(rgba(15, 23, 42, 0.40), rgba(15, 23, 42, 0.60)), url('https://images.pexels.com/photos/19213018/pexels-photo-19213018.jpeg?auto=compress&cs=tinysrgb&w=800&h=600&dpr=1');
            background-size: cover; background-position: center;
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            transition: opacity 0.3s ease-out, visibility 0.3s; 
        }
        .hidden-splash { opacity: 0; visibility: hidden; pointer-events: none; }

        /* UI Elements */
        .input-box { width: 100%; background: white; border: 1px solid #cbd5e1; border-radius: 0.5rem; padding: 0.6rem 0.8rem; font-size: 0.85rem; font-weight: 700; outline: none; color: #0f172a; transition: all 0.2s; }
        .dark .input-box { background: #1e293b; border-color: #475569; color: white; }
        .input-box:focus { border-color: #10b981; box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1); }
        
        .custom-select { appearance: none; background-color: #f8fafc; border: 1px solid #000; border-radius: 0.4rem; padding: 0.4rem 1.5rem 0.4rem 0.5rem; width: 100%; font-weight: 700; font-size: 0.75rem; color: #334155; cursor: pointer; }
        .dark .custom-select { background-color: #1e293b; color: white; border-color: #94a3b8; }
        .custom-select-wrapper { position: relative; }
        .custom-select-icon { position: absolute; left: 0.5rem; top: 50%; transform: translateY(-50%); pointer-events: none; color: #64748b; width: 0.8rem; height: 0.8rem; }

        .modern-table { border-collapse: collapse; width: 100%; }
        .modern-table td, .modern-table th { padding: 0.4rem; border-bottom: 1px solid #e2e8f0; }
        .dark .modern-table td, .dark .modern-table th { border-color: #334155; }
        .modern-table tr:nth-child(even) { background-color: #f8fafc; }
        .dark .modern-table tr:nth-child(even) { background-color: #1e293b; }
        .amenity-tile input:checked + div { background-color: #10b981; color: white; border-color: #10b981; }
        
        #filter-panel { display: none; opacity: 0; transform: scaleY(0.95); transform-origin: top; transition: opacity 0.15s ease, transform 0.15s ease; }
        #filter-panel.open { display: block; opacity: 1; transform: scaleY(1); }
        body.keyboard-open #bottom-nav { display: none; }

        .profile-btn-header { display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .profile-img-header { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; border: 2px solid #10b981; }
        .profile-name-header { font-size: 0.75rem; font-weight: 800; color: #0f172a; display: flex; flex-direction: column; line-height: 1.2; }
        .dark .profile-name-header { color: #ffffff; }
        .profile-welcome-sub { font-size: 0.6rem; color: #64748b; font-weight: 600; }
        .dark .profile-welcome-sub { color: #94a3b8; }
        
        /* Toast */
        .toast { animation: slideInDown 0.2s ease-out forwards; }
        .toast.hiding { animation: fadeOut 0.2s ease-in forwards; }
    </style>
</head>
<body class="text-slate-800 dark:text-slate-100 select-none">

    <!-- Splash Screen -->
    <div id="splash-screen">
        <div class="splash-icon-container">
            <div class="splash-ring"></div>
            <svg class="splash-logo" xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline><circle cx="12" cy="7" r="2" fill="#10b981" stroke="none"></circle></svg>
        </div>
        <div class="mt-4 text-white font-bold text-lg tracking-wide">ุงูุณูู <span class="text-emerald-500">ููุงู</span></div>
    </div>

    <!-- Wrapper -->
    <div id="app-content-wrapper">
        <div id="app-background"></div>
        <div id="toast-container" class="fixed top-4 left-0 right-0 z-[110] flex flex-col items-center gap-2 pointer-events-none px-4"></div>

        <!-- Header -->
        <header class="fixed top-0 w-full sticky-header flex items-center justify-between px-4 h-12 shadow-sm border-b border-slate-100 dark:border-slate-800">
            <div class="flex flex-col justify-center" id="header-welcome-section">
                <span class="text-[9px] font-bold text-slate-500 dark:text-slate-400 leading-none">ูุฑุญุจุง ุจูู ูู</span>
                <span class="text-[10px] font-black text-slate-800 dark:text-white leading-tight">ุณูู <span class="text-emerald-600 dark:text-emerald-400">ุงูุนูุงุฑุงุช</span></span>
            </div>

            <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 flex flex-col items-center cursor-pointer group" id="logo-trigger">
                <div class="w-10 h-10 flex items-center justify-center bg-slate-900 text-white rounded-full border-2 border-emerald-600 dark:border-emerald-500 shadow-lg group-hover:scale-110 transition-all duration-300">
                    <i data-lucide="building-2" class="w-5 h-5 text-white"></i>
                </div>
            </div>

            <div class="flex gap-2 items-center">
                <button id="btn-header-login" onclick="toggleModal('auth-modal')" class="p-1.5 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-white hover:bg-slate-200 transition"><i data-lucide="user" class="w-4 h-4"></i></button>
                <button id="btn-logout" onclick="logoutUser()" class="hidden p-1.5 rounded-full bg-red-50 dark:bg-red-900/20 text-red-600 hover:bg-red-100 transition"><i data-lucide="log-out" class="w-4 h-4"></i></button>
                <button onclick="toggleDarkMode()" class="p-1.5 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-yellow-400 hover:bg-slate-200 transition"><i data-lucide="moon" class="w-3.5 h-3.5 block dark:hidden"></i><i data-lucide="sun" class="w-3.5 h-3.5 hidden dark:block"></i></button>
                <button onclick="toggleAdminPanel()" id="btn-admin-top" class="hidden bg-slate-100 dark:bg-slate-800 p-1.5 rounded-full text-slate-600 dark:text-white"><i data-lucide="shield" class="w-3.5 h-3.5"></i></button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="pt-[3rem] pb-20 container mx-auto px-2 max-w-5xl min-h-screen">
            <div class="sticky-search-bar">
                <div class="relative w-full">
                    <button onclick="toggleFilterPanel()" class="absolute left-1 top-0 h-full w-9 flex items-center justify-center text-slate-500 hover:text-slate-800 dark:hover:text-white transition z-10"><i data-lucide="sliders-horizontal" class="w-4 h-4"></i></button>
                    <input type="text" id="search-input" placeholder="ุงุจุญุซ (ุดูุฉุ ุฃุฑุถุ ุนููุงู)..." class="w-full bg-transparent border-none rounded-lg pl-10 pr-9 py-1 text-xs outline-none dark:text-white font-bold h-8">
                    <button onclick="performSearch()" class="absolute right-1 top-0 h-full w-9 flex items-center justify-center text-slate-500 hover:text-emerald-600 transition"><i data-lucide="search" class="w-4 h-4"></i></button>
                </div>
                <div id="filter-panel" class="mt-2 border-t border-slate-200 dark:border-slate-700 pt-2">
                    <div class="space-y-1.5">
                        <div class="flex justify-between items-center pb-1">
                            <h3 class="text-[10px] font-bold text-slate-700 dark:text-white flex items-center gap-1"><i data-lucide="filter" class="w-3 h-3"></i> ุชุตููุฉ</h3>
                            <button onclick="resetFilters()" class="text-[9px] text-red-500 font-bold underline cursor-pointer">ุฅุนุงุฏุฉ ุชุนููู</button>
                        </div>
                        <div class="custom-select-wrapper"><select id="filter-cat" class="custom-select py-1 text-[10px]"><option value="">ูู ุงูุฃูุณุงู</option><option value="apartment">ุดูู</option><option value="villa">ููู</option><option value="chalet">ุดุงูููุงุช</option><option value="office">ููุงุชุจ</option><option value="shop">ูุญูุงุช</option><option value="land">ุฃุฑุงุถู</option><option value="building">ุนูุงูุฑ</option><option value="warehouse">ูุฎุงุฒู</option></select><i data-lucide="chevron-down" class="custom-select-icon w-3 h-3"></i></div>
                        <div class="custom-select-wrapper"><select id="filter-type" class="custom-select py-1 text-[10px]"><option value="">ูู ุงูุฃููุงุน (ุจูุน/ุฅูุฌุงุฑ)</option><option value="sale">ุจูุน</option><option value="rent">ุฅูุฌุงุฑ</option></select><i data-lucide="chevron-down" class="custom-select-icon w-3 h-3"></i></div>
                        <div class="grid grid-cols-2 gap-1.5"><div class="custom-select-wrapper"><select id="filter-gov" onchange="populateCities('filter-gov', 'filter-city')" class="custom-select py-1 text-[10px]"><option value="">ูู ุงููุญุงูุธุงุช</option></select><i data-lucide="chevron-down" class="custom-select-icon w-3 h-3"></i></div><div class="custom-select-wrapper"><select id="filter-city" class="custom-select py-1 text-[10px]"><option value="">ูู ุงููุฑุงูุฒ</option></select><i data-lucide="chevron-down" class="custom-select-icon w-3 h-3"></i></div></div>
                        <div class="grid grid-cols-2 gap-1.5"><input type="number" id="filter-min-price" placeholder="ุฃูู ุณุนุฑ" class="input-box text-[10px] py-1"><input type="number" id="filter-max-price" placeholder="ุฃุนูู ุณุนุฑ" class="input-box text-[10px] py-1"></div>
                        <div class="flex gap-2"><button onclick="performSearch(); toggleFilterPanel()" class="flex-1 bg-emerald-600 text-white py-1.5 rounded font-bold text-[10px] shadow hover:bg-emerald-700 transition">ุชุทุจูู</button><button onclick="toggleFilterPanel()" class="w-16 bg-red-500 text-white py-1.5 rounded font-bold text-[10px] shadow hover:bg-red-600 transition flex items-center justify-center"><i data-lucide="x" class="w-4 h-4"></i> ุฅุบูุงู</button></div>
                    </div>
                </div>
            </div>

            <div id="grid-container" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 mt-4"></div>
            <div id="load-more-container" class="hidden mt-4 text-center"><button onclick="loadMore()" class="bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-200 px-6 py-2 rounded-full text-xs font-bold shadow-sm hover:bg-slate-50 dark:hover:bg-slate-700 transition">ุนุฑุถ ุงููุฒูุฏ</button></div>
            <div id="empty-state" class="hidden text-center py-16 opacity-60 flex flex-col items-center"><div class="bg-slate-200 dark:bg-slate-700 p-3 rounded-full inline-block mb-2"><i data-lucide="search-x" class="w-6 h-6 text-slate-400"></i></div><p class="text-slate-500 dark:text-slate-400 font-bold text-xs">ูุง ุชูุฌุฏ ูุชุงุฆุฌ</p><button onclick="resetFilters()" class="mt-1 text-emerald-600 dark:text-emerald-400 text-[10px] font-bold underline">ุนุฑุถ ุงููู</button></div>
        </main>

        <!-- Floating Dock -->
        <nav id="bottom-nav" class="fixed bottom-4 left-1/2 -translate-x-1/2 bg-white/90 dark:bg-slate-800/90 backdrop-blur-none border border-slate-200 dark:border-slate-600 px-5 py-2 rounded-full flex items-center gap-6 shadow-xl transform transition-all hover:scale-105 transform-gpu">
            <button onclick="resetFilters(); window.scrollTo({top:0, behavior:'smooth'})" class="flex items-center justify-center text-slate-500 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white transition group"><i data-lucide="home" class="w-5 h-5 group-hover:scale-110 transition"></i></button>
            <button onclick="toggleAddModal()" class="w-10 h-10 bg-slate-900 text-white rounded-full flex items-center justify-center shadow-lg shadow-slate-900/20 transform -translate-y-4 border-2 border-emerald-600 dark:border-emerald-500 hover:scale-110 transition active:scale-90"><i data-lucide="plus" class="w-5 h-5"></i></button>
            <button onclick="toggleChat()" class="flex items-center justify-center text-slate-500 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white transition group relative"><div id="chat-badge" class="hidden absolute top-0 right-0 w-2 h-2 bg-red-500 rounded-full border border-white dark:border-slate-800"></div><i data-lucide="message-circle" class="w-5 h-5 group-hover:scale-110 transition"></i></button>
        </nav>

    <!-- Auth Modal -->
    <div id="auth-modal" class="hidden modal-overlay">
        <div class="relative w-full max-w-sm bg-white dark:bg-slate-800 rounded-2xl shadow-2xl border border-slate-200 dark:border-slate-700 p-6 overflow-hidden animate-pop z-50">
            <button onclick="toggleModal('auth-modal')" class="absolute top-3 left-3 text-slate-400 hover:text-red-500 transition z-10"><i data-lucide="x" class="w-5 h-5"></i></button>
            <div class="flex justify-center mb-6">
                <div class="w-16 h-16 bg-slate-50 dark:bg-slate-700 rounded-full flex items-center justify-center border-2 border-emerald-500 shadow-lg">
                    <i data-lucide="building-2" class="w-8 h-8 text-emerald-600 dark:text-emerald-400"></i>
                </div>
            </div>
            <div class="flex justify-center mb-6">
                <div class="bg-slate-100 dark:bg-slate-900 p-1 rounded-xl flex w-full">
                    <button onclick="switchAuthMode('login')" id="tab-login" class="flex-1 py-2 rounded-lg text-xs font-bold transition bg-white dark:bg-slate-700 shadow text-emerald-600 dark:text-white">ุฏุฎูู</button>
                    <button onclick="switchAuthMode('register')" id="tab-register" class="flex-1 py-2 rounded-lg text-xs font-bold transition text-slate-500 dark:text-slate-400">ุฅูุดุงุก ุญุณุงุจ</button>
                </div>
            </div>
            <div id="form-login" class="space-y-4">
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-500">ุฑูู ุงููุงุชู</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 font-bold text-xs bg-slate-100 dark:bg-slate-700 px-1.5 rounded">+20</span>
                        <input id="login-phone" type="tel" class="input-box pl-12 text-left" placeholder="1xxxxxxxxx" oninput="formatPhone(this)">
                    </div>
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-500">ูููุฉ ุงููุฑูุฑ</label>
                    <input id="login-pass" type="password" class="input-box" placeholder="โขโขโขโขโขโขโขโข">
                </div>
                <button onclick="loginUser()" class="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold text-sm shadow-lg hover:bg-emerald-700 transition transform active:scale-95">ุชุณุฌูู ุงูุฏุฎูู</button>
            </div>
            <div id="form-register" class="hidden space-y-4">
                <div class="flex justify-center">
                    <label class="relative w-20 h-20 rounded-full border-2 border-dashed border-emerald-500 flex items-center justify-center cursor-pointer overflow-hidden bg-slate-50 dark:bg-slate-900 group hover:bg-emerald-50 transition">
                        <input type="file" accept="image/*" class="hidden" onchange="previewProfileImage(this)">
                        <img id="reg-img-preview" class="absolute inset-0 w-full h-full object-cover hidden">
                        <div id="reg-img-placeholder" class="flex flex-col items-center text-emerald-500">
                            <i data-lucide="camera" class="w-6 h-6 mb-1"></i>
                            <span class="text-[8px] font-bold">ุตูุฑุฉ</span>
                        </div>
                    </label>
                </div>
                <div class="space-y-1"><input id="reg-name" type="text" class="input-box text-center" placeholder="ุงูุงุณู ุจุงููุงูู"></div>
                <div class="relative">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 font-bold text-xs bg-slate-100 dark:bg-slate-700 px-1.5 rounded">+20</span>
                    <input id="reg-phone" type="tel" class="input-box pl-12 text-left" placeholder="ุฑูู ุงููุงุชู" oninput="formatPhone(this)">
                </div>
                <input id="reg-pass" type="password" class="input-box" placeholder="ูููุฉ ุงููุฑูุฑ">
                <button onclick="registerUser()" id="btn-register" class="w-full bg-slate-900 dark:bg-emerald-600 text-white py-3 rounded-xl font-bold text-sm shadow-lg hover:opacity-90 transition transform active:scale-95">ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ</button>
            </div>
        </div>
    </div>

    <!-- Publisher Profile Modal -->
    <div id="publisher-modal" class="hidden modal-overlay">
        <div class="relative w-full max-w-sm bg-white dark:bg-slate-800 rounded-2xl shadow-2xl border border-slate-200 dark:border-slate-700 p-6 overflow-hidden animate-pop text-center z-50">
            <button onclick="toggleModal('publisher-modal')" class="absolute top-3 left-3 text-slate-400 hover:text-red-500 transition z-10"><i data-lucide="x" class="w-5 h-5"></i></button>
            <div class="w-24 h-24 rounded-full border-4 border-emerald-500 p-1 mx-auto mb-4">
                <img id="pub-img" src="" class="w-full h-full rounded-full object-cover bg-slate-200">
            </div>
            <h2 id="pub-name" class="text-xl font-black text-slate-800 dark:text-white mb-1"></h2>
            <p id="pub-phone" class="text-sm font-bold text-slate-500 dark:text-slate-400 mb-6" dir="ltr"></p>
            <div class="bg-emerald-50 dark:bg-emerald-900/20 p-4 rounded-xl border border-emerald-100 dark:border-emerald-800">
                <p class="text-emerald-800 dark:text-emerald-200 font-bold text-xs">ูุงุดุฑ ููุซูู ูู ุงูุณูู ููุงู โ</p>
            </div>
        </div>
    </div>

    <!-- Details Modal -->
    <div id="details-modal" class="hidden modal-overlay">
        <div class="mobile-full-modal animate-pop">
            <div class="relative h-44 bg-gray-200 dark:bg-slate-800 shrink-0 group">
                <button onclick="closeDetails()" class="absolute top-2 left-2 bg-red-500 text-black p-2 rounded-full z-20 shadow-sm hover:bg-red-600 transition"><i data-lucide="x" class="w-5 h-5"></i></button>
                <div class="absolute top-2 right-2 flex gap-2 z-20">
                    <button onclick="downloadImages()" class="bg-white/80 dark:bg-black/50 text-slate-800 dark:text-white p-1 rounded-full shadow-sm"><i data-lucide="download" class="w-4 h-4"></i></button>
                    <button onclick="shareListing()" class="bg-white/80 dark:bg-black/50 text-slate-800 dark:text-white p-1 rounded-full shadow-sm"><i data-lucide="share-2" class="w-4 h-4"></i></button>
                </div>
                <div id="details-slider" class="flex w-full h-full overflow-x-auto no-scrollbar snap-x scroll-smooth"></div>
                <div id="details-arrows">
                    <button onclick="scrollDetails(-1)" class="absolute right-2 top-1/2 -translate-y-1/2 bg-black/40 text-white p-2 rounded-full z-10"><i data-lucide="chevron-right" class="w-6 h-6"></i></button>
                    <button onclick="scrollDetails(1)" class="absolute left-2 top-1/2 -translate-y-1/2 bg-black/40 text-white p-2 rounded-full z-10"><i data-lucide="chevron-left" class="w-6 h-6"></i></button>
                </div>
                <span id="d-type-badge" class="absolute bottom-2 right-2 text-white px-2 py-0.5 rounded text-[10px] font-bold shadow backdrop-blur-sm"></span>
            </div>
            
            <div class="flex-1 overflow-y-auto bg-white dark:bg-darkbg">
                <div id="publisher-bar" class="flex items-center gap-2 p-2 bg-slate-50 dark:bg-slate-800/50 border-b border-slate-100 dark:border-slate-700 cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-800 transition" onclick="openPublisherProfile()">
                    <div id="d-pub-img-container" class="w-8 h-8 rounded-full border border-slate-300 overflow-hidden bg-slate-200">
                        <img id="d-pub-img" src="" class="w-full h-full object-cover hidden">
                    </div>
                    <div class="flex-1">
                        <h4 id="d-pub-name" class="text-[10px] font-bold text-slate-800 dark:text-white leading-tight"></h4>
                        <span class="text-[8px] text-emerald-600 dark:text-emerald-400 font-bold">ุนุฑุถ ุงูุจุฑููุงูู</span>
                    </div>
                    <i data-lucide="chevron-left" class="w-4 h-4 text-slate-400"></i>
                </div>

                <div id="d-controls" class="hidden p-2 bg-slate-50 dark:bg-slate-800 border-b dark:border-slate-700 flex gap-2 justify-end items-center"></div>
                <div class="p-2 space-y-2">
                    <div class="space-y-1">
                        <div><span class="text-[9px] font-bold text-slate-400 block mb-0">ุงูุนููุงู ุงูุนูุงุฑู</span><h2 id="d-title" class="text-sm font-bold text-slate-900 dark:text-white leading-tight"></h2></div>
                        <div class="flex items-center justify-between border-b border-slate-100 dark:border-slate-700 pb-1">
                            <div><span class="text-[9px] font-bold text-slate-400 block mb-0">ุงูุณุนุฑ ุงููุทููุจ</span><span id="d-price" class="text-emerald-600 dark:text-emerald-400 font-black text-lg"></span></div>
                            <span id="d-time-badge" class="text-[9px] text-slate-400 font-medium bg-slate-100 dark:bg-slate-800 px-2 py-0.5 rounded-full"></span>
                        </div>
                    </div>
                    <div class="border border-slate-200 dark:border-slate-700 rounded-lg overflow-hidden">
                        <table class="w-full text-[10px] modern-table"><tbody id="d-table-body"></tbody></table>
                    </div>
                    <div>
                        <h3 class="text-[10px] font-bold text-slate-900 dark:text-white mb-1 flex items-center gap-1"><i data-lucide="sparkles" class="w-3 h-3 text-yellow-500"></i> ุงููููุฒุงุช</h3>
                        <div id="d-amenities" class="grid grid-cols-3 gap-0 border border-slate-200 dark:border-slate-700 rounded-lg overflow-hidden bg-slate-50 dark:bg-slate-800/50"></div>
                    </div>
                    <div class="bg-slate-50 dark:bg-slate-800/50 p-2 rounded-lg border border-slate-200 dark:border-slate-700"><h3 class="text-[9px] font-bold text-slate-400 uppercase mb-0.5">ุงูุชูุงุตูู ุงููุงููุฉ</h3><p id="d-desc" class="text-[10px] text-slate-700 dark:text-slate-300 leading-snug whitespace-pre-wrap font-medium"></p></div>
                </div>
            </div>
            <div class="p-2 border-t border-slate-100 dark:border-slate-700 bg-white dark:bg-darkbg flex flex-col gap-2 shrink-0 pb-6 md:pb-2">
                <a id="d-map" href="#" target="_blank" class="hidden w-full bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 py-2 rounded-lg flex justify-center items-center gap-2 font-bold text-[10px] border border-blue-100 dark:border-blue-800 hover:bg-blue-100 transition"><i data-lucide="map" class="w-3 h-3"></i> ุงููููุน ุนูู ุงูุฎุฑูุทุฉ</a>
                <div class="flex gap-2"><a id="d-wa" href="#" target="_blank" class="flex-1 bg-[#25D366] text-white py-2.5 rounded-lg flex justify-center items-center gap-2 font-bold shadow-lg hover:opacity-90 transition text-[10px]"><i data-lucide="message-circle" class="w-4 h-4"></i> ูุงุชุณุงุจ</a><a id="d-call" href="#" class="flex-1 bg-slate-900 dark:bg-slate-700 text-white py-2.5 rounded-lg flex justify-center items-center gap-2 font-bold shadow-lg hover:opacity-90 transition text-[10px]"><i data-lucide="phone" class="w-4 h-4"></i> ุงุชุตุงู</a></div>
            </div>
        </div>
    </div>

    <!-- Add Modal -->
    <div id="add-modal" class="hidden modal-overlay">
        <div class="mobile-full-modal animate-pop">
            <div class="p-2.5 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-white dark:bg-darkbg shrink-0">
                <h3 class="font-bold text-slate-800 dark:text-white text-sm">ุฅุถุงูุฉ ุนูุงุฑ</h3>
                <button onclick="toggleAddModal()" class="bg-red-500 text-black p-2 rounded-full hover:bg-red-600 transition"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-2.5 bg-slate-50 dark:bg-darkbg">
                <div class="space-y-2.5">
                    <div class="bg-white dark:bg-slate-800 p-2.5 rounded-lg border border-black dark:border-slate-500 shadow-sm">
                        <label class="block text-[10px] font-bold text-slate-700 dark:text-slate-300 mb-1.5">ุตูุฑ ูููุฏูููุงุช ุงูุนูุงุฑ (ุจุญุฏ ุฃูุตู 10) <span class="text-red-500">*</span></label>
                        <div class="grid grid-cols-4 gap-1.5">
                            <label class="aspect-square border-2 border-dashed border-emerald-300 dark:border-emerald-700 bg-emerald-50 dark:bg-emerald-900/20 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:bg-emerald-100 transition text-emerald-600 dark:text-emerald-400 relative overflow-hidden">
                                <input type="file" multiple accept="image/*,video/*" onchange="handleUpload(this)" class="absolute inset-0 opacity-0 z-10"><i data-lucide="camera" class="w-4 h-4 mb-0.5"></i><span class="text-[8px] font-bold">ุฅุถุงูุฉ</span>
                            </label>
                            <div id="preview-area" class="col-span-3 flex gap-1.5 overflow-x-auto no-scrollbar py-0.5"></div>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-2.5 rounded-lg border border-black dark:border-slate-500 shadow-sm space-y-1.5">
                        <h4 class="text-[9px] font-bold text-slate-400 uppercase tracking-wider border-b border-slate-100 dark:border-slate-700 pb-0.5 mb-0.5">ุจูุงูุงุช ุฃุณุงุณูุฉ</h4>
                        <div class="flex gap-1.5"><div class="custom-select-wrapper flex-1"><select id="in-category" onchange="updateFormFields()" class="custom-select"><option value="apartment">ุดูุฉ</option><option value="villa">ูููุง</option><option value="chalet">ุดุงููุฉ</option><option value="office">ููุชุจ</option><option value="shop">ูุญู</option><option value="land">ุฃุฑุถ</option><option value="building">ุนูุงุฑุฉ</option><option value="warehouse">ูุฎุฒู</option></select><i data-lucide="chevron-down" class="custom-select-icon w-3 h-3"></i></div><div class="custom-select-wrapper w-20 shrink-0"><select id="in-type" class="custom-select"><option value="sale">ุจูุน</option><option value="rent">ุฅูุฌุงุฑ</option></select><i data-lucide="chevron-down" class="custom-select-icon w-3 h-3"></i></div></div>
                        <input id="in-title" class="input-box" placeholder="ุนููุงู ุงูุฅุนูุงู"><input id="in-price" type="number" class="input-box" placeholder="ุงูุณุนุฑ (ุฌููู)">
                        <div class="grid grid-cols-2 gap-1.5"><input id="in-area" type="number" class="input-box" placeholder="ุงููุณุงุญุฉ (ูยฒ)"><input id="in-level" type="text" class="input-box" placeholder="ุงูุฏูุฑ"><input id="in-floors-alt" type="number" class="input-box hidden" placeholder="ุนุฏุฏ ุงูุฃุฏูุงุฑ"><div id="land-type-wrapper" class="hidden custom-select-wrapper"><select id="in-land-type" class="custom-select"><option value="building">ูุจุงูู</option><option value="agriculture">ุฒุฑุงุนูุฉ</option></select><i data-lucide="chevron-down" class="custom-select-icon w-3 h-3"></i></div></div>
                        <div id="land-fields" class="hidden grid grid-cols-2 gap-1.5"><input id="in-feddan" type="number" class="input-box" placeholder="ูุฏุงู (ุงุฎุชูุงุฑู)"><input id="in-qirat" type="number" class="input-box" placeholder="ููุฑุงุท (ุงุฎุชูุงุฑู)"></div>
                        <div id="building-fields" class="hidden grid grid-cols-2 gap-1.5"><input id="in-apartments" type="number" class="input-box" placeholder="ุนุฏุฏ ุงูุดูู"></div>
                        <div id="room-fields" class="grid grid-cols-2 gap-1.5"><input id="in-rooms" type="number" class="input-box" placeholder="ุนุฏุฏ ุงูุบุฑู"><input id="in-baths" type="number" class="input-box" placeholder="ุนุฏุฏ ุงูุญูุงูุงุช"></div>
                        <div id="extra-fields" class="grid grid-cols-2 gap-1.5"><input id="in-balconies" type="number" class="input-box" placeholder="ุนุฏุฏ ุงูุจููููุงุช"><div class="custom-select-wrapper"><select id="in-finishing" class="custom-select"><option value="" disabled selected>ููุน ุงูุชุดุทูุจ</option><option value="red">ุทูุจ ุฃุญูุฑ</option><option value="semi">ูุตู ุชุดุทูุจ</option><option value="full">ุชุดุทูุจ ูุงูู</option><option value="super">ุณูุจุฑ ูููุณ</option><option value="ultra">ุงูุชุฑุง ุณูุจุฑ ูููุณ</option></select><i data-lucide="chevron-down" class="custom-select-icon w-3 h-3"></i></div></div>
                        <div id="furnished-field" class="flex items-center justify-between bg-slate-50 dark:bg-slate-700/50 p-1.5 rounded-lg border border-black dark:border-slate-500"><span class="text-[10px] font-bold text-slate-600 dark:text-slate-300">ููุฑูุดุ</span><div class="flex gap-1.5"><label class="cursor-pointer"><input type="radio" name="furnished" value="yes" class="peer hidden"><span class="px-2 py-0.5 rounded text-[9px] font-bold bg-white dark:bg-slate-600 border border-slate-200 dark:border-slate-500 text-slate-500 peer-checked:bg-emerald-500 peer-checked:text-white peer-checked:border-emerald-500 transition">ูุนู</span></label><label class="cursor-pointer"><input type="radio" name="furnished" value="no" checked class="peer hidden"><span class="px-2 py-0.5 rounded text-[9px] font-bold bg-white dark:bg-slate-600 border border-slate-200 dark:border-slate-500 text-slate-500 peer-checked:bg-slate-800 peer-checked:text-white peer-checked:border-slate-800 transition">ูุง</span></label></div></div>
                        <div class="flex gap-2 items-center pt-0.5"><span class="text-[10px] font-bold text-slate-600 dark:text-slate-400">ุดุงุฑุฉ:</span><div class="flex gap-1.5"><label class="cursor-pointer amenity-tile"><input type="radio" name="badge" value="none" checked class="hidden"><div class="px-2 py-0.5 rounded border border-slate-200 dark:border-slate-600 text-[9px] font-bold text-slate-600 dark:text-slate-300 transition">ุนุงุฏู</div></label><label class="cursor-pointer amenity-tile"><input type="radio" name="badge" value="hot" class="hidden"><div class="px-2 py-0.5 rounded border border-orange-200 text-[9px] font-bold text-orange-600 transition hover:bg-orange-50">๐ฅ ููุทุฉ</div></label></div></div>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-2.5 rounded-lg border border-black dark:border-slate-500 shadow-sm space-y-1.5"><h4 class="text-[9px] font-bold text-slate-400 uppercase tracking-wider border-b border-slate-100 dark:border-slate-700 pb-0.5 mb-0.5">ุงููููุฒุงุช</h4><div class="grid grid-cols-4 gap-1" id="amenities-grid"></div><textarea id="in-desc" rows="2" class="input-box resize-none" placeholder="ูุตู ุชูุตููู..."></textarea></div>
                    <div class="bg-white dark:bg-slate-800 p-2.5 rounded-lg border border-black dark:border-slate-500 shadow-sm space-y-1.5"><h4 class="text-[9px] font-bold text-slate-400 uppercase tracking-wider border-b border-slate-100 dark:border-slate-700 pb-0.5 mb-0.5">ุงููููุน ูุงูุชูุงุตู</h4><input id="in-address" class="input-box mb-1.5" placeholder="ุงูุนููุงู ุจุงูุชูุตูู (ุงุณู ุงูุดุงุฑุนุ ุนูุงูุฉ ูููุฒุฉ)..."><div class="grid grid-cols-2 gap-1.5"><div class="custom-select-wrapper"><select id="in-gov" onchange="populateCities('in-gov', 'in-city')" class="custom-select"><option value="" disabled selected>ุงููุญุงูุธุฉ</option></select><i data-lucide="chevron-down" class="custom-select-icon w-3 h-3"></i></div><div class="custom-select-wrapper"><select id="in-city" class="custom-select"><option value="" disabled selected>ุงููุฑูุฒ/ุงููุฏููุฉ</option></select><i data-lucide="chevron-down" class="custom-select-icon w-3 h-3"></i></div></div><input id="in-map" class="input-box" placeholder="ุฑุงุจุท ุฌูุฌู ูุงุจ (ุงุฎุชูุงุฑู)"><input id="in-phone" type="tel" class="input-box" placeholder="ุฑูู ุงููุงุชู"></div>
                </div>
            </div>
            <div class="p-2.5 border-t border-slate-100 dark:border-slate-700 bg-white dark:bg-darkbg shrink-0 pb-6 md:pb-3">
                <button onclick="submitListing()" id="btn-publish" class="w-full bg-slate-900 dark:bg-emerald-600 text-white py-2.5 rounded-lg font-bold text-xs shadow-lg hover:opacity-90 transition transform active:scale-95">ูุดุฑ ุงูุฅุนูุงู</button>
            </div>
        </div>
    </div>

    <!-- Chat & Lightbox & Admin -->
    <div id="chat-modal" class="hidden modal-overlay"><div class="mobile-full-modal animate-pop border border-navy/10"><div class="bg-slate-900 dark:bg-emerald-600 p-3 text-white flex justify-between items-center shrink-0"><div class="flex items-center gap-2"><div class="bg-white/10 p-1.5 rounded-full"><i data-lucide="bot" class="w-5 h-5 text-yellow-400"></i></div><div><h4 class="font-bold text-xs">ุงูุฏุนู ุงูููู</h4><span class="text-[9px] opacity-80">ูุชุตู ุงูุขู</span></div></div><button onclick="toggleChat()" class="bg-red-500 text-black p-1 rounded-full hover:bg-red-600 transition"><i data-lucide="x" class="w-4 h-4"></i></button></div><div id="chat-box" class="flex-1 bg-slate-100 dark:bg-slate-900 p-3 overflow-y-auto space-y-2 text-xs"></div><div class="p-3 bg-white dark:bg-slate-800 border-t dark:border-slate-700 flex items-center gap-2 shrink-0 pb-safe"><input id="chat-msg" type="text" class="flex-1 bg-slate-100 dark:bg-slate-700 border-0 rounded-full px-4 py-3 text-sm outline-none dark:text-white font-bold" placeholder="ุงูุชุจ ุฑุณุงูุชู..."><button onclick="sendMsg()" class="w-10 h-10 bg-slate-900 dark:bg-emerald-600 rounded-full text-white flex items-center justify-center shadow"><i data-lucide="send" class="w-4 h-4"></i></button></div></div></div>
    
    <!-- Lightbox -->
    <div id="lightbox" class="hidden fixed inset-0 bg-black/95 z-[120] flex flex-col items-center justify-center select-none">
        <button onclick="closeLightbox()" class="absolute top-4 left-4 bg-white/20 text-white p-2 rounded-full z-20"><i data-lucide="x" class="w-6 h-6"></i></button>
        <button onclick="changeLightboxImage(-1)" class="absolute right-2 top-1/2 -translate-y-1/2 bg-white/10 text-white p-3 rounded-full z-20 hover:bg-white/20"><i data-lucide="chevron-right" class="w-6 h-6"></i></button>
        <button onclick="changeLightboxImage(1)" class="absolute left-2 top-1/2 -translate-y-1/2 bg-white/10 text-white p-3 rounded-full z-20 hover:bg-white/20"><i data-lucide="chevron-left" class="w-6 h-6"></i></button>
        <div class="relative w-full h-full flex items-center justify-center">
            <img id="lightbox-img" src="" class="max-w-full max-h-[80vh] object-contain transition-opacity duration-200">
        </div>
    </div>

    <div id="admin-panel" class="hidden fixed inset-0 bg-navy z-[90] flex flex-col text-white"><div class="p-3 border-b border-white/10 flex justify-between items-center bg-[#001a38]"><h2 class="font-bold flex items-center gap-2 text-sm"><i data-lucide="shield" class="w-4 h-4 text-emerald-400"></i> ุงูุชุญูู</h2><div class="flex gap-3"><button onclick="refreshAdmin()"><i data-lucide="refresh-cw" class="w-4 h-4"></i></button><button onclick="toggleAdminPanel()"><i data-lucide="x" class="w-5 h-5"></i></button></div></div><div class="flex-1 flex overflow-hidden"><div class="w-1/3 border-l border-white/10 bg-[#001f3f] overflow-y-auto p-2" id="admin-users-list"></div><div class="w-2/3 flex flex-col bg-navy relative"><div id="admin-chat-header" class="h-12 border-b border-white/10 flex items-center justify-between px-3 bg-[#001a38]"><span class="text-xs font-bold">ุงุฎุชุฑ ูุญุงุฏุซุฉ</span><button onclick="kickUser()" id="btn-end-chat" class="hidden bg-red-600 text-white text-[10px] font-bold px-2 py-1 rounded flex items-center gap-1"><i data-lucide="slash" class="w-3 h-3"></i> ุฅููุงุก</button></div><div id="admin-msg-area" class="flex-1 p-3 overflow-y-auto space-y-2 text-xs"></div><div class="p-2 border-t border-white/10 flex gap-2 bg-[#001a38]"><input id="admin-input" class="flex-1 bg-white/5 border border-white/20 rounded px-3 py-1.5 text-xs text-white outline-none" placeholder="ุงูุฑุฏ..."><button onclick="sendAdminMsg()" class="bg-blue-600 px-4 py-1.5 rounded text-xs font-bold">ุฅุฑุณุงู</button></div></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInAnonymously, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyC7zHuH8LK-yQAKG-Nm7dh31fXtVLxuCLM", authDomain: "sharqia-81030.firebaseapp.com", projectId: "sharqia-81030", storageBucket: "sharqia-81030.firebasestorage.app", messagingSenderId: "581888625195", appId: "1:581888625195:web:1667ba1e439e8e6c1fb86e" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app); const auth = getAuth(app);

        const COLLECTION_NAME = "listings_v2"; 
        const DUMMY_PUBLISHER = { displayName: "ูุณูุท ุงูุณูู", phoneNumber: "01206244875", photoURL: "https://cdn-icons-png.flaticon.com/512/609/609803.png" };

        let state = { user: null, userProfile: null, listings: [], filesToUpload: [], regImage: null, chatId: null, chatStep: 0, tempName: '', activeAdminChat: null, isAdmin: false, welcomeSent: false, currentFilter: 'all', visibleLimit: 6, lightboxIndex: 0, activeDetailsId: null, currentDetailIndex: 0, publisherCache: {} };

        const ALL_AMENITIES = ["ุบุงุฒ ุทุจูุนู", "ููุฑุจุงุก", "ููุงู", "ุฃุณุงูุณูุฑ", "ูุงู ูุงู", "ุญูุงู ุณุจุงุญุฉ", "ุญุฏููุฉ", "ุฌุฑุงุฌ", "ุฃูู ูุญุฑุงุณุฉ", "ูุงููุฑุงุช ูุฑุงูุจุฉ", "ูุทุจุฎ ุฃูุฑููุงูู", "ุบุฑูุฉ ุฎุงุฏูุฉ", "ูุณููุญ ุจุงูุญููุงูุงุช", "ุนูู ูุงุตูุฉ"];
        const LAND_AMENITIES = ["ููุฑุจุงุก", "ููุงู", "ุบุงุฒ ุทุจูุนู", "ุนูู ูุงุตูุฉ"];
        const CAT_MAP = { 'apartment': 'ุดูุฉ', 'villa': 'ูููุง', 'chalet': 'ุดุงููุฉ', 'office': 'ููุชุจ', 'shop': 'ูุญู', 'land': 'ุฃุฑุถ', 'building': 'ุนูุงุฑุฉ', 'warehouse': 'ูุฎุฒู' };
        const FINISH_MAP = { 'red': 'ุทูุจ ุฃุญูุฑ', 'semi': 'ูุตู ุชุดุทูุจ', 'full': 'ุชุดุทูุจ ูุงูู', 'super': 'ุณูุจุฑ ูููุณ', 'ultra': 'ุงูุชุฑุง ุณูุจุฑ ูููุณ' };
        const CAT_KEYWORDS = { 'ุดูุฉ': 'apartment', 'ุดูู': 'apartment', 'ูููุง': 'villa', 'ููู': 'villa', 'ุดุงููุฉ': 'chalet', 'ุดุงูููุงุช': 'chalet', 'ููุชุจ': 'office', 'ููุงุชุจ': 'office', 'ูุญู': 'shop', 'ูุญูุงุช': 'shop', 'ุงุฑุถ': 'land', 'ุงุฑุงุถู': 'land', 'ุนูุงุฑุฉ': 'building', 'ุนูุงูุฑ': 'building', 'ูุฎุฒู': 'warehouse', 'ูุฎุงุฒู': 'warehouse' };
        const EGYPT_LOCATIONS = { "ุงูุดุฑููุฉ": ["ุงูุฒูุงุฒูู", "ุงูุนุงุดุฑ ูู ุฑูุถุงู", "ูููุง ุงูููุญ", "ุจูุจูุณ", "ูุดุชูู ุงูุณูู", "ุงูููุงูุงุช", "ุฃุจู ุญูุงุฏ", "ุงููุฑูู", "ูููุง", "ุฃุจู ูุจูุฑ", "ูุงููุณ", "ุงูุตุงูุญูุฉ ุงูุฌุฏูุฏุฉ", "ุงูุฅุจุฑุงููููุฉ", "ุฏูุฑุจ ูุฌู", "ููุฑ ุตูุฑ", "ุฃููุงุฏ ุตูุฑ", "ุงูุญุณูููุฉ", "ุตุงู ุงูุญุฌุฑ", "ููุดุฃุฉ ุฃุจู ุนูุฑ"], "ุงููุงูุฑุฉ": ["ูุฏููุฉ ูุตุฑ", "ูุตุฑ ุงูุฌุฏูุฏุฉ", "ุงููุนุงุฏู", "ุงูุชุฌูุน ุงูุฎุงูุณ", "ุงูุฑุญุงุจ", "ูุฏููุชู", "ุงูุดุฑูู", "ุงูุนุจูุฑ", "ุงูููุทู", "ุงูุฒูุชูู", "ุญุฏุงุฆู ุงููุจุฉ", "ุดุจุฑุง", "ูุณุท ุงูุจูุฏ", "ุงููููู", "ุงูุฒูุงูู", "ุงููููุฏุณูู", "ุงูุฏูู", "ุงูุนุฌูุฒุฉ"], "ุงูุฌูุฒุฉ": ["6 ุฃูุชูุจุฑ", "ุงูุดูุฎ ุฒุงูุฏ", "ุงููุฑู", "ููุตู", "ุงููููุฏุณูู", "ุงูุฏูู", "ุงูุนุฌูุฒุฉ", "ุฅูุจุงุจุฉ", "ุงููุฑุงู", "ุจููุงู ุงูุฏูุฑูุฑ", "ุงูุนูุฑุงููุฉ", "ุงููููุจ"], "ุงูุฅุณููุฏุฑูุฉ": ["ุณููุญุฉ", "ููุงูู", "ุงูููุชุฒู", "ุณูุฏู ุจุดุฑ", "ุฌููู", "ุณุชุงููู", "ุฑุดุฏู", "ููุฑ ุนุจุฏู", "ูุญุฑู ุจู", "ุงูุนุฌูู", "ุงูุณุงุญู ุงูุดูุงูู", "ุจุฑุฌ ุงูุนุฑุจ"], "ุงูุฏููููุฉ": ["ุงูููุตูุฑุฉ", "ุทูุฎุง", "ููุช ุบูุฑ", "ุฏูุฑูุณ", "ุฃุฌุง", "ูููุฉ ุงููุตุฑ", "ุงูุณูุจูุงููู", "ุดุฑุจูู", "ุจููุงุณ", "ุงููุทุฑูุฉ", "ุงูููุฒูุฉ", "ุฌูุตุฉ"], "ุงูููููุจูุฉ": ["ุจููุง", "ููููุจ", "ุดุจุฑุง ุงูุฎููุฉ", "ุงูููุงุทุฑ ุงูุฎูุฑูุฉ", "ุงูุฎุงููุฉ", "ููุฑ ุดูุฑ", "ุทูุฎ", "ููุง", "ุงูุนุจูุฑ"], "ุงููููููุฉ": ["ุดุจูู ุงูููู", "ูุฏููุฉ ุงูุณุงุฏุงุช", "ูููู", "ุณุฑุณ ุงูููุงู", "ุฃุดููู", "ุงูุจุงุฌูุฑ", "ูููุณูุง", "ุจุฑูุฉ ุงูุณุจุน", "ุชูุง", "ุงูุดูุฏุงุก"], "ุงูุบุฑุจูุฉ": ["ุทูุทุง", "ุงููุญูุฉ ุงููุจุฑู", "ููุฑ ุงูุฒูุงุช", "ุฒูุชู", "ุงูุณูุทุฉ", "ูุทูุฑ", "ุจุณููู", "ุณูููุฏ"], "ุงูุจุญูุฑุฉ": ["ุฏููููุฑ", "ููุฑ ุงูุฏูุงุฑ", "ุฑุดูุฏ", "ุฅุฏูู", "ุฃุจู ุงููุทุงููุฑ", "ุฃุจู ุญูุต", "ุงูุฏููุฌุงุช", "ุงููุญููุฏูุฉ", "ุงูุฑุญูุงููุฉ", "ุฅูุชุงู ุงูุจุงุฑูุฏ", "ุญูุด ุนูุณู", "ุดุจุฑุงุฎูุช", "ููู ุญูุงุฏุฉ", "ุจุฏุฑ", "ูุงุฏู ุงููุทุฑูู", "ุงูููุจุงุฑูุฉ ุงูุฌุฏูุฏุฉ"], "ุฏููุงุท": ["ุฏููุงุท", "ุฏููุงุท ุงูุฌุฏูุฏุฉ", "ุฑุฃุณ ุงูุจุฑ", "ูุงุฑุณููุฑ", "ุงูุฒุฑูุง", "ุงูุณุฑู", "ุงูุฑูุถุฉ", "ููุฑ ุงูุจุทูุฎ", "ุนุฒุจุฉ ุงูุจุฑุฌ", "ููุช ุฃุจู ุบุงูุจ", "ููุฑ ุณุนุฏ"], "ุจูุฑุณุนูุฏ": ["ุจูุฑุณุนูุฏ", "ุจูุฑูุคุงุฏ"], "ุงูุฅุณูุงุนูููุฉ": ["ุงูุฅุณูุงุนูููุฉ", "ุงูุชู ุงููุจูุฑ", "ูุงูุฏ", "ุงูููุทุฑุฉ ุดุฑู", "ุงูููุทุฑุฉ ุบุฑุจ", "ุฃุจู ุตููุฑ", "ุงููุตุงุตูู"], "ุงูุณููุณ": ["ุงูุณููุณ", "ุงูุฃุฑุจุนูู", "ุนุชุงูุฉ", "ุงูุฌูุงูู", "ููุตู"], "ููุฑ ุงูุดูุฎ": ["ููุฑ ุงูุดูุฎ", "ุฏุณูู", "ููู", "ูุทูุจุณ", "ุจูุทูู", "ูุตูู ุจูุทูู", "ุงูุญุงููู", "ุจููุง", "ุงูุฑูุงุถ", "ุณูุฏู ุณุงูู", "ูููู", "ุจุฑุฌ ุงูุจุฑูุณ"], "ุงููููู": ["ุงููููู", "ุงููููู ุงูุฌุฏูุฏุฉ", "ุทุงููุฉ", "ุณููุฑุณ", "ุฅุทุณุง", "ุฅุจุดูุงู", "ููุณู ุงูุตุฏูู"], "ุจูู ุณููู": ["ุจูู ุณููู", "ุจูู ุณููู ุงูุฌุฏูุฏุฉ", "ุงููุงุณุทู", "ูุงุตุฑ", "ุฅููุงุณูุง", "ุจุจุง", "ุงููุดู", "ุณูุณุทุง"], "ุงููููุง": ["ุงููููุง", "ุงููููุง ุงูุฌุฏูุฏุฉ", "ุงูุนุฏูุฉ", "ูุบุงุบุฉ", "ุจูู ูุฒุงุฑ", "ูุทุงู", "ุณูุงููุท", "ุฃุจู ูุฑูุงุต", "ูููู", "ุฏูุฑ ููุงุณ"], "ุฃุณููุท": ["ุฃุณููุท", "ุฃุณููุท ุงูุฌุฏูุฏุฉ", "ุฏูุฑูุท", "ุงูููุตูุฉ", "ุฃุจููุจ", "ูููููุท", "ุฃุจู ุชูุฌ", "ุงูุบูุงูู", "ุณุงุญู ุณููู", "ุงูุจุฏุงุฑู", "ุตุฏูุง", "ุงููุชุญ"], "ุณููุงุฌ": ["ุณููุงุฌ", "ุณููุงุฌ ุงูุฌุฏูุฏุฉ", "ุฃุฎููู", "ุฃุฎููู ุงูุฌุฏูุฏุฉ", "ุงูุจูููุง", "ุงููุฑุงุบุฉ", "ุงูููุดุฃุฉ", "ุฏุงุฑ ุงูุณูุงู", "ุฌุฑุฌุง", "ุฌูููุฉ", "ุณุงููุชุฉ", "ุทูุง", "ุทูุทุง"], "ููุง": ["ููุง", "ููุง ุงูุฌุฏูุฏุฉ", "ุฃุจู ุชุดุช", "ูุฌุน ุญูุงุฏู", "ุฏุดูุง", "ุงูููู", "ููุท", "ููุต", "ููุงุฏุฉ", "ูุฑุดูุท"], "ุงูุฃูุตุฑ": ["ุงูุฃูุตุฑ", "ุงูุฃูุตุฑ ุงูุฌุฏูุฏุฉ", "ุฅุณูุง", "ุทูุจุฉ ุงูุฌุฏูุฏุฉ", "ุงูุฒูููุฉ", "ุงูุจูุงุถูุฉ", "ุงููุฑูุฉ", "ุฃุฑููุช", "ุงูุทูุฏ"], "ุฃุณูุงู": ["ุฃุณูุงู", "ุฃุณูุงู ุงูุฌุฏูุฏุฉ", "ุฏุฑุงู", "ููู ุฃูุจู", "ูุตุฑ ุงูููุจุฉ", "ุฅุฏูู"], "ุงูุจุญุฑ ุงูุฃุญูุฑ": ["ุงูุบุฑุฏูุฉ", "ุฑุฃุณ ุบุงุฑุจ", "ุณูุงุฌุง", "ุงููุตูุฑ", "ูุฑุณู ุนูู", "ุงูุดูุงุชูู", "ุญูุงูุจ"], "ุงููุงุฏู ุงูุฌุฏูุฏ": ["ุงูุฎุงุฑุฌุฉ", "ุจุงุฑูุณ", "ููุท", "ุงููุฑุงูุฑุฉ", "ุจูุงุท"], "ูุทุฑูุญ": ["ูุฑุณู ูุทุฑูุญ", "ุงูุญูุงู", "ุงูุนูููู", "ุงูุถุจุนุฉ", "ุงููุฌููุฉ", "ุณูุฏู ุจุฑุงูู", "ุงูุณููู", "ุณููุฉ"], "ุดูุงู ุณููุงุก": ["ุงูุนุฑูุด", "ุจุฆุฑ ุงูุนุจุฏ", "ูุฎู", "ุงูุญุณูุฉ", "ุงูุดูุฎ ุฒููุฏ", "ุฑูุญ"], "ุฌููุจ ุณููุงุก": ["ุงูุทูุฑ", "ุดุฑู ุงูุดูุฎ", "ุฏูุจ", "ูููุจุน", "ุทุงุจุง", "ุณุงูุช ูุงุชุฑูู", "ุฃุจู ุฑุฏูุณ", "ุฃุจู ุฒูููุฉ", "ุฑุฃุณ ุณุฏุฑ"] };

        function loadCachedData() {
            const cached = localStorage.getItem('souq_listings');
            if(cached) {
                try {
                    state.listings = JSON.parse(cached);
                    state.listings.sort((a,b) => (a.isPinned ? -1 : 1));
                    performSearch();
                    document.body.classList.add('app-loaded');
                    document.getElementById('splash-screen').classList.add('hidden-splash');
                } catch(e) { console.log('Cache error', e); }
            }
        }

        // Force Splash Screen Hide (Safety Net)
        setTimeout(() => {
            document.getElementById('splash-screen').classList.add('hidden-splash');
            document.body.classList.add('app-loaded');
        }, 5000);

        function restoreState() {
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');
            const mode = urlParams.get('mode');

            if(mode === 'add') {
                if(state.user && !state.user.isAnonymous) {
                    toggleAddModal();
                } else {
                    const newUrl = new URL(window.location);
                    newUrl.searchParams.delete('mode');
                    window.history.replaceState({}, '', newUrl);
                }
            } else if(id) {
                const checkInterval = setInterval(() => {
                    if(state.listings.length > 0) {
                        const item = state.listings.find(i => i.id === id);
                        if(item) {
                            openDetails(id);
                            clearInterval(checkInterval);
                        } else {
                             clearInterval(checkInterval);
                             const newUrl = new URL(window.location);
                             newUrl.searchParams.delete('id');
                             window.history.replaceState({}, '', newUrl);
                        }
                    }
                }, 100);
                setTimeout(() => clearInterval(checkInterval), 5000);
            }
        }

        loadCachedData();

        // Auth Listener - Handles Guests & Registered Users
        onAuthStateChanged(auth, async (u) => { 
            if(u) { 
                state.user = u;
                if(!u.isAnonymous) {
                    // Registered User
                    const userDoc = await getDoc(doc(db, "users", u.uid));
                    if(userDoc.exists()) {
                        state.userProfile = userDoc.data();
                        updateHeader();
                    }
                } else {
                    // Guest User
                    state.userProfile = null;
                    updateHeader();
                }
                // Load listings for everyone (Guest or Registered)
                loadListings(); 
                checkUserChat(); 
                checkAdminStatus(); 
                renderAmenities(ALL_AMENITIES); 
                initLocations();
                restoreState();
            } else {
                // No User? Sign in Anonymously to allow read access
                signInAnonymously(auth).catch(console.error);
            }
        });

        window.handleProfileClick = () => {
            if(state.user && !state.user.isAnonymous) {
                // Already logged in
            } else {
                toggleModal('auth-modal');
            }
        };

        window.switchAuthMode = (mode) => {
            document.getElementById('form-login').classList.add('hidden');
            document.getElementById('form-register').classList.add('hidden');
            document.getElementById('tab-login').classList.remove('bg-white', 'dark:bg-slate-700', 'shadow', 'text-emerald-600', 'dark:text-white');
            document.getElementById('tab-register').classList.remove('bg-white', 'dark:bg-slate-700', 'shadow', 'text-emerald-600', 'dark:text-white');
            document.getElementById('tab-login').classList.add('text-slate-500', 'dark:text-slate-400');
            document.getElementById('tab-register').classList.add('text-slate-500', 'dark:text-slate-400');

            document.getElementById(`form-${mode}`).classList.remove('hidden');
            const activeTab = document.getElementById(`tab-${mode}`);
            activeTab.classList.add('bg-white', 'dark:bg-slate-700', 'shadow', 'text-emerald-600', 'dark:text-white');
            activeTab.classList.remove('text-slate-500', 'dark:text-slate-400');
        };

        window.formatPhone = (input) => {
            let val = input.value.replace(/\D/g, '');
            if(val.startsWith('0')) val = val.substring(1);
            input.value = val;
        };

        window.previewProfileImage = async (input) => {
            if(input.files && input.files[0]) {
                const file = await compressImage(input.files[0]);
                state.regImage = file;
                const url = URL.createObjectURL(file);
                const img = document.getElementById('reg-img-preview');
                img.src = url;
                img.classList.remove('hidden');
                document.getElementById('reg-img-placeholder').classList.add('hidden');
            }
        };

        window.registerUser = async () => {
            const name = document.getElementById('reg-name').value;
            const phone = document.getElementById('reg-phone').value;
            const pass = document.getElementById('reg-pass').value;

            if(!name || !phone || !pass) return showToast('ุฌููุน ุงูุญููู ูุทููุจุฉ', 'e');
            if(!state.regImage) return showToast('ุตูุฑุฉ ุงูุจุฑููุงูู ูุทููุจุฉ', 'e');

            const btn = document.getElementById('btn-register');
            btn.innerText = 'ุฌุงุฑู ุงูุฅูุดุงุก...';
            btn.disabled = true;

            try {
                const photoURL = await uploadToCloudinary(state.regImage);
                const email = `0${phone}@souq.com`;
                const cred = await createUserWithEmailAndPassword(auth, email, pass);
                
                const userData = {
                    uid: cred.user.uid,
                    displayName: name,
                    phoneNumber: `+20${phone}`,
                    photoURL: photoURL,
                    createdAt: serverTimestamp()
                };
                await setDoc(doc(db, "users", cred.user.uid), userData);
                
                state.userProfile = userData;
                updateHeader();
                toggleModal('auth-modal');
                showToast(`ูุฑุญุจุงู ${name}`);
            } catch(e) {
                console.error(e);
                if(e.code === 'auth/operation-not-allowed') {
                    showToast('ูุฌุจ ุชูุนูู Email/Password ูู ููุญุฉ ุชุญูู Firebase', 'e');
                } else {
                    showToast('ุฎุทุฃ ูู ุงูุชุณุฌูู: ' + e.message, 'e');
                }
            } finally {
                btn.innerText = 'ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ';
                btn.disabled = false;
            }
        };

        window.loginUser = async () => {
            const phone = document.getElementById('login-phone').value;
            const pass = document.getElementById('login-pass').value;
            if(!phone || !pass) return showToast('ุจูุงูุงุช ูุงูุตุฉ', 'e');

            try {
                const email = `0${phone}@souq.com`;
                await signInWithEmailAndPassword(auth, email, pass);
                toggleModal('auth-modal');
                showToast('ุชู ุชุณุฌูู ุงูุฏุฎูู');
            } catch(e) {
                showToast('ุจูุงูุงุช ุงูุฏุฎูู ุบูุฑ ุตุญูุญุฉ', 'e');
            }
        };

        window.logoutUser = async () => {
            if(confirm('ุชุณุฌูู ุฎุฑูุฌุ')) {
                await signOut(auth);
                window.location.reload(); 
            }
        };

        function updateHeader() {
            const welcomeSection = document.getElementById('header-welcome-section');
            const logoutBtn = document.getElementById('btn-logout');
            const loginBtn = document.getElementById('btn-header-login');

            if(state.userProfile) {
                // Logged In: Show Profile & Name
                const optimizedProfile = getOptimizedUrl(state.userProfile.photoURL).replace('w_512,h_512', 'w_100,h_100,r_max');
                welcomeSection.innerHTML = `
                    <div class="profile-btn-header" onclick="handleProfileClick()">
                        <img src="${optimizedProfile}" class="profile-img-header">
                        <div class="profile-name-header">
                            <span>${state.userProfile.displayName}</span>
                            <span class="profile-welcome-sub">ุฃููุงู ุจู</span>
                        </div>
                    </div>
                `;
                logoutBtn.classList.remove('hidden');
                loginBtn.classList.add('hidden');
            } else {
                // Guest: Show Default Welcome
                welcomeSection.innerHTML = `
                    <span class="text-[9px] font-bold text-slate-500 dark:text-slate-400 leading-none">ูุฑุญุจุง ุจูู ูู</span>
                    <span class="text-[10px] font-black text-slate-800 dark:text-white leading-tight">ุณูู <span class="text-emerald-600 dark:text-emerald-400">ุงูุนูุงุฑุงุช</span></span>
                `;
                logoutBtn.classList.add('hidden');
                loginBtn.classList.remove('hidden');
            }
            lucide.createIcons();
        }

        window.openPublisherProfile = async () => {
            if(!state.currentPublisher) return;
            document.getElementById('pub-img').src = getOptimizedUrl(state.currentPublisher.photoURL).replace('w_512,h_512', 'w_200,h_200,r_max');
            document.getElementById('pub-name').innerText = state.currentPublisher.displayName;
            document.getElementById('pub-phone').innerText = state.currentPublisher.phoneNumber;
            toggleModal('publisher-modal');
        };

        function renderAmenities(list) { 
            document.getElementById('amenities-grid').innerHTML = list.map(a => `<label class="amenity-tile cursor-pointer"><input type="checkbox" class="amenity-check hidden" value="${a}"><div class="text-center py-1 border border-slate-200 dark:border-slate-600 rounded-lg text-[8px] font-bold text-slate-600 dark:text-slate-300 transition hover:bg-slate-50 dark:hover:bg-slate-700 truncate">${a}</div></label>`).join(''); 
        }

        function initLocations() {
            const govSelects = ['in-gov', 'filter-gov'];
            govSelects.forEach(id => {
                const sel = document.getElementById(id);
                if(sel) {
                    sel.innerHTML = `<option value="" ${id==='in-gov'?'disabled selected':'selected'}>${id==='in-gov'?'ุงููุญุงูุธุฉ':'ูู ุงููุญุงูุธุงุช'}</option>`;
                    Object.keys(EGYPT_LOCATIONS).forEach(gov => { sel.innerHTML += `<option value="${gov}">${gov}</option>`; });
                }
            });
        }

        window.populateCities = (govId, cityId) => {
            const gov = document.getElementById(govId).value;
            const citySel = document.getElementById(cityId);
            citySel.innerHTML = `<option value="" ${govId==='in-gov'?'disabled selected':'selected'}>${govId==='in-gov'?'ุงููุฑูุฒ/ุงููุฏููุฉ':'ูู ุงููุฑุงูุฒ'}</option>`;
            if(gov && EGYPT_LOCATIONS[gov]) { EGYPT_LOCATIONS[gov].forEach(city => { citySel.innerHTML += `<option value="${city}">${city}</option>`; }); }
        };

        window.toggleFilterPanel = () => { document.getElementById('filter-panel').classList.toggle('open'); };

        window.updateFormFields = () => {
            const cat = document.getElementById('in-category').value;
            const roomFields = document.getElementById('room-fields');
            const furnishedField = document.getElementById('furnished-field');
            const levelInput = document.getElementById('in-level');
            const floorsAltInput = document.getElementById('in-floors-alt');
            const landTypeWrapper = document.getElementById('land-type-wrapper');
            const landFields = document.getElementById('land-fields');
            const buildingFields = document.getElementById('building-fields');
            const extraFields = document.getElementById('extra-fields'); 

            roomFields.classList.remove('hidden'); furnishedField.classList.remove('hidden'); levelInput.classList.remove('hidden'); floorsAltInput.classList.add('hidden'); landTypeWrapper.classList.add('hidden'); landFields.classList.add('hidden'); buildingFields.classList.add('hidden'); extraFields.classList.remove('hidden');

            if(cat === 'land') { renderAmenities(LAND_AMENITIES); roomFields.classList.add('hidden'); furnishedField.classList.add('hidden'); levelInput.classList.add('hidden'); extraFields.classList.add('hidden'); landTypeWrapper.classList.remove('hidden'); landFields.classList.remove('hidden'); } 
            else { renderAmenities(ALL_AMENITIES); if (cat === 'building') { roomFields.classList.add('hidden'); furnishedField.classList.add('hidden'); levelInput.classList.add('hidden'); floorsAltInput.classList.remove('hidden'); buildingFields.classList.remove('hidden'); extraFields.classList.add('hidden'); } else if (['shop','office','warehouse'].includes(cat)) { roomFields.classList.add('hidden'); extraFields.classList.add('hidden'); } }
        }

        function checkAdminStatus() { if(localStorage.getItem('souq_admin') === 'true') { state.isAdmin = true; document.getElementById('btn-admin-top').classList.remove('hidden'); } }
        window.toggleDarkMode = () => { document.documentElement.classList.toggle('dark'); localStorage.setItem('souq_theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light'); }
        if(localStorage.getItem('souq_theme') === 'dark') document.documentElement.classList.add('dark');

        window.showToast=(m,t='s')=>{const d=document.createElement('div');d.className=`toast fixed top-4 left-1/2 -translate-x-1/2 bg-white dark:bg-slate-800 shadow-xl px-4 py-2 rounded-lg border border-${t==='e'?'red':'emerald'}-500 flex items-center gap-2 text-xs font-bold z-[100] text-slate-800 dark:text-white`;d.innerHTML=`<i data-lucide="${t==='e'?'alert-circle':'check-circle'}" class="w-4 h-4 text-${t==='e'?'red':'emerald'}-500"></i> ${m}`;document.getElementById('toast-container').appendChild(d);lucide.createIcons();setTimeout(()=>{d.classList.add('hiding');setTimeout(()=>d.remove(),300)},3000)};

        function normalizeText(t) { return t ? t.toString().toLowerCase().replace(/[ุฃุฅุข]/g, 'ุง').replace(/ุฉ/g, 'ู').replace(/ู/g, 'ู') : ""; }
        function timeAgo(d) { if(!d) return 'ุฌุฏูุฏ'; const s=Math.floor((new Date()-d.toDate())/1000); if(s<60)return 'ุงูุขู'; if(s<3600)return `ููุฐ ${Math.floor(s/60)} ุฏ`; if(s<86400)return `ููุฐ ${Math.floor(s/3600)} ุณ`; return `ููุฐ ${Math.floor(s/86400)} ู`; }
        function showSkeletons() { const c=document.getElementById('grid-container'); if(state.listings.length === 0) { c.innerHTML=''; for(let i=0;i<6;i++) c.innerHTML+=`<div class="bg-white dark:bg-slate-800 rounded-lg overflow-hidden shadow-sm border-2 border-navy/10 dark:border-slate-700 h-full"><div class="h-28 skeleton rounded-t-lg"></div><div class="p-2 space-y-2"><div class="h-3 rounded skeleton w-3/4"></div><div class="h-2 rounded skeleton w-1/2"></div></div></div>`; } }

        function loadListings() { 
            showSkeletons(); 
            onSnapshot(query(collection(db, COLLECTION_NAME)), (snap) => { 
                state.listings = []; 
                snap.forEach(d => state.listings.push({id:d.id, ...d.data()})); 
                localStorage.setItem('souq_listings', JSON.stringify(state.listings));
                state.listings.sort((a,b) => (a.isPinned === b.isPinned) ? (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0) : (a.isPinned ? -1 : 1));
                performSearch(); 
                document.body.classList.add('app-loaded');
                setTimeout(() => { document.getElementById('splash-screen').classList.add('hidden-splash'); }, 100);
                if(state.activeDetailsId) {
                    const updatedItem = state.listings.find(i => i.id === state.activeDetailsId);
                    if(updatedItem) {
                         const typeEl = document.getElementById('d-type-badge');
                         if(typeEl) {
                             if(updatedItem.status !== 'available') {
                                 typeEl.innerText = updatedItem.status === 'sold' ? 'ูุจุงุน' : 'ูุคุฌุฑ';
                                 typeEl.className = `absolute bottom-2 right-2 text-white px-2 py-0.5 rounded text-[10px] font-bold shadow backdrop-blur-sm ${updatedItem.status==='sold'?'bg-red-600':'bg-blue-600'}`;
                             } else {
                                 typeEl.innerText = updatedItem.type === 'sale' ? 'ููุจูุน' : 'ููุฅูุฌุงุฑ';
                                 typeEl.className = `absolute bottom-2 right-2 text-white px-2 py-0.5 rounded text-[10px] font-bold shadow backdrop-blur-sm ${updatedItem.type === 'sale' ? 'bg-emerald-600/90' : 'bg-blue-600/90'}`;
                             }
                         }
                    }
                }
            }); 
        }

        window.performSearch = () => { 
            const q = normalizeText(document.getElementById('search-input').value); 
            const filterGov = document.getElementById('filter-gov').value;
            const filterCity = document.getElementById('filter-city').value;
            const filterType = document.getElementById('filter-type').value;
            const filterCat = document.getElementById('filter-cat').value; 
            const minPrice = Number(document.getElementById('filter-min-price').value) || 0;
            const maxPrice = Number(document.getElementById('filter-max-price').value) || Infinity;
            let detectedCat = ''; for (const [key, val] of Object.entries(CAT_KEYWORDS)) { if (q.includes(key)) { detectedCat = val; break; } }
            const cont = document.getElementById('grid-container'); 
            const filtered = state.listings.filter(item => { 
                let matchType = true; if (state.currentFilter !== 'all' && item.type !== state.currentFilter) matchType = false;
                if (filterType && item.type !== filterType) matchType = false; if (filterCat && item.category !== filterCat) matchType = false; 
                const catNameAr = CAT_MAP[item.category] || '';
                const itemText = normalizeText(item.title + item.desc + item.phone + item.gov + item.city + item.location + (item.address || '') + catNameAr);
                const matchText = itemText.includes(q);
                const matchCat = !detectedCat || item.category === detectedCat; const matchGov = !filterGov || item.gov === filterGov; const matchCity = !filterCity || item.city === filterCity; const matchPrice = item.price >= minPrice && item.price <= maxPrice;
                return matchType && matchText && matchCat && matchGov && matchCity && matchPrice; 
            }); 
            const visibleItems = filtered.slice(0, state.visibleLimit);
            const loadMoreBtn = document.getElementById('load-more-container');
            if(!filtered.length) { document.getElementById('empty-state').classList.remove('hidden'); cont.innerHTML = ''; loadMoreBtn.classList.add('hidden'); } 
            else { document.getElementById('empty-state').classList.add('hidden'); cont.innerHTML = visibleItems.map(item => createCard(item)).join(''); lucide.createIcons({ root: cont }); if(filtered.length > state.visibleLimit) { loadMoreBtn.classList.remove('hidden'); } else { loadMoreBtn.classList.add('hidden'); } } 
        };

        window.loadMore = () => { state.visibleLimit += 6; performSearch(); };
        let searchTimeout; document.getElementById('search-input').addEventListener('input', () => { clearTimeout(searchTimeout); searchTimeout = setTimeout(performSearch, 200); }); document.getElementById('search-input').addEventListener('keydown', (e) => { if(e.key === 'Enter') { e.preventDefault(); performSearch(); document.getElementById('search-input').blur(); } });
        window.resetFilters = () => { ['filter-cat', 'filter-type', 'filter-gov'].forEach(id => document.getElementById(id).selectedIndex = 0); document.getElementById('filter-city').innerHTML = '<option value="">ูู ุงููุฑุงูุฒ</option>'; document.getElementById('filter-min-price').value = ''; document.getElementById('filter-max-price').value = ''; state.currentFilter = 'all'; state.visibleLimit = 6; performSearch(); };

        const getOptimizedUrl = (url, isVideo = false) => {
            if (!url || !url.includes('cloudinary.com')) return url;
            const parts = url.split('/upload/');
            if (parts.length < 2) return url;
            let params = 'w_512,h_512,c_fill,q_auto,f_auto';
            if (isVideo) {
                let cleanUrl = parts[1];
                const lastDot = cleanUrl.lastIndexOf('.');
                if (lastDot !== -1) cleanUrl = cleanUrl.substring(0, lastDot) + '.jpg';
                return `${parts[0]}/upload/${params},so_0/${cleanUrl}`;
            }
            return `${parts[0]}/upload/${params}/${parts[1]}`;
        };

        function createCard(item) {
            const imgs = Array.isArray(item.images) ? item.images : [item.image];
            const firstMedia = imgs[0];
            const isVideo = firstMedia.includes('.mp4') || firstMedia.includes('.mov');
            const thumbUrl = getOptimizedUrl(firstMedia, isVideo);
            let badge = item.badge==='hot' ? `<span class="inline-block bg-orange-500 text-white text-[8px] font-bold px-1.5 py-0.5 rounded shadow animate-pulse">๐ฅ ููุทุฉ</span>` : (item.badge==='verified' ? `<span class="inline-block bg-blue-500 text-white text-[8px] font-bold px-1.5 py-0.5 rounded shadow flex items-center gap-0.5"><i data-lucide="check-circle" class="w-2 h-2"></i> ููุซูู</span>` : '');
            let statusOverlay = ''; if(item.status && item.status !== 'available') { const txt = item.status==='sold'?'ุชู ุงูุจูุน':'ุชู ุงูุชุฃุฌูุฑ'; const clr = item.status==='sold'?'bg-red-600':'bg-blue-600'; statusOverlay=`<div class="absolute inset-0 sold-overlay flex items-center justify-center z-30 pointer-events-none bg-black/40"><span class="${clr} text-white font-bold px-3 py-1 rounded-lg shadow-xl transform -rotate-12 text-xs">${txt}</span></div>`; }
            let iconsHtml = '';
            if(item.category === 'land') { if(item.feddan || item.qirat) iconsHtml += `<span class="flex items-center gap-0.5"><i data-lucide="maximize" class="w-2.5 h-2.5 text-slate-400"></i> ${item.feddan?item.feddan+' ู':''} ${item.qirat?item.qirat+' ู':''}</span>`; } 
            else if (item.category === 'building') { if(item.floors) iconsHtml += `<span class="flex items-center gap-0.5"><i data-lucide="layers" class="w-2.5 h-2.5 text-slate-400"></i> ${item.floors}</span>`; } 
            else { if(item.rooms) iconsHtml += `<span class="flex items-center gap-0.5"><i data-lucide="bed-double" class="w-2.5 h-2.5 text-slate-400"></i> ${item.rooms}</span>`; if(item.baths) iconsHtml += `<span class="flex items-center gap-0.5"><i data-lucide="bath" class="w-2.5 h-2.5 text-slate-400"></i> ${item.baths}</span>`; }
            if(item.area) iconsHtml += `<span class="flex items-center gap-0.5"><i data-lucide="ruler" class="w-2.5 h-2.5 text-slate-400"></i> ${item.area}ู</span>`;
            const locDisplay = item.gov ? `${item.gov}ุ ${item.city}` : item.location;
            const waMsg = `ููุชู ุจูุฐุง ุงูุนูุงุฑ: ${item.title} (${Number(item.price).toLocaleString()} ุฌ)`;
            const waLink = `https://wa.me/20${item.phone}?text=${encodeURIComponent(waMsg)}`;

            return `<div class="listing-card bg-white dark:bg-slate-800 rounded-lg overflow-hidden shadow-sm border border-black dark:border-slate-500 flex flex-col h-full cursor-pointer active:scale-95 transition-transform group relative transform-gpu" onclick="openDetails('${item.id}')">
                <div class="relative w-full h-28 sm:h-36 bg-gray-200 dark:bg-slate-700 shrink-0">
                    ${statusOverlay}
                    <span class="absolute top-1.5 right-1.5 ${item.type === 'sale' ? 'bg-emerald-600' : 'bg-blue-600'} text-white px-1.5 py-0.5 rounded text-[8px] font-bold shadow z-20">${item.type === 'sale' ? 'ุจูุน' : 'ุฅูุฌุงุฑ'}</span>
                    <img src="${thumbUrl}" loading="lazy" decoding="async" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110 ${statusOverlay?'grayscale':''}">
                    ${imgs.length > 1 ? `<div class="absolute bottom-1 left-1 bg-black/50 text-white text-[8px] px-1.5 rounded flex items-center gap-1"><i data-lucide="images" class="w-2 h-2"></i> +${imgs.length-1}</div>` : ''}
                    ${isVideo ? `<div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-black/30 rounded-full p-1"><i data-lucide="play-circle" class="w-6 h-6 text-white/90"></i></div>` : ''}
                </div>
                <div class="p-1.5 flex-1 flex flex-col">
                    <div class="flex-1">
                        <div class="flex justify-between items-start mb-0.5"><h3 class="font-bold text-slate-900 dark:text-white text-[10px] line-clamp-1 leading-tight">${item.title}</h3><span class="font-black text-emerald-600 dark:text-emerald-400 text-[10px] whitespace-nowrap">${Number(item.price).toLocaleString()} ุฌ</span></div>
                        <div class="h-3.5 flex justify-end items-center mt-0.5">${!statusOverlay ? badge : ''}</div>
                        <div class="flex items-center gap-0.5 text-[9px] text-slate-500 dark:text-slate-400 mb-0.5 mt-0.5"><i data-lucide="map-pin" class="w-2.5 h-2.5 text-emerald-500 shrink-0"></i><span class="truncate leading-tight">${locDisplay}</span></div>
                        ${item.address ? `<div class="flex items-center gap-0.5 text-[9px] text-slate-500 dark:text-slate-400 mb-0.5"><i data-lucide="map" class="w-2.5 h-2.5 text-slate-400 shrink-0"></i><span class="truncate leading-tight">${item.address}</span></div>` : ''}
                        <div class="flex items-center gap-2 text-[9px] text-slate-600 dark:text-slate-300 font-bold mb-1.5 h-4">${iconsHtml}</div>
                    </div>
                    <div class="mt-auto flex gap-1 pt-1.5 border-t border-slate-100 dark:border-slate-700">
                        <a href="${waLink}" target="_blank" onclick="event.stopPropagation()" class="flex-1 bg-emerald-600 text-white py-1 rounded flex justify-center items-center gap-1 text-[9px] font-bold"><i data-lucide="message-circle" class="w-2.5 h-2.5"></i> ูุงุชุณ</a>
                        <a href="tel:${item.phone}" onclick="event.stopPropagation()" class="bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 p-1 rounded"><i data-lucide="phone" class="w-2.5 h-2.5"></i></a>
                    </div>
                </div>
            </div>`;
        }

        function clearDetailsData() {
            document.getElementById('d-title').innerText = ''; document.getElementById('d-price').innerText = ''; document.getElementById('d-desc').innerText = ''; document.getElementById('d-time-badge').innerText = ''; document.getElementById('d-amenities').innerHTML = ''; document.getElementById('d-table-body').innerHTML = ''; document.getElementById('details-slider').innerHTML = '';
            document.getElementById('d-pub-name').innerText = '';
            document.getElementById('d-pub-img').src = '';
            document.getElementById('d-pub-img').classList.add('hidden');
            const slider = document.getElementById('details-slider'); if(slider) slider.scrollLeft = 0;
        }

        window.openDetails = async (id) => {
            if (state.activeDetailsId === id) { toggleModal('details-modal'); return; }
            clearDetailsData();
            const newUrl = new URL(window.location); newUrl.searchParams.set('id', id); window.history.pushState({}, '', newUrl);

            if(toggleModal('details-modal')){
                requestAnimationFrame(async () => {
                    setTimeout(async () => {
                         try {
                            const item = state.listings.find(i => i.id === id); if(!item) return;
                            state.activeDetailsId = id; state.currentItem = item; state.currentDetailIndex = 0; 

                            // Publisher Caching Logic
                            const renderPublisher = (pubData) => {
                                document.getElementById('d-pub-name').innerText = pubData.displayName;
                                const img = document.getElementById('d-pub-img');
                                img.src = getOptimizedUrl(pubData.photoURL).replace('w_512,h_512', 'w_100,h_100,r_max');
                                img.classList.remove('hidden');
                            };

                            state.currentPublisher = null;
                            if(item.authorId) {
                                if(state.publisherCache[item.authorId]) {
                                    state.currentPublisher = state.publisherCache[item.authorId];
                                    renderPublisher(state.currentPublisher);
                                } else {
                                    document.getElementById('d-pub-name').innerText = '...'; 
                                    const pubDoc = await getDoc(doc(db, "users", item.authorId));
                                    if(pubDoc.exists()) {
                                        state.currentPublisher = pubDoc.data();
                                        state.publisherCache[item.authorId] = state.currentPublisher; 
                                        renderPublisher(state.currentPublisher);
                                    } else {
                                        // Fallback for old listings or missing users
                                        state.currentPublisher = DUMMY_PUBLISHER;
                                        renderPublisher(DUMMY_PUBLISHER);
                                    }
                                }
                            } else {
                                // No author ID (Old listing)
                                state.currentPublisher = DUMMY_PUBLISHER;
                                renderPublisher(DUMMY_PUBLISHER);
                            }

                            document.getElementById('d-title').innerText = item.title; document.getElementById('d-price').innerText = Number(item.price).toLocaleString() + ' ุฌููู'; document.getElementById('d-desc').innerText = item.desc; document.getElementById('d-time-badge').innerText = timeAgo(item.createdAt);
                            const amCont = document.getElementById('d-amenities'); amCont.innerHTML=''; 
                            if(item.amenities && Array.isArray(item.amenities) && item.amenities.length > 0) { item.amenities.forEach(a => { amCont.innerHTML += `<div class="p-1.5 text-center text-[9px] font-bold text-slate-700 dark:text-slate-300 border-r border-b border-slate-200 dark:border-slate-700 last:border-r-0">${a}</div>`; }); } else { amCont.innerHTML = `<div class="col-span-3 p-2 text-center text-[9px] text-slate-400">ูุง ุชูุฌุฏ ูููุฒุงุช ุฅุถุงููุฉ</div>`; }
                            const mapBtn = document.getElementById('d-map'); if(item.mapLink) { mapBtn.classList.remove('hidden'); mapBtn.classList.add('flex'); mapBtn.href = item.mapLink; } else { mapBtn.classList.add('hidden'); mapBtn.classList.remove('flex'); }
                            
                            const typeEl = document.getElementById('d-type-badge');
                            if(item.status !== 'available') { typeEl.innerText = item.status === 'sold' ? 'ูุจุงุน' : 'ูุคุฌุฑ'; typeEl.className = `absolute bottom-2 right-2 text-white px-2 py-0.5 rounded text-[10px] font-bold shadow backdrop-blur-sm ${item.status==='sold'?'bg-red-600':'bg-blue-600'}`; } 
                            else { typeEl.innerText = item.type === 'sale' ? 'ููุจูุน' : 'ููุฅูุฌุงุฑ'; typeEl.className = `absolute bottom-2 right-2 text-white px-2 py-0.5 rounded text-[10px] font-bold shadow backdrop-blur-sm ${item.type === 'sale' ? 'bg-emerald-600/90' : 'bg-blue-600/90'}`; }

                            const imgs = Array.isArray(item.images) ? item.images : [item.image]; 
                            const updateWaLink = () => { const shareUrl = window.location.origin + window.location.pathname + '?id=' + item.id; const waMsg = `ููุชู ุจูุฐุง ุงูุนูุงุฑ: ${item.title} (${Number(item.price).toLocaleString()} ุฌ)\nุงูุฑุงุจุท: ${shareUrl}`; document.getElementById('d-wa').href = `https://wa.me/20${item.phone}?text=${encodeURIComponent(waMsg)}`; };
                            updateWaLink(); document.getElementById('d-call').href = `tel:${item.phone}`;

                            const slider = document.getElementById('details-slider'); 
                            slider.innerHTML = imgs.map((src, idx) => { 
                                const isVid = src.includes('.mp4') || src.includes('.mov'); 
                                // Use compressed thumbnail for slider (w_500, q_auto:low)
                                const thumb = getOptimizedUrl(src, isVid).replace('w_512', 'w_500,q_auto:low'); 
                                return isVid ? `<video src="${src}" controls class="w-full h-full object-contain snap-center shrink-0 bg-black"></video>` : `<img src="${thumb}" loading="lazy" class="w-full h-full object-cover snap-center shrink-0 cursor-pointer" onclick="openLightbox('${src}', ${idx})">` 
                            }).join('');
                            document.getElementById('details-arrows').style.display = imgs.length > 1 ? 'block' : 'none';

                            const locDisplay = item.gov ? `${item.gov}ุ ${item.city}` : item.location;
                            let tableHtml = `<tr><th class="w-1/3 text-slate-500 dark:text-slate-400 font-normal bg-slate-50 dark:bg-slate-800/50 text-[10px] flex items-center gap-1"><i data-lucide="home" class="w-3 h-3"></i> ููุน ุงูุนูุงุฑ</th><td class="font-bold text-slate-800 dark:text-slate-200">${CAT_MAP[item.category] || 'ุนูุงุฑ'}</td></tr>`;
                            tableHtml += `<tr><th class="text-slate-500 dark:text-slate-400 font-normal bg-slate-50 dark:bg-slate-800/50 text-[10px] flex items-center gap-1"><i data-lucide="map-pin" class="w-3 h-3"></i> ุงููููุน</th><td class="font-bold text-slate-800 dark:text-slate-200">${locDisplay}</td></tr>`;
                            if(item.address) tableHtml += `<tr><th class="text-slate-500 dark:text-slate-400 font-normal bg-slate-50 dark:bg-slate-800/50 text-[10px] flex items-center gap-1"><i data-lucide="map" class="w-3 h-3"></i> ุงูุนููุงู</th><td class="font-bold text-slate-800 dark:text-slate-200">${item.address}</td></tr>`;
                            if(item.area) tableHtml += `<tr><th class="text-slate-500 dark:text-slate-400 font-normal bg-slate-50 dark:bg-slate-800/50 text-[10px] flex items-center gap-1"><i data-lucide="ruler" class="w-3 h-3"></i> ุงููุณุงุญุฉ</th><td class="font-bold text-slate-800 dark:text-slate-200">${item.area} ูยฒ</td></tr>`;
                            if(item.category === 'land') { if(item.landType) tableHtml += `<tr><th class="text-slate-500 dark:text-slate-400 font-normal bg-slate-50 dark:bg-slate-800/50 text-[10px] flex items-center gap-1"><i data-lucide="sprout" class="w-3 h-3"></i> ููุน ุงูุฃุฑุถ</th><td class="font-bold text-slate-800 dark:text-slate-200">${item.landType==='building'?'ูุจุงูู':'ุฒุฑุงุนูุฉ'}</td></tr>`; if(item.feddan) tableHtml += `<tr><th class="text-slate-500 dark:text-slate-400 font-normal bg-slate-50 dark:bg-slate-800/50 text-[10px] flex items-center gap-1"><i data-lucide="maximize" class="w-3 h-3"></i> ูุฏุงู</th><td class="font-bold text-slate-800 dark:text-slate-200">${item.feddan}</td></tr>`; if(item.qirat) tableHtml += `<tr><th class="text-slate-500 dark:text-slate-400 font-normal bg-slate-50 dark:bg-slate-800/50 text-[10px] flex items-center gap-1"><i data-lucide="minimize" class="w-3 h-3"></i> ููุฑุงุท</th><td class="font-bold text-slate-800 dark:text-slate-200">${item.qirat}</td></tr>`; } 
                            else if (item.category === 'building') { if(item.floors) tableHtml += `<tr><th class="text-slate-500 dark:text-slate-400 font-normal bg-slate-50 dark:bg-slate-800/50 text-[10px] flex items-center gap-1"><i data-lucide="layers" class="w-3 h-3"></i> ุนุฏุฏ ุงูุฃุฏูุงุฑ</th><td class="font-bold text-slate-800 dark:text-slate-200">${item.floors}</td></tr>`; if(item.apartments) tableHtml += `<tr><th class="text-slate-500 dark:text-slate-400 font-normal bg-slate-50 dark:bg-slate-800/50 text-[10px] flex items-center gap-1"><i data-lucide="grid" class="w-3 h-3"></i> ุนุฏุฏ ุงูุดูู</th><td class="font-bold text-slate-800 dark:text-slate-200">${item.apartments}</td></tr>`; } 
                            else { if(item.rooms) tableHtml += `<tr><th class="text-slate-500 dark:text-slate-400 font-normal bg-slate-50 dark:bg-slate-800/50 text-[10px] flex items-center gap-1"><i data-lucide="bed-double" class="w-3 h-3"></i> ุงูุบุฑู</th><td class="font-bold text-slate-800 dark:text-slate-200">${item.rooms}</td></tr>`; if(item.baths) tableHtml += `<tr><th class="text-slate-500 dark:text-slate-400 font-normal bg-slate-50 dark:bg-slate-800/50 text-[10px] flex items-center gap-1"><i data-lucide="bath" class="w-3 h-3"></i> ุงูุญูุงูุงุช</th><td class="font-bold text-slate-800 dark:text-slate-200">${item.baths}</td></tr>`; if(item.balconies) tableHtml += `<tr><th class="text-slate-500 dark:text-slate-400 font-normal bg-slate-50 dark:bg-slate-800/50 text-[10px] flex items-center gap-1"><i data-lucide="wind" class="w-3 h-3"></i> ุงูุจููููุงุช</th><td class="font-bold text-slate-800 dark:text-slate-200">${item.balconies}</td></tr>`; if(item.finishing) tableHtml += `<tr><th class="text-slate-500 dark:text-slate-400 font-normal bg-slate-50 dark:bg-slate-800/50 text-[10px] flex items-center gap-1"><i data-lucide="paint-bucket" class="w-3 h-3"></i> ุงูุชุดุทูุจ</th><td class="font-bold text-slate-800 dark:text-slate-200">${FINISH_MAP[item.finishing] || item.finishing}</td></tr>`; if(item.level) tableHtml += `<tr><th class="text-slate-500 dark:text-slate-400 font-normal bg-slate-50 dark:bg-slate-800/50 text-[10px] flex items-center gap-1"><i data-lucide="arrow-up-circle" class="w-3 h-3"></i> ุงูุฏูุฑ</th><td class="font-bold text-slate-800 dark:text-slate-200">${item.level}</td></tr>`; if(item.furnished) tableHtml += `<tr><th class="text-slate-500 dark:text-slate-400 font-normal bg-slate-50 dark:bg-slate-800/50 text-[10px] flex items-center gap-1"><i data-lucide="sofa" class="w-3 h-3"></i> ุงููุฑุด</th><td class="font-bold text-slate-800 dark:text-slate-200">${item.furnished==='yes'?'ููุฑูุด':'ุบูุฑ ููุฑูุด'}</td></tr>`; }
                            document.getElementById('d-table-body').innerHTML = tableHtml;

                            const isOwner = state.user && state.user.uid === item.authorId;
                            const showControls = state.isAdmin || isOwner;
                            const controlsDiv = document.getElementById('d-controls');
                            if(showControls) {
                                controlsDiv.classList.remove('hidden');
                                controlsDiv.innerHTML = `<div class="flex items-center gap-2"><button onclick="del(event,'${item.id}')" class="bg-red-50 text-red-600 border border-red-200 py-1 px-3 rounded text-[9px] font-bold flex items-center justify-center gap-1"><i data-lucide="trash-2" class="w-3 h-3"></i> ุญุฐู</button><div class="custom-select-wrapper w-24"><select onchange="updateStatus(event, '${item.id}', this.value)" class="custom-select h-7 py-0 text-[9px] border-emerald-200 bg-emerald-50 text-emerald-800"><option value="available" ${item.status==='available'?'selected':''}>๐ข ูุชุงุญ</option><option value="sold" ${item.status==='sold'?'selected':''}>๐ด ูุจุงุน</option><option value="rented" ${item.status==='rented'?'selected':''}>๐ต ูุคุฌุฑ</option></select><i data-lucide="chevron-down" class="custom-select-icon w-3 h-3"></i></div>${state.isAdmin ? `<button onclick="pin(event,'${item.id}',${item.isPinned})" class="${item.isPinned ? 'bg-yellow-100 text-yellow-600 border-yellow-300' : 'bg-slate-100 text-slate-600 border-slate-200'} border py-1 px-3 rounded text-[9px] font-bold flex items-center justify-center gap-1"><i data-lucide="star" class="w-3 h-3 ${item.isPinned?'fill-current':''}"></i> ุชุซุจูุช</button>` : ''}</div>`;
                            } else { controlsDiv.classList.add('hidden'); }
                            lucide.createIcons();
                        } catch(e) { console.error(e); showToast('ุญุฏุซ ุฎุทุฃ ูู ุนุฑุถ ุงูุชูุงุตูู', 'e'); }
                    }, 50); 
                });
            }
        }
        window.closeDetails = () => { toggleModal('details-modal'); const newUrl = new URL(window.location); newUrl.searchParams.delete('id'); window.history.pushState({}, '', newUrl); state.activeDetailsId = null; }
        window.shareListing = async () => { if(!state.currentItem) return; const d = { title: 'ุงูุณูู ููุงู', text: `ุดุงูุฏ ุนูุงุฑ: ${state.currentItem.title}`, url: window.location.href + '?id=' + state.currentItem.id }; try { await navigator.share(d); showToast('ุชูุช ุงููุดุงุฑูุฉ'); } catch(e) { navigator.clipboard.writeText(d.url); showToast('ุชู ุงููุณุฎ'); } };
        window.downloadImages = async () => { if(!state.currentItem || !state.currentItem.images) return; showToast('ุฌุงุฑู ุชุญุถูุฑ ุงูุตูุฑ...'); for(let i=0; i<state.currentItem.images.length; i++) { const url = state.currentItem.images[i]; const a = document.createElement('a'); a.href = url; a.target = '_blank'; a.download = `souq_${state.currentItem.id}_${i+1}`; document.body.appendChild(a); a.click(); document.body.removeChild(a); await new Promise(r => setTimeout(r, 500)); } };
        window.scrollDetails = (dir) => { const slider = document.getElementById('details-slider'); const count = slider.children.length; if(count === 0) return; let newIndex = state.currentDetailIndex + dir; if (newIndex >= count) newIndex = 0; if (newIndex < 0) newIndex = count - 1; state.currentDetailIndex = newIndex; const target = slider.children[newIndex]; target.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'start' }); }
        window.openLightbox = (src, idx = 0) => { state.lightboxIndex = idx; updateLightboxImage(); document.getElementById('lightbox').classList.remove('hidden'); }
        window.closeLightbox = () => document.getElementById('lightbox').classList.add('hidden');
        window.changeLightboxImage = (dir) => { if (!state.currentItem || !state.currentItem.images) return; const len = state.currentItem.images.length; state.lightboxIndex = (state.lightboxIndex + dir + len) % len; updateLightboxImage(); };
        function updateLightboxImage() { const img = document.getElementById('lightbox-img'); const src = state.currentItem.images[state.lightboxIndex]; if (src.includes('.mp4') || src.includes('.mov')) { img.src = ""; showToast("ููุฏูู: ูุฑุฌู ุงููุดุงูุฏุฉ ูู ุงูุชูุงุตูู"); } else { img.style.opacity = '0.5'; img.src = src; img.onload = () => img.style.opacity = '1'; } }
        function toggleModal(id) { const m=document.getElementById(id); m.classList.toggle('hidden'); if(!m.classList.contains('hidden')) document.body.style.overflow='hidden'; else document.body.style.overflow=''; return !m.classList.contains('hidden'); }
        
        window.toggleAddModal=()=>{
            if(state.user && !state.user.isAnonymous) {
                if(toggleModal('add-modal')){
                    state.filesToUpload=[]; document.getElementById('preview-area').innerHTML=''; updateFormFields();
                    const newUrl = new URL(window.location); if(!document.getElementById('add-modal').classList.contains('hidden')) { newUrl.searchParams.set('mode', 'add'); } else { newUrl.searchParams.delete('mode'); } window.history.pushState({}, '', newUrl);
                }
            } else {
                showToast('ูุฌุจ ุชุณุฌูู ุงูุฏุฎูู ุฃููุงู', 'e');
                toggleModal('auth-modal');
            }
        };

        async function compressImage(file) { if (file.type.startsWith('video')) return file; return new Promise((resolve) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = (e) => { const img = new Image(); img.src = e.target.result; img.onload = () => { const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); const maxWidth = 1024; let width = img.width; let height = img.height; if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; } canvas.width = width; canvas.height = height; ctx.drawImage(img, 0, 0, width, height); canvas.toBlob((blob) => { resolve(new File([blob], file.name, { type: 'image/jpeg', lastModified: Date.now() })); }, 'image/jpeg', 0.7); }; }; }); }
        window.handleUpload = async (input) => { if(input.files.length + state.filesToUpload.length > 10) return showToast('10 ูููุงุช ูุญุฏ ุฃูุตู','e'); showToast('ุฌุงุฑู ูุนุงูุฌุฉ ุงูุตูุฑ...'); for(let f of input.files){ const compressedFile = await compressImage(f); state.filesToUpload.push(compressedFile); await new Promise(resolve => setTimeout(resolve, 10)); } renderPreview(); }; 
        function renderPreview() { const area = document.getElementById('preview-area'); area.innerHTML = state.filesToUpload.map((f, idx) => { const isVid = f.type.startsWith('video'); const url = URL.createObjectURL(f); return `<div class="relative w-12 h-12 shrink-0 group">${isVid ? `<video src="${url}" class="w-full h-full rounded-lg object-cover border border-gray-200"></video>` : `<img src="${url}" class="w-full h-full rounded-lg object-cover border border-gray-200">`}<button onclick="removeFile(${idx})" class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full p-0.5 shadow-sm"><i data-lucide="x" class="w-3 h-3"></i></button></div>`}).join(''); lucide.createIcons(); }
        window.removeFile = (idx) => { state.filesToUpload.splice(idx, 1); renderPreview(); }
        async function uploadToCloudinary(file) { const formData = new FormData(); formData.append('file', file); formData.append('upload_preset', 'souq_upload'); const res = await fetch('https://api.cloudinary.com/v1_1/db9h7zm1h/auto/upload', { method: 'POST', body: formData }); const data = await res.json(); return data.secure_url; }

        window.submitListing = async () => {
            try {
                const gov = document.getElementById('in-gov').value; const city = document.getElementById('in-city').value;
                if(!gov || !city) return showToast('ูุฑุฌู ุงุฎุชูุงุฑ ุงููุญุงูุธุฉ ูุงููุฑูุฒ', 'e');
                if(!state.filesToUpload.length) return showToast('ูุทููุจ ุตูุฑุฉ ุฃู ููุฏูู','e');
                const btn = document.getElementById('btn-publish'); const originalText = btn.innerText; btn.innerText='ุฌุงุฑู ุงูุฑูุน ูุงููุดุฑ...'; btn.disabled = true;
                const uploadedUrls = []; for(let f of state.filesToUpload) { const url = await uploadToCloudinary(f); uploadedUrls.push(url); }
                const bdg = document.querySelector('input[name="badge"]:checked').value; const am = []; document.querySelectorAll('.amenity-check:checked').forEach(c => am.push(c.value)); const cat = document.getElementById('in-category').value; const furnished = document.querySelector('input[name="furnished"]:checked')?.value; const landType = document.getElementById('in-land-type').value;
                await addDoc(collection(db, COLLECTION_NAME),{ title: document.getElementById('in-title').value, price: Number(document.getElementById('in-price').value), type: document.getElementById('in-type').value, category: cat, area: Number(document.getElementById('in-area').value) || 0, feddan: Number(document.getElementById('in-feddan').value) || 0, qirat: Number(document.getElementById('in-qirat').value) || 0, landType: landType, floors: Number(cat === 'building' ? document.getElementById('in-floors-alt').value : document.getElementById('in-floors-alt').value) || 0, apartments: Number(document.getElementById('in-apartments').value) || 0, rooms: Number(document.getElementById('in-rooms').value) || 0, baths: Number(document.getElementById('in-baths').value) || 0, balconies: Number(document.getElementById('in-balconies').value) || 0, finishing: document.getElementById('in-finishing').value, level: document.getElementById('in-level').value, furnished: furnished, gov: gov, city: city, address: document.getElementById('in-address').value, location: document.getElementById('in-loc')?.value || '', phone: document.getElementById('in-phone').value, desc: document.getElementById('in-desc').value, mapLink: document.getElementById('in-map').value, amenities: am, images: uploadedUrls, image: uploadedUrls[0], badge: bdg, status: 'available', isPinned: false, createdAt: serverTimestamp(), authorId: state.user.uid });
                showToast('ุชู ุงููุดุฑ ุจูุฌุงุญ'); toggleModal('add-modal'); state.filesToUpload = []; document.getElementById('preview-area').innerHTML = ''; document.getElementById('in-title').value = ''; document.getElementById('in-price').value = ''; document.getElementById('in-area').value = ''; document.getElementById('in-desc').value = ''; btn.innerText = originalText; btn.disabled = false;
            } catch(e) { console.error(e); showToast('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงููุดุฑ', 'e'); document.getElementById('btn-publish').innerText = 'ูุดุฑ ุงูุฅุนูุงู'; document.getElementById('btn-publish').disabled = false; }
        };

        window.del=async(e,id)=>{if(e)e.stopPropagation();if(confirm('ุญุฐูุ')){await deleteDoc(doc(db, COLLECTION_NAME, id));showToast('ุชู ุงูุญุฐู'); closeDetails();}};
        window.pin=async(e,id,s)=>{if(e)e.stopPropagation();await updateDoc(doc(db, COLLECTION_NAME, id),{isPinned:!s});showToast(s?'ุชู ุฅูุบุงุก ุงูุชุซุจูุช':'ุชู ุงูุชุซุจูุช'); closeDetails();};
        window.updateStatus = async (e, id, newStatus) => { if(e) e.stopPropagation(); const item = state.listings.find(i => i.id === id); if(item) { item.status = newStatus; const typeEl = document.getElementById('d-type-badge'); if(typeEl) { if(newStatus !== 'available') { typeEl.innerText = newStatus === 'sold' ? 'ูุจุงุน' : 'ูุคุฌุฑ'; typeEl.className = `absolute bottom-2 right-2 text-white px-2 py-0.5 rounded text-[10px] font-bold shadow backdrop-blur-sm ${newStatus==='sold'?'bg-red-600':'bg-blue-600'}`; } else { typeEl.innerText = item.type === 'sale' ? 'ููุจูุน' : 'ููุฅูุฌุงุฑ'; typeEl.className = `absolute bottom-2 right-2 text-white px-2 py-0.5 rounded text-[10px] font-bold shadow backdrop-blur-sm ${item.type === 'sale' ? 'bg-emerald-600/90' : 'bg-blue-600/90'}`; } } } try { await updateDoc(doc(db, COLLECTION_NAME, id), { status: newStatus }); showToast('ุชู ุชุญุฏูุซ ุงูุญุงูุฉ'); } catch(err) { console.error(err); showToast('ุฎุทุฃ ูู ุงูุชุญุฏูุซ', 'e'); } };

        window.toggleChat=()=>{if(toggleModal('chat-modal')){if(!state.chatId&&state.chatStep===0&&!state.welcomeSent){state.welcomeSent=true;setTimeout(()=>botMsg('ูุฑุญุจุงู! ๐<br>ูุง ูู ุงูุงุณูุ'),100)}}};
        window.sendMsg=async()=>{const t=document.getElementById('chat-msg').value.trim();if(!t)return;document.getElementById('chat-msg').value='';userMsg(t);if(!state.chatId){if(state.chatStep===0){state.tempName=t;state.chatStep=1;setTimeout(()=>botMsg(`ุฃููุงู ${t}ุ ููู ูุณุงุนุฏูุ`),200)}else if(state.chatStep===1){state.chatStep=2;setTimeout(()=>botMsg('ุฌุงุฑู ุชุญูููู ููุฏุนู ุงูููู...'),200);const r=await addDoc(collection(db,"chats"),{userId:state.user.uid,userName:state.tempName,lastMsg:t,status:'waiting',messages:[{s:'bot',t:`ุงูุงุณู: ${state.tempName}`,d:new Date()},{s:'user',t,d:new Date()},{s:'bot',t:'ุฌุงุฑู ุชุญูููู ููุฏุนู ุงูููู...',d:new Date()}],createdAt:serverTimestamp()});state.chatId=r.id;listenChat(r.id)}}else{const s=await getDocs(query(collection(db,"chats"),where('__name__','==',state.chatId)));if(!s.empty){const m=s.docs[0].data().messages;m.push({s:'user',t,d:new Date()});await updateDoc(doc(db,"chats",state.chatId),{messages:m,lastMsg:t,status:'waiting'})}}};
        function listenChat(id){onSnapshot(doc(db,"chats",id),s=>{if(s.exists()){const d=s.data();if(d.status==='closed'){state.chatId=null;state.chatStep=0;state.welcomeSent=false;document.getElementById('chat-box').innerHTML='';showToast("ุชู ุฅููุงุก ุงููุญุงุฏุซุฉ");toggleModal('chat-modal');return}document.getElementById('chat-box').innerHTML='';d.messages.forEach(m=>{if(!m.t.startsWith('ุงูุงุณู'))(m.s==='user'?userMsg:botMsg)(m.t)})}})};
        function checkUserChat(){onSnapshot(query(collection(db,"chats"),where('userId','==',state.user.uid),where('status','!=','closed')),s=>{if(!s.empty){state.chatId=s.docs[0].id;state.chatStep=2;listenChat(state.chatId)}})};
        function userMsg(t){const d=document.createElement('div');d.className="flex justify-start";d.innerHTML=`<div class="bg-emerald-100 text-emerald-900 px-3 py-2 rounded-xl rounded-tr-none shadow-sm text-xs max-w-[85%]">${t}</div>`;document.getElementById('chat-box').appendChild(d);document.getElementById('chat-box').scrollTop=9999}
        function botMsg(t){const d=document.createElement('div');d.className="flex justify-end";d.innerHTML=`<div class="bg-white dark:bg-slate-700 dark:text-white text-slate-800 px-3 py-2 rounded-xl rounded-tl-none shadow-sm text-xs max-w-[85%]">${t}</div>`;document.getElementById('chat-box').appendChild(d);document.getElementById('chat-box').scrollTop=9999}

        window.toggleAdminPanel=()=>{document.getElementById('admin-panel').classList.toggle('hidden');if(!document.getElementById('admin-panel').classList.contains('hidden'))refreshAdmin()};
        document.getElementById('logo-trigger').addEventListener('click',()=>{if(prompt('Code:')==='1532'){state.isAdmin=true;document.getElementById('btn-admin-top').classList.remove('hidden');localStorage.setItem('souq_admin', 'true');showToast('ุฃุฏูู');}});
        window.refreshAdmin=()=>{onSnapshot(query(collection(db,"chats"),where('status','!=','closed')),s=>{const l=document.getElementById('admin-users-list');l.innerHTML='';s.forEach(d=>{const dt=d.data();l.innerHTML+=`<div onclick="loadAdmin('${d.id}','${dt.userName}')" class="p-3 mb-2 bg-white/5 rounded-xl cursor-pointer border border-white/10"><div class="font-bold text-xs text-white flex justify-between"><span>${dt.userName}</span>${dt.status==='waiting'?'<span class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>':''}</div><div class="text-[10px] text-gray-400 truncate mt-1">${dt.lastMsg}</div></div>`})})};
        window.loadAdmin=(id,n)=>{state.activeAdminChat=id;document.getElementById('admin-chat-header').innerHTML=`<span>${n}</span><button onclick="kickUser()" id="btn-end-chat" class="hidden bg-red-600 text-white text-[10px] font-bold px-2 py-1 rounded flex items-center gap-1"><i data-lucide="slash" class="w-3 h-3"></i> ุฅููุงุก</button>`;document.getElementById('btn-end-chat').classList.remove('hidden');onSnapshot(doc(db,"chats",id),s=>{const b=document.getElementById('admin-msg-area');b.innerHTML='';if(!s.exists())return;s.data().messages.forEach(m=>{b.innerHTML+=`<div class="${m.s==='support'?'text-left':'text-right'} mb-2"><span class="inline-block px-3 py-2 rounded-lg text-xs ${m.s==='support'?'bg-slate-900 dark:bg-emerald-600 text-white':'bg-white/10'}">${m.t}</span></div>`});b.scrollTop=9999})};
        window.sendAdminMsg=async()=>{const t=document.getElementById('admin-input').value;if(!t||!state.activeAdminChat)return;document.getElementById('admin-input').value='';const s=await getDocs(query(collection(db,"chats"),where('__name__','==',state.activeAdminChat)));const m=s.docs[0].data().messages;m.push({s:'support',t,d:new Date()});await updateDoc(doc(db,"chats",state.activeAdminChat),{messages:m,status:'active'})};
        window.kickUser=async()=>{if(confirm("ุฅููุงุกุ")){await updateDoc(doc(db,"chats",state.activeAdminChat),{status:'closed'});document.getElementById('admin-msg-area').innerHTML='';document.getElementById('btn-end-chat').classList.add('hidden');state.activeAdminChat=null}};

        if ('serviceWorker' in navigator) {
            const swCode = `const CACHE_NAME = 'souq-cache-v1'; const ASSETS = ['./', 'https://cdn.tailwindcss.com', 'https://unpkg.com/lucide@latest', 'https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800&display=swap']; self.addEventListener('install', e => e.waitUntil(caches.open(CACHE_NAME).then(c => c.addAll(ASSETS)))); self.addEventListener('fetch', e => { e.respondWith(caches.match(e.request).then(r => r || fetch(e.request))); });`;
            const blob = new Blob([swCode], {type: 'application/javascript'}); const swUrl = URL.createObjectURL(blob); navigator.serviceWorker.register(swUrl).catch(e => console.log(e));
        }
        lucide.createIcons();
    </script>
</body>
</html>
