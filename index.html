<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">

    <!-- PWA Settings -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/609/609803.png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Meta Tags -->
    <meta property="og:title" content="Ø§Ù„Ø³ÙˆÙ‚ ÙˆÙŠØ§Ùƒ">
    <meta property="og:description" content="Ø¹Ù‚Ø§Ø±Ø§Øª Ù…ØµØ±">
    <meta property="og:image" content="https://images.pexels.com/photos/19213018/pexels-photo-19213018.jpeg?auto=compress&cs=tinysrgb&w=512&h=512&dpr=1">
    <meta property="og:type" content="website">

    <title>Ø§Ù„Ø³ÙˆÙ‚ ÙˆÙŠØ§Ùƒ | Ø¹Ù‚Ø§Ø±Ø§Øª Ù…ØµØ±</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { 
                extend: { 
                    colors: { navy: '#0f172a', darkbg: '#1e293b', brand: '#10b981' },
                    fontFamily: { sans: ['Cairo', 'sans-serif'] },
                    screens: { 'xs': '400px' }
                } 
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        html { background-color: #0f172a; }
        body { 
            font-family: 'Cairo', sans-serif; 
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
            background-color: transparent;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .select-none { user-select: none; }

        /* --- Fixed Background Optimization (LVH Fix) --- */
        #app-background {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100vh; /* Fallback */
            height: 100lvh; /* Largest Viewport Height */
            z-index: -50;
            background-image: url('https://images.pexels.com/photos/19213018/pexels-photo-19213018.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1');
            background-size: cover; 
            background-position: center; 
            background-repeat: no-repeat;
            pointer-events: none; 
            will-change: transform;
            transform: translate3d(0,0,0);
        }

/* Overlay */
#app-background::after {
    content: ''; 
    position: absolute; 
    inset: 0;
    /* Ù‚Ù„Ù„Ù†Ø§ Ø§Ù„Ø´ÙØ§ÙÙŠØ© Ù…Ù† 0.55 Ù„Ù€ 0.1 Ø¹Ø´Ø§Ù† Ø§Ù„Ø·Ø¨Ù‚Ø© Ø§Ù„Ø¨ÙŠØ¶Ø§ ØªØ®Ù */
    background: rgba(241, 245, 249, 0.15); 
    /* Ù‚Ù„Ù„Ù†Ø§ Ø§Ù„Ø¶Ø¨Ø§Ø¨ Ù…Ù† 2px Ù„Ù€ 0.5px Ø¹Ø´Ø§Ù† ÙŠØ¨Ù‚Ù‰ Ø´Ø¨Ù‡ Ù…Ø®ØªÙÙŠ */
    backdrop-filter: blur(0.5px); 
    transition: background-color 0.3s ease;
}

.dark #app-background::after { 
    /* Ù‚Ù„Ù„Ù†Ø§ Ø§Ù„Ø´ÙØ§ÙÙŠØ© Ù…Ù† 0.40 Ù„Ù€ 0.1 Ø¹Ø´Ø§Ù† Ø§Ù„Ø·Ø¨Ù‚Ø© Ø§Ù„Ø³ÙˆØ¯Ø§ ØªØ®Ù */
    background: rgba(15, 23, 42, 0.15); 
}

        /* Animations */
        @keyframes shimmer { 0% { background-position: -1000px 0; } 100% { background-position: 1000px 0; } }
        .skeleton { animation: shimmer 1.5s infinite linear; background: linear-gradient(to right, #f1f5f9 4%, #e2e8f0 25%, #f1f5f9 36%); background-size: 1000px 100%; }
        .dark .skeleton { background: linear-gradient(to right, #1e293b 4%, #334155 25%, #1e293b 36%); }

        @keyframes popIn { from { transform: scale(0.98); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .animate-pop { animation: popIn 0.1s ease-out forwards; will-change: transform, opacity; }

        .mobile-full-modal { position: fixed; inset: 0; z-index: 60; background-color: white; display: flex; flex-direction: column; height: 100dvh; }
        .dark .mobile-full-modal { background-color: #1e293b; }
        @media (min-width: 768px) { 
            .mobile-full-modal { position: relative; inset: auto; width: 100%; max-width: 32rem; height: 750px; max-height: 90vh; border-radius: 1.5rem; overflow: hidden; } 
            .modal-overlay { position: fixed; inset: 0; z-index: 60; background-color: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; padding: 1rem; } 
        }

        @keyframes slideInDown { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        .toast { animation: slideInDown 0.2s ease-out forwards; }
        .toast.hiding { animation: fadeOut 0.2s ease-in forwards; }

        .sticky-header { 
            z-index: 50; 
            transform: translateZ(0); 
            transition: background-color 0.2s ease;
            border-bottom-left-radius: 1.5rem;
            border-bottom-right-radius: 1.5rem;
        }

        /* Splash Screen */
        #splash-screen { 
            position: fixed; inset: 0; z-index: 10000; background-color: #0f172a;
            background-image: linear-gradient(rgba(15, 23, 42, 0.40), rgba(15, 23, 42, 0.60)), url('https://images.pexels.com/photos/19213018/pexels-photo-19213018.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1');
            background-size: cover; background-position: center;
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            transition: opacity 0.3s ease-out, visibility 0.3s; 
        }
        .splash-icon-container { position: relative; width: 80px; height: 80px; display: flex; justify-content: center; align-items: center; }
        .splash-ring { position: absolute; inset: 0; border-radius: 50%; border: 2px solid rgba(16, 185, 129, 0.3); border-top-color: #10b981; animation: spin 1s infinite linear; }
        .splash-logo { color: white; z-index: 10; animation: pulse 2s infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes pulse { 50% { transform: scale(0.9); opacity: 0.8; } }
        .hidden-splash { opacity: 0; visibility: hidden; pointer-events: none; }

        body:not(.app-loaded) #app-content-wrapper { opacity: 0; visibility: hidden; }
        #app-content-wrapper { transition: opacity 0.4s ease-in-out; opacity: 1; }

        .input-box {
            width: 100%; background: white; border: 1px solid #000000; border-radius: 0.4rem;
            padding: 0.4rem 0.5rem; font-size: 0.8rem; font-weight: 700; outline: none; color: #0f172a; transition: border-color 0.2s;
        }
        .dark .input-box { background: #1e293b; border-color: #94a3b8; color: white; }
        .input-box:focus { border-color: #10b981; box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2); }
        .input-box::placeholder { color: #64748b; font-weight: 500; font-size: 0.75rem; }

        .custom-select-wrapper { position: relative; }
        .custom-select {
            appearance: none; background-color: #f8fafc; border: 1px solid #000; border-radius: 0.4rem;
            padding: 0.4rem 1.5rem 0.4rem 0.5rem; width: 100%; font-weight: 700; font-size: 0.75rem; color: #334155; cursor: pointer;
        }
        .dark .custom-select { background-color: #1e293b; color: white; border-color: #94a3b8; }
        .custom-select-icon { position: absolute; left: 0.5rem; top: 50%; transform: translateY(-50%); pointer-events: none; color: #64748b; width: 0.8rem; height: 0.8rem; }

        .modern-table { border-collapse: collapse; width: 100%; }
        .modern-table td, .modern-table th { padding: 0.4rem; border-bottom: 1px solid #e2e8f0; }
        .dark .modern-table td, .dark .modern-table th { border-color: #334155; }
        .modern-table tr:nth-child(even) { background-color: #f8fafc; }
        .dark .modern-table tr:nth-child(even) { background-color: #1e293b; }

        .amenity-tile input:checked + div { background-color: #10b981; color: white; border-color: #10b981; }

        #filter-panel { transition: max-height 0.2s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.15s; max-height: 0; opacity: 0; overflow: hidden; will-change: max-height, opacity; }
        #filter-panel.open { max-height: 450px; opacity: 1; }

        body.keyboard-open #bottom-nav { display: none; }
    </style>
</head>
<body class="text-slate-800 dark:text-slate-100 select-none">

    <!-- Splash Screen -->
    <div id="splash-screen">
        <div class="splash-icon-container">
            <div class="splash-ring"></div>
            <svg class="splash-logo" xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline><circle cx="12" cy="7" r="2" fill="#10b981" stroke="none"></circle></svg>
        </div>
        <div class="mt-4 text-white font-bold text-lg tracking-wide">Ø§Ù„Ø³ÙˆÙ‚ <span class="text-emerald-500">ÙˆÙŠØ§Ùƒ</span></div>
    </div>

    <!-- Wrapper -->
    <div id="app-content-wrapper">
        <div id="app-background"></div>

        <div id="toast-container" class="fixed top-4 left-0 right-0 z-[100] flex flex-col items-center gap-2 pointer-events-none px-4"></div>

        <!-- Header -->
        <header class="fixed top-0 w-full sticky-header bg-white/95 dark:bg-navy/95 backdrop-blur-none flex items-center justify-between px-4 h-12 shadow-md z-50">
            <div class="flex flex-col justify-center">
                <span class="text-[9px] font-bold text-slate-500 dark:text-slate-400 leading-none">Ù…Ø±Ø­Ø¨Ø§ Ø¨ÙƒÙ… ÙÙŠ</span>
                <span class="text-[10px] font-black text-slate-800 dark:text-white leading-tight">Ø³ÙˆÙ‚ <span class="text-emerald-600 dark:text-emerald-400">Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª</span></span>
            </div>

            <!-- Logo Updated: Circular Black Frame, Dark Gold Border in Dark Mode -->
            <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 flex flex-col items-center cursor-pointer group" id="logo-trigger">
                <div class="w-10 h-10 flex items-center justify-center bg-slate-900 text-white rounded-full border-2 border-slate-900 dark:border-[#B8860B] shadow-lg group-hover:scale-110 transition-all duration-300">
                    <i data-lucide="building-2" class="w-5 h-5"></i>
                </div>
            </div>

            <div class="flex gap-1.5 items-center">
                <a href="https://wa.me/201206244875" target="_blank" class="p-1.5 rounded-full bg-green-50 dark:bg-green-900/20 text-green-600 dark:text-green-400 hover:bg-green-100 border border-green-100 dark:border-green-900/50 transition shadow-sm"><i data-lucide="message-circle" class="w-3.5 h-3.5"></i></a>
                <button onclick="toggleDarkMode()" class="p-1.5 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-yellow-400 hover:bg-slate-200 transition"><i data-lucide="moon" class="w-3.5 h-3.5 block dark:hidden"></i><i data-lucide="sun" class="w-3.5 h-3.5 hidden dark:block"></i></button>
                <button onclick="toggleAdminPanel()" id="btn-admin-top" class="hidden bg-slate-100 dark:bg-slate-800 p-1.5 rounded-full text-slate-600 dark:text-white"><i data-lucide="shield" class="w-3.5 h-3.5"></i></button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="pt-[3.5rem] pb-20 container mx-auto px-2 max-w-5xl min-h-screen">
            <div class="sticky top-12 z-40 space-y-1 pointer-events-none mb-1">
                <div class="relative px-1 pt-2 pb-1 bg-slate-50/95 dark:bg-navy/95 rounded-b-xl shadow-sm pointer-events-auto transform-gpu border-t-0 border-x border-b border-slate-100 dark:border-slate-700">
                    <div class="relative w-full px-1">
                        <button onclick="toggleFilterPanel()" class="absolute left-1 top-0 h-full w-9 flex items-center justify-center text-slate-500 hover:text-slate-800 dark:hover:text-white transition z-10"><i data-lucide="sliders-horizontal" class="w-4 h-4"></i></button>
                        <input type="text" id="search-input" placeholder="Ø§Ø¨Ø­Ø« (Ø´Ù‚Ø©ØŒ Ø£Ø±Ø¶ØŒ Ø¹Ù†ÙˆØ§Ù†)..." class="w-full bg-white dark:bg-darkbg border border-black dark:border-slate-500 rounded-lg pl-10 pr-9 py-1 text-xs shadow-sm focus:ring-1 focus:ring-emerald-500 outline-none dark:text-white transition font-bold h-8">
                        <button onclick="performSearch()" class="absolute right-1 top-0 h-full w-9 flex items-center justify-center text-slate-500 hover:text-emerald-600 transition"><i data-lucide="search" class="w-4 h-4"></i></button>
                    </div>
                    <div id="filter-panel" class="mt-1 bg-white dark:bg-slate-800 rounded-lg border border-black dark:border-slate-600 shadow-lg mx-1">
                        <div class="p-2 space-y-1.5">
                            <div class="flex justify-between items-center border-b border-slate-100 dark:border-slate-700 pb-1">
                                <h3 class="text-[10px] font-bold text-slate-700 dark:text-white flex items-center gap-1"><i data-lucide="filter" class="w-3 h-3"></i> ØªØµÙÙŠØ©</h3>
                                <button onclick="resetFilters()" class="text-[9px] text-red-500 font-bold underline">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
                            </div>
                            <div class="custom-select-wrapper">
                                <select id="filter-type" class="custom-select py-1 text-[10px]">
                                    <option value="">ÙƒÙ„ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹ (Ø¨ÙŠØ¹/Ø¥ÙŠØ¬Ø§Ø±)</option>
                                    <option value="sale">Ø¨ÙŠØ¹</option>
                                    <option value="rent">Ø¥ÙŠØ¬Ø§Ø±</option>
                                </select>
                                <i data-lucide="chevron-down" class="custom-select-icon w-3 h-3"></i>
                            </div>
                            <div class="grid grid-cols-2 gap-1.5">
                                <div class="custom-select-wrapper">
                                    <select id="filter-gov" onchange="populateCities('filter-gov', 'filter-city')" class="custom-select py-1 text-[10px]"><option value="">ÙƒÙ„ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª</option></select>
                                    <i data-lucide="chevron-down" class="custom-select-icon w-3 h-3"></i>
                                </div>
                                <div class="custom-select-wrapper">
                                    <select id="filter-city" class="custom-select py-1 text-[10px]"><option value="">ÙƒÙ„ Ø§Ù„Ù…Ø±Ø§ÙƒØ²</option></select>
                                    <i data-lucide="chevron-down" class="custom-select-icon w-3 h-3"></i>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-1.5">
                                <input type="number" id="filter-min-price" placeholder="Ø£Ù‚Ù„ Ø³Ø¹Ø±" class="input-box text-[10px] py-1">
                                <input type="number" id="filter-max-price" placeholder="Ø£Ø¹Ù„Ù‰ Ø³Ø¹Ø±" class="input-box text-[10px] py-1">
                            </div>
                            <div class="flex gap-2">
                                <button onclick="performSearch(); toggleFilterPanel()" class="flex-1 bg-emerald-600 text-white py-1.5 rounded font-bold text-[10px] shadow hover:bg-emerald-700 transition">ØªØ·Ø¨ÙŠÙ‚</button>
                                <button onclick="toggleFilterPanel()" class="w-16 bg-red-500 text-white py-1.5 rounded font-bold text-[10px] shadow hover:bg-red-600 transition flex items-center justify-center"><i data-lucide="x" class="w-3 h-3"></i> Ø¥ØºÙ„Ø§Ù‚</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="grid-container" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 mt-2"></div>

            <div id="load-more-container" class="hidden mt-4 text-center">
                <button onclick="loadMore()" class="bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-200 px-6 py-2 rounded-full text-xs font-bold shadow-sm hover:bg-slate-50 dark:hover:bg-slate-700 transition">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯</button>
            </div>

            <div id="empty-state" class="hidden text-center py-16 opacity-60 flex flex-col items-center">
                <div class="bg-slate-200 dark:bg-slate-700 p-3 rounded-full inline-block mb-2"><i data-lucide="search-x" class="w-6 h-6 text-slate-400"></i></div>
                <p class="text-slate-500 dark:text-slate-400 font-bold text-xs">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</p>
                <button onclick="resetFilters()" class="mt-1 text-emerald-600 dark:text-emerald-400 text-[10px] font-bold underline">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</button>
            </div>
        </main>

        <!-- Floating Dock -->
        <nav id="bottom-nav" class="fixed bottom-4 left-1/2 -translate-x-1/2 z-50 bg-white/90 dark:bg-slate-800/90 backdrop-blur-lg border border-slate-200 dark:border-slate-600 px-5 py-1.5 rounded-full flex items-center gap-6 shadow-xl transform transition-all hover:scale-105 transform-gpu">
            <button onclick="resetFilters(); window.scrollTo({top:0, behavior:'smooth'})" class="flex flex-col items-center gap-0.5 text-slate-500 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white transition group"><i data-lucide="home" class="w-5 h-5 group-hover:scale-110 transition"></i></button>
            <button onclick="toggleAddModal()" class="w-12 h-12 bg-slate-900 dark:bg-emerald-600 text-white rounded-full flex items-center justify-center shadow-lg shadow-slate-900/20 transform -translate-y-5 border-4 border-[#f8fafc] dark:border-navy hover:scale-110 transition active:scale-90"><i data-lucide="plus" class="w-6 h-6"></i></button>
            <button onclick="toggleChat()" class="flex flex-col items-center gap-0.5 text-slate-500 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white transition group relative"><div id="chat-badge" class="hidden absolute top-0 right-0 w-2 h-2 bg-red-500 rounded-full border border-white dark:border-slate-800"></div><i data-lucide="message-circle" class="w-5 h-5 group-hover:scale-110 transition"></i></button>
        </nav>
    </div>

    <!-- Details Modal -->
    <div id="details-modal" class="hidden modal-overlay">
        <div class="mobile-full-modal animate-pop">
            <div class="relative h-44 bg-gray-200 dark:bg-slate-800 shrink-0 group">
                <button onclick="closeDetails()" class="absolute top-2 left-2 bg-red-500 text-black p-1 rounded-full z-20 shadow-sm hover:bg-red-600 transition"><i data-lucide="x" class="w-4 h-4"></i></button>
                <div class="absolute top-2 right-2 flex gap-2 z-20">
                    <button onclick="downloadImages()" class="bg-white/80 dark:bg-black/50 text-slate-800 dark:text-white p-1 rounded-full shadow-sm"><i data-lucide="download" class="w-4 h-4"></i></button>
                    <button onclick="shareListing()" class="bg-white/80 dark:bg-black/50 text-slate-800 dark:text-white p-1 rounded-full shadow-sm"><i data-lucide="share-2" class="w-4 h-4"></i></button>
                </div>
                <div id="details-slider" class="flex w-full h-full overflow-x-auto no-scrollbar snap-x scroll-smooth"></div>
                <div id="details-arrows"><button onclick="scrollDetails(1)" class="absolute left-2 top-1/2 -translate-y-1/2 bg-black/30 text-white p-1 rounded-full z-10"><i data-lucide="chevron-left" class="w-4 h-4"></i></button><button onclick="scrollDetails(-1)" class="absolute right-2 top-1/2 -translate-y-1/2 bg-black/30 text-white p-1 rounded-full z-10"><i data-lucide="chevron-right" class="w-4 h-4"></i></button></div>
                <span id="d-type-badge" class="absolute bottom-2 right-2 text-white px-2 py-0.5 rounded text-[10px] font-bold shadow backdrop-blur-sm"></span>
            </div>
            <div class="flex-1 overflow-y-auto bg-white dark:bg-darkbg">
                <div id="d-controls" class="hidden p-2 bg-slate-50 dark:bg-slate-800 border-b dark:border-slate-700 flex gap-2 justify-end"></div>
                <div class="p-2 space-y-2">
                    <div class="space-y-1">
                        <div><span class="text-[9px] font-bold text-slate-400 block mb-0">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠ</span><h2 id="d-title" class="text-sm font-bold text-slate-900 dark:text-white leading-tight"></h2></div>
                        <div class="flex items-center justify-between border-b border-slate-100 dark:border-slate-700 pb-1">
                            <div><span class="text-[9px] font-bold text-slate-400 block mb-0">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</span><span id="d-price" class="text-emerald-600 dark:text-emerald-400 font-black text-lg"></span></div>
                            <span id="d-time-badge" class="text-[9px] text-slate-400 font-medium bg-slate-100 dark:bg-slate-800 px-2 py-0.5 rounded-full"></span>
                        </div>
                    </div>
                    <div class="border border-slate-200 dark:border-slate-700 rounded-lg overflow-hidden">
                        <table class="w-full text-[10px] modern-table"><tbody id="d-table-body"></tbody></table>
                    </div>
                    <div>
                        <h3 class="text-[10px] font-bold text-slate-900 dark:text-white mb-1 flex items-center gap-1"><i data-lucide="sparkles" class="w-3 h-3 text-yellow-500"></i> Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª</h3>
                        <div id="d-amenities" class="grid grid-cols-3 gap-0 border border-slate-200 dark:border-slate-700 rounded-lg overflow-hidden bg-slate-50 dark:bg-slate-800/50"></div>
                    </div>
                    <div class="bg-slate-50 dark:bg-slate-800/50 p-2 rounded-lg border border-slate-200 dark:border-slate-700"><h3 class="text-[9px] font-bold text-slate-400 uppercase mb-0.5">Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙƒØ§Ù…Ù„Ø©</h3><p id="d-desc" class="text-[10px] text-slate-700 dark:text-slate-300 leading-snug whitespace-pre-wrap font-medium"></p></div>
                </div>
            </div>
            <div class="p-2 border-t border-slate-100 dark:border-slate-700 bg-white dark:bg-darkbg flex flex-col gap-2 shrink-0 pb-6 md:pb-2">
                <a id="d-map" href="#" target="_blank" class="hidden w-full bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 py-2 rounded-lg flex justify-center items-center gap-2 font-bold text-[10px] border border-blue-100 dark:border-blue-800 hover:bg-blue-100 transition"><i data-lucide="map" class="w-3 h-3"></i> Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</a>
                <div class="flex gap-2"><a id="d-wa" href="#" target="_blank" class="flex-1 bg-[#25D366] text-white py-2.5 rounded-lg flex justify-center items-center gap-2 font-bold shadow-lg hover:opacity-90 transition text-[10px]"><i data-lucide="message-circle" class="w-4 h-4"></i> ÙˆØ§ØªØ³Ø§Ø¨</a><a id="d-call" href="#" class="flex-1 bg-slate-900 dark:bg-slate-700 text-white py-2.5 rounded-lg flex justify-center items-center gap-2 font-bold shadow-lg hover:opacity-90 transition text-[10px]"><i data-lucide="phone" class="w-4 h-4"></i> Ø§ØªØµØ§Ù„</a></div>
            </div>
        </div>
    </div>

    <!-- Add Modal -->
    <div id="add-modal" class="hidden modal-overlay">
        <div class="mobile-full-modal animate-pop">
            <div class="p-2.5 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-white dark:bg-darkbg shrink-0">
                <h3 class="font-bold text-slate-800 dark:text-white text-sm">Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø§Ø±</h3>
                <button onclick="toggleAddModal()" class="bg-red-500 text-black p-1 rounded-full hover:bg-red-600 transition"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-2.5 bg-slate-50 dark:bg-darkbg">
                <div class="space-y-2.5">
                    <div class="bg-white dark:bg-slate-800 p-2.5 rounded-lg border border-black dark:border-slate-500 shadow-sm">
                        <label class="block text-[10px] font-bold text-slate-700 dark:text-slate-300 mb-1.5">ØµÙˆØ± ÙˆÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø± <span class="text-red-500">*</span></label>
                        <div class="grid grid-cols-4 gap-1.5">
                            <label class="aspect-square border-2 border-dashed border-emerald-300 dark:border-emerald-700 bg-emerald-50 dark:bg-emerald-900/20 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:bg-emerald-100 transition text-emerald-600 dark:text-emerald-400 relative overflow-hidden">
                                <input type="file" multiple accept="image/*,video/*" onchange="handleUpload(this)" class="absolute inset-0 opacity-0 z-10"><i data-lucide="camera" class="w-4 h-4 mb-0.5"></i><span class="text-[8px] font-bold">Ø¥Ø¶Ø§ÙØ©</span>
                            </label>
                            <div id="preview-area" class="col-span-3 flex gap-1.5 overflow-x-auto no-scrollbar py-0.5"></div>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-slate-800 p-2.5 rounded-lg border border-black dark:border-slate-500 shadow-sm space-y-1.5">
                        <h4 class="text-[9px] font-bold text-slate-400 uppercase tracking-wider border-b border-slate-100 dark:border-slate-700 pb-0.5 mb-0.5">Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ©</h4>
                        <div class="flex gap-1.5">
                            <div class="custom-select-wrapper flex-1">
                                <select id="in-category" onchange="updateFormFields()" class="custom-select">
                                    <option value="apartment">Ø´Ù‚Ø©</option><option value="villa">ÙÙŠÙ„Ø§</option><option value="chalet">Ø´Ø§Ù„ÙŠØ©</option><option value="office">Ù…ÙƒØªØ¨</option><option value="shop">Ù…Ø­Ù„</option><option value="land">Ø£Ø±Ø¶</option><option value="building">Ø¹Ù…Ø§Ø±Ø©</option><option value="warehouse">Ù…Ø®Ø²Ù†</option>
                                </select>
                                <i data-lucide="chevron-down" class="custom-select-icon w-3 h-3"></i>
                            </div>
                            <div class="custom-select-wrapper w-20 shrink-0">
                                <select id="in-type" class="custom-select"><option value="sale">Ø¨ÙŠØ¹</option><option value="rent">Ø¥ÙŠØ¬Ø§Ø±</option></select>
                                <i data-lucide="chevron-down" class="custom-select-icon w-3 h-3"></i>
                            </div>
                        </div>
                        <input id="in-title" class="input-box" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†">
                        <input id="in-price" type="number" class="input-box" placeholder="Ø§Ù„Ø³Ø¹Ø± (Ø¬Ù†ÙŠÙ‡)">

                        <div class="grid grid-cols-2 gap-1.5">
                            <input id="in-area" type="number" class="input-box" placeholder="Ø§Ù„Ù…Ø³Ø§Ø­Ø© (Ù…Â²)">
                            <input id="in-level" type="text" class="input-box" placeholder="Ø§Ù„Ø¯ÙˆØ±">
                            <input id="in-floors-alt" type="number" class="input-box hidden" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±">
                            <div id="land-type-wrapper" class="hidden custom-select-wrapper">
                                <select id="in-land-type" class="custom-select">
                                    <option value="building">Ù…Ø¨Ø§Ù†ÙŠ</option>
                                    <option value="agriculture">Ø²Ø±Ø§Ø¹ÙŠØ©</option>
                                </select>
                                <i data-lucide="chevron-down" class="custom-select-icon w-3 h-3"></i>
                            </div>
                        </div>

                        <div id="land-fields" class="hidden grid grid-cols-2 gap-1.5">
                            <input id="in-feddan" type="number" class="input-box" placeholder="ÙØ¯Ø§Ù† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
                            <input id="in-qirat" type="number" class="input-box" placeholder="Ù‚ÙŠØ±Ø§Ø· (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
                        </div>

                        <div id="building-fields" class="hidden grid grid-cols-2 gap-1.5">
                            <input id="in-apartments" type="number" class="input-box" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø´Ù‚Ù‚">
                        </div>

                        <div id="room-fields" class="grid grid-cols-2 gap-1.5">
                            <input id="in-rooms" type="number" class="input-box" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„ØºØ±Ù">
                            <input id="in-baths" type="number" class="input-box" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ù…Ø§Ù…Ø§Øª">
                        </div>

                        <div id="extra-fields" class="grid grid-cols-2 gap-1.5">
                            <input id="in-balconies" type="number" class="input-box" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø¨Ù„ÙƒÙˆÙ†Ø§Øª">
                            <div class="custom-select-wrapper">
                                <select id="in-finishing" class="custom-select">
                                    <option value="" disabled selected>Ù†ÙˆØ¹ Ø§Ù„ØªØ´Ø·ÙŠØ¨</option>
                                    <option value="red">Ø·ÙˆØ¨ Ø£Ø­Ù…Ø±</option>
                                    <option value="semi">Ù†ØµÙ ØªØ´Ø·ÙŠØ¨</option>
                                    <option value="full">ØªØ´Ø·ÙŠØ¨ ÙƒØ§Ù…Ù„</option>
                                    <option value="super">Ø³ÙˆØ¨Ø± Ù„ÙˆÙƒØ³</option>
                                    <option value="ultra">Ø§Ù„ØªØ±Ø§ Ø³ÙˆØ¨Ø± Ù„ÙˆÙƒØ³</option>
                                </select>
                                <i data-lucide="chevron-down" class="custom-select-icon w-3 h-3"></i>
                            </div>
                        </div>

                        <div id="furnished-field" class="flex items-center justify-between bg-slate-50 dark:bg-slate-700/50 p-1.5 rounded-lg border border-black dark:border-slate-500">
                            <span class="text-[10px] font-bold text-slate-600 dark:text-slate-300">Ù…ÙØ±ÙˆØ´ØŸ</span>
                            <div class="flex gap-1.5">
                                <label class="cursor-pointer"><input type="radio" name="furnished" value="yes" class="peer hidden"><span class="px-2 py-0.5 rounded text-[9px] font-bold bg-white dark:bg-slate-600 border border-slate-200 dark:border-slate-500 text-slate-500 peer-checked:bg-emerald-500 peer-checked:text-white peer-checked:border-emerald-500 transition">Ù†Ø¹Ù…</span></label>
                                <label class="cursor-pointer"><input type="radio" name="furnished" value="no" checked class="peer hidden"><span class="px-2 py-0.5 rounded text-[9px] font-bold bg-white dark:bg-slate-600 border border-slate-200 dark:border-slate-500 text-slate-500 peer-checked:bg-slate-800 peer-checked:text-white peer-checked:border-slate-800 transition">Ù„Ø§</span></label>
                            </div>
                        </div>

                        <div class="flex gap-2 items-center pt-0.5">
                            <span class="text-[10px] font-bold text-slate-600 dark:text-slate-400">Ø´Ø§Ø±Ø©:</span>
                            <div class="flex gap-1.5">
                                <label class="cursor-pointer amenity-tile"><input type="radio" name="badge" value="none" checked class="hidden"><div class="px-2 py-0.5 rounded border border-slate-200 dark:border-slate-600 text-[9px] font-bold text-slate-600 dark:text-slate-300 transition">Ø¹Ø§Ø¯ÙŠ</div></label>
                                <label class="cursor-pointer amenity-tile"><input type="radio" name="badge" value="hot" class="hidden"><div class="px-2 py-0.5 rounded border border-orange-200 text-[9px] font-bold text-orange-600 transition hover:bg-orange-50">ğŸ”¥ Ù„Ù‚Ø·Ø©</div></label>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-slate-800 p-2.5 rounded-lg border border-black dark:border-slate-500 shadow-sm space-y-1.5">
                        <h4 class="text-[9px] font-bold text-slate-400 uppercase tracking-wider border-b border-slate-100 dark:border-slate-700 pb-0.5 mb-0.5">Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª</h4>
                        <div class="grid grid-cols-4 gap-1" id="amenities-grid"></div>
                        <textarea id="in-desc" rows="2" class="input-box resize-none" placeholder="ÙˆØµÙ ØªÙØµÙŠÙ„ÙŠ..."></textarea>
                    </div>

                    <div class="bg-white dark:bg-slate-800 p-2.5 rounded-lg border border-black dark:border-slate-500 shadow-sm space-y-1.5">
                        <h4 class="text-[9px] font-bold text-slate-400 uppercase tracking-wider border-b border-slate-100 dark:border-slate-700 pb-0.5 mb-0.5">Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØ§Ù„ØªÙˆØ§ØµÙ„</h4>
                        <input id="in-address" class="input-box mb-1.5" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„ØªÙØµÙŠÙ„ (Ø§Ø³Ù… Ø§Ù„Ø´Ø§Ø±Ø¹ØŒ Ø¹Ù„Ø§Ù…Ø© Ù…Ù…ÙŠØ²Ø©)...">
                        <div class="grid grid-cols-2 gap-1.5">
                            <div class="custom-select-wrapper">
                                <select id="in-gov" onchange="populateCities('in-gov', 'in-city')" class="custom-select"><option value="" disabled selected>Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</option></select>
                                <i data-lucide="chevron-down" class="custom-select-icon w-3 h-3"></i>
                            </div>
                            <div class="custom-select-wrapper">
                                <select id="in-city" class="custom-select"><option value="" disabled selected>Ø§Ù„Ù…Ø±ÙƒØ²/Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</option></select>
                                <i data-lucide="chevron-down" class="custom-select-icon w-3 h-3"></i>
                            </div>
                        </div>
                        <input id="in-map" class="input-box" placeholder="Ø±Ø§Ø¨Ø· Ø¬ÙˆØ¬Ù„ Ù…Ø§Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
                        <input id="in-phone" type="tel" class="input-box" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
                    </div>
                </div>
            </div>
            <div class="p-2.5 border-t border-slate-100 dark:border-slate-700 bg-white dark:bg-darkbg shrink-0 pb-6 md:pb-3">
                <button onclick="submitListing()" id="btn-publish" class="w-full bg-slate-900 dark:bg-emerald-600 text-white py-2.5 rounded-lg font-bold text-xs shadow-lg hover:opacity-90 transition transform active:scale-95">Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</button>
            </div>
        </div>
    </div>

    <!-- Chat & Lightbox & Admin -->
    <div id="chat-modal" class="hidden modal-overlay"><div class="mobile-full-modal animate-pop border border-navy/10"><div class="bg-slate-900 dark:bg-emerald-600 p-3 text-white flex justify-between items-center shrink-0"><div class="flex items-center gap-2"><div class="bg-white/10 p-1.5 rounded-full"><i data-lucide="bot" class="w-5 h-5 text-yellow-400"></i></div><div><h4 class="font-bold text-xs">Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ</h4><span class="text-[9px] opacity-80">Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†</span></div></div><button onclick="toggleChat()" class="bg-red-500 text-black p-1 rounded-full hover:bg-red-600 transition"><i data-lucide="x" class="w-4 h-4"></i></button></div><div id="chat-box" class="flex-1 bg-slate-100 dark:bg-slate-900 p-3 overflow-y-auto space-y-2 text-xs"></div><div class="p-3 bg-white dark:bg-slate-800 border-t dark:border-slate-700 flex items-center gap-2 shrink-0 pb-safe"><input id="chat-msg" type="text" class="flex-1 bg-slate-100 dark:bg-slate-700 border-0 rounded-full px-4 py-3 text-sm outline-none dark:text-white font-bold" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..."><button onclick="sendMsg()" class="w-10 h-10 bg-slate-900 dark:bg-emerald-600 rounded-full text-white flex items-center justify-center shadow"><i data-lucide="send" class="w-4 h-4"></i></button></div></div></div>
    <div id="lightbox" class="hidden fixed inset-0 bg-black/95 z-[100] flex flex-col items-center justify-center select-none"><button onclick="closeLightbox()" class="absolute top-4 left-4 bg-white/20 text-white p-2 rounded-full z-20"><i data-lucide="x" class="w-6 h-6"></i></button><div class="relative w-full h-full flex items-center justify-center"><img id="lightbox-img" src="" class="max-w-full max-h-[80vh] object-contain"></div></div>
    <div id="admin-panel" class="hidden fixed inset-0 bg-navy z-[90] flex flex-col text-white"><div class="p-3 border-b border-white/10 flex justify-between items-center bg-[#001a38]"><h2 class="font-bold flex items-center gap-2 text-sm"><i data-lucide="shield" class="w-4 h-4 text-emerald-400"></i> Ø§Ù„ØªØ­ÙƒÙ…</h2><div class="flex gap-3"><button onclick="refreshAdmin()"><i data-lucide="refresh-cw" class="w-4 h-4"></i></button><button onclick="toggleAdminPanel()"><i data-lucide="x" class="w-5 h-5"></i></button></div></div><div class="flex-1 flex overflow-hidden"><div class="w-1/3 border-l border-white/10 bg-[#001f3f] overflow-y-auto p-2" id="admin-users-list"></div><div class="w-2/3 flex flex-col bg-navy relative"><div id="admin-chat-header" class="h-12 border-b border-white/10 flex items-center justify-between px-3 bg-[#001a38]"><span class="text-xs font-bold">Ø§Ø®ØªØ± Ù…Ø­Ø§Ø¯Ø«Ø©</span><button onclick="kickUser()" id="btn-end-chat" class="hidden bg-red-600 text-white text-[10px] font-bold px-2 py-1 rounded flex items-center gap-1"><i data-lucide="slash" class="w-3 h-3"></i> Ø¥Ù†Ù‡Ø§Ø¡</button></div><div id="admin-msg-area" class="flex-1 p-3 overflow-y-auto space-y-2 text-xs"></div><div class="p-2 border-t border-white/10 flex gap-2 bg-[#001a38]"><input id="admin-input" class="flex-1 bg-white/5 border border-white/20 rounded px-3 py-1.5 text-xs text-white outline-none" placeholder="Ø§Ù„Ø±Ø¯..."><button onclick="sendAdminMsg()" class="bg-blue-600 px-4 py-1.5 rounded text-xs font-bold">Ø¥Ø±Ø³Ø§Ù„</button></div></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, setPersistence, browserLocalPersistence, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyC7zHuH8LK-yQAKG-Nm7dh31fXtVLxuCLM", authDomain: "sharqia-81030.firebaseapp.com", projectId: "sharqia-81030", storageBucket: "sharqia-81030.firebasestorage.app", messagingSenderId: "581888625195", appId: "1:581888625195:web:1667ba1e439e8e6c1fb86e" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app); const auth = getAuth(app);

        const COLLECTION_NAME = "listings_v2"; 

        let state = { user: null, listings: [], filesToUpload: [], chatId: null, chatStep: 0, tempName: '', activeAdminChat: null, isAdmin: false, welcomeSent: false, currentFilter: 'all', visibleLimit: 12 };

        const ALL_AMENITIES = ["ØºØ§Ø² Ø·Ø¨ÙŠØ¹ÙŠ", "ÙƒÙ‡Ø±Ø¨Ø§Ø¡", "Ù…ÙŠØ§Ù‡", "Ø£Ø³Ø§Ù†Ø³ÙŠØ±", "ÙˆØ§ÙŠ ÙØ§ÙŠ", "Ø­Ù…Ø§Ù… Ø³Ø¨Ø§Ø­Ø©", "Ø­Ø¯ÙŠÙ‚Ø©", "Ø¬Ø±Ø§Ø¬", "Ø£Ù…Ù† ÙˆØ­Ø±Ø§Ø³Ø©", "ÙƒØ§Ù…ÙŠØ±Ø§Øª Ù…Ø±Ø§Ù‚Ø¨Ø©", "Ù…Ø·Ø¨Ø® Ø£Ù…Ø±ÙŠÙƒØ§Ù†ÙŠ", "ØºØ±ÙØ© Ø®Ø§Ø¯Ù…Ø©", "Ù…Ø³Ù…ÙˆØ­ Ø¨Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª", "Ø¹Ù„Ù‰ Ù†Ø§ØµÙŠØ©"];
        const LAND_AMENITIES = ["ÙƒÙ‡Ø±Ø¨Ø§Ø¡", "Ù…ÙŠØ§Ù‡", "ØºØ§Ø² Ø·Ø¨ÙŠØ¹ÙŠ", "Ø¹Ù„Ù‰ Ù†Ø§ØµÙŠØ©"];

        const CAT_MAP = { 'apartment': 'Ø´Ù‚Ø©', 'villa': 'ÙÙŠÙ„Ø§', 'chalet': 'Ø´Ø§Ù„ÙŠØ©', 'office': 'Ù…ÙƒØªØ¨', 'shop': 'Ù…Ø­Ù„', 'land': 'Ø£Ø±Ø¶', 'building': 'Ø¹Ù…Ø§Ø±Ø©', 'warehouse': 'Ù…Ø®Ø²Ù†' };
        const FINISH_MAP = { 'red': 'Ø·ÙˆØ¨ Ø£Ø­Ù…Ø±', 'semi': 'Ù†ØµÙ ØªØ´Ø·ÙŠØ¨', 'full': 'ØªØ´Ø·ÙŠØ¨ ÙƒØ§Ù…Ù„', 'super': 'Ø³ÙˆØ¨Ø± Ù„ÙˆÙƒØ³', 'ultra': 'Ø§Ù„ØªØ±Ø§ Ø³ÙˆØ¨Ø± Ù„ÙˆÙƒØ³' };

        const CAT_KEYWORDS = {
            'Ø´Ù‚Ø©': 'apartment', 'Ø´Ù‚Ù‚': 'apartment',
            'ÙÙŠÙ„Ø§': 'villa', 'ÙÙ„Ù„': 'villa',
            'Ø´Ø§Ù„ÙŠØ©': 'chalet', 'Ø´Ø§Ù„ÙŠÙ‡Ø§Øª': 'chalet',
            'Ù…ÙƒØªØ¨': 'office', 'Ù…ÙƒØ§ØªØ¨': 'office',
            'Ù…Ø­Ù„': 'shop', 'Ù…Ø­Ù„Ø§Øª': 'shop',
            'Ø§Ø±Ø¶': 'land', 'Ø§Ø±Ø§Ø¶ÙŠ': 'land',
            'Ø¹Ù…Ø§Ø±Ø©': 'building', 'Ø¹Ù…Ø§ÙŠØ±': 'building',
            'Ù…Ø®Ø²Ù†': 'warehouse', 'Ù…Ø®Ø§Ø²Ù†': 'warehouse'
        };

        const EGYPT_LOCATIONS = {
            "Ø§Ù„Ø´Ø±Ù‚ÙŠØ©": ["Ø§Ù„Ø²Ù‚Ø§Ø²ÙŠÙ‚", "Ø§Ù„Ø¹Ø§Ø´Ø± Ù…Ù† Ø±Ù…Ø¶Ø§Ù†", "Ù…Ù†ÙŠØ§ Ø§Ù„Ù‚Ù…Ø­", "Ø¨Ù„Ø¨ÙŠØ³", "Ù…Ø´ØªÙˆÙ„ Ø§Ù„Ø³ÙˆÙ‚", "Ø§Ù„Ù‚Ù†Ø§ÙŠØ§Øª", "Ø£Ø¨Ùˆ Ø­Ù…Ø§Ø¯", "Ø§Ù„Ù‚Ø±ÙŠÙ†", "Ù‡Ù‡ÙŠØ§", "Ø£Ø¨Ùˆ ÙƒØ¨ÙŠØ±", "ÙØ§Ù‚ÙˆØ³", "Ø§Ù„ØµØ§Ù„Ø­ÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©", "Ø§Ù„Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…ÙŠØ©", "Ø¯ÙŠØ±Ø¨ Ù†Ø¬Ù…", "ÙƒÙØ± ØµÙ‚Ø±", "Ø£ÙˆÙ„Ø§Ø¯ ØµÙ‚Ø±", "Ø§Ù„Ø­Ø³ÙŠÙ†ÙŠØ©", "ØµØ§Ù† Ø§Ù„Ø­Ø¬Ø±", "Ù…Ù†Ø´Ø£Ø© Ø£Ø¨Ùˆ Ø¹Ù…Ø±"],
            "Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©": ["Ù…Ø¯ÙŠÙ†Ø© Ù†ØµØ±", "Ù…ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©", "Ø§Ù„Ù…Ø¹Ø§Ø¯ÙŠ", "Ø§Ù„ØªØ¬Ù…Ø¹ Ø§Ù„Ø®Ø§Ù…Ø³", "Ø§Ù„Ø±Ø­Ø§Ø¨", "Ù…Ø¯ÙŠÙ†ØªÙŠ", "Ø§Ù„Ø´Ø±ÙˆÙ‚", "Ø§Ù„Ø¹Ø¨ÙˆØ±", "Ø§Ù„Ù…Ù‚Ø·Ù…", "Ø§Ù„Ø²ÙŠØªÙˆÙ†", "Ø­Ø¯Ø§Ø¦Ù‚ Ø§Ù„Ù‚Ø¨Ø©", "Ø´Ø¨Ø±Ø§", "ÙˆØ³Ø· Ø§Ù„Ø¨Ù„Ø¯", "Ø§Ù„Ù…Ù†ÙŠÙ„", "Ø§Ù„Ø²Ù…Ø§Ù„Ùƒ", "Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ†", "Ø§Ù„Ø¯Ù‚ÙŠ", "Ø§Ù„Ø¹Ø¬ÙˆØ²Ø©"],
            "Ø§Ù„Ø¬ÙŠØ²Ø©": ["6 Ø£ÙƒØªÙˆØ¨Ø±", "Ø§Ù„Ø´ÙŠØ® Ø²Ø§ÙŠØ¯", "Ø§Ù„Ù‡Ø±Ù…", "ÙÙŠØµÙ„", "Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ†", "Ø§Ù„Ø¯Ù‚ÙŠ", "Ø§Ù„Ø¹Ø¬ÙˆØ²Ø©", "Ø¥Ù…Ø¨Ø§Ø¨Ø©", "Ø§Ù„ÙˆØ±Ø§Ù‚", "Ø¨ÙˆÙ„Ø§Ù‚ Ø§Ù„Ø¯ÙƒØ±ÙˆØ±", "Ø§Ù„Ø¹Ù…Ø±Ø§Ù†ÙŠØ©", "Ø§Ù„Ù…Ù†ÙŠØ¨"],
            "Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©": ["Ø³Ù…ÙˆØ­Ø©", "Ù…ÙŠØ§Ù…ÙŠ", "Ø§Ù„Ù…Ù†ØªØ²Ù‡", "Ø³ÙŠØ¯ÙŠ Ø¨Ø´Ø±", "Ø¬Ù„ÙŠÙ…", "Ø³ØªØ§Ù†Ù„ÙŠ", "Ø±Ø´Ø¯ÙŠ", "ÙƒÙØ± Ø¹Ø¨Ø¯Ù‡", "Ù…Ø­Ø±Ù… Ø¨Ùƒ", "Ø§Ù„Ø¹Ø¬Ù…ÙŠ", "Ø§Ù„Ø³Ø§Ø­Ù„ Ø§Ù„Ø´Ù…Ø§Ù„ÙŠ", "Ø¨Ø±Ø¬ Ø§Ù„Ø¹Ø±Ø¨"],
            "Ø§Ù„Ø¯Ù‚Ù‡Ù„ÙŠØ©": ["Ø§Ù„Ù…Ù†ØµÙˆØ±Ø©", "Ø·Ù„Ø®Ø§", "Ù…ÙŠØª ØºÙ…Ø±", "Ø¯ÙƒØ±Ù†Ø³", "Ø£Ø¬Ø§", "Ù…Ù†ÙŠØ© Ø§Ù„Ù†ØµØ±", "Ø§Ù„Ø³Ù†Ø¨Ù„Ø§ÙˆÙŠÙ†", "Ø´Ø±Ø¨ÙŠÙ†", "Ø¨Ù„Ù‚Ø§Ø³", "Ø§Ù„Ù…Ø·Ø±ÙŠØ©", "Ø§Ù„Ù…Ù†Ø²Ù„Ø©", "Ø¬Ù…ØµØ©"],
            "Ø§Ù„Ù‚Ù„ÙŠÙˆØ¨ÙŠØ©": ["Ø¨Ù†Ù‡Ø§", "Ù‚Ù„ÙŠÙˆØ¨", "Ø´Ø¨Ø±Ø§ Ø§Ù„Ø®ÙŠÙ…Ø©", "Ø§Ù„Ù‚Ù†Ø§Ø·Ø± Ø§Ù„Ø®ÙŠØ±ÙŠØ©", "Ø§Ù„Ø®Ø§Ù†ÙƒØ©", "ÙƒÙØ± Ø´ÙƒØ±", "Ø·ÙˆØ®", "Ù‚Ù‡Ø§", "Ø§Ù„Ø¹Ø¨ÙˆØ±"],
            "Ø§Ù„Ù…Ù†ÙˆÙÙŠØ©": ["Ø´Ø¨ÙŠÙ† Ø§Ù„ÙƒÙˆÙ…", "Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø³Ø§Ø¯Ø§Øª", "Ù…Ù†ÙˆÙ", "Ø³Ø±Ø³ Ø§Ù„Ù„ÙŠØ§Ù†", "Ø£Ø´Ù…ÙˆÙ†", "Ø§Ù„Ø¨Ø§Ø¬ÙˆØ±", "Ù‚ÙˆÙŠØ³Ù†Ø§", "Ø¨Ø±ÙƒØ© Ø§Ù„Ø³Ø¨Ø¹", "ØªÙ„Ø§", "Ø§Ù„Ø´Ù‡Ø¯Ø§Ø¡"],
            "Ø§Ù„ØºØ±Ø¨ÙŠØ©": ["Ø·Ù†Ø·Ø§", "Ø§Ù„Ù…Ø­Ù„Ø© Ø§Ù„ÙƒØ¨Ø±Ù‰", "ÙƒÙØ± Ø§Ù„Ø²ÙŠØ§Øª", "Ø²ÙØªÙ‰", "Ø§Ù„Ø³Ù†Ø·Ø©", "Ù‚Ø·ÙˆØ±", "Ø¨Ø³ÙŠÙˆÙ†", "Ø³Ù…Ù†ÙˆØ¯"],
            "Ø§Ù„Ø¨Ø­ÙŠØ±Ø©": ["Ø¯Ù…Ù†Ù‡ÙˆØ±", "ÙƒÙØ± Ø§Ù„Ø¯ÙˆØ§Ø±", "Ø±Ø´ÙŠØ¯", "Ø¥Ø¯ÙƒÙˆ", "Ø£Ø¨Ùˆ Ø§Ù„Ù…Ø·Ø§Ù…ÙŠØ±", "Ø£Ø¨Ùˆ Ø­Ù…Øµ", "Ø§Ù„Ø¯Ù„Ù†Ø¬Ø§Øª", "Ø§Ù„Ù…Ø­Ù…ÙˆØ¯ÙŠØ©", "Ø§Ù„Ø±Ø­Ù…Ø§Ù†ÙŠØ©", "Ø¥ÙŠØªØ§ÙŠ Ø§Ù„Ø¨Ø§Ø±ÙˆØ¯", "Ø­ÙˆØ´ Ø¹ÙŠØ³Ù‰", "Ø´Ø¨Ø±Ø§Ø®ÙŠØª", "ÙƒÙˆÙ… Ø­Ù…Ø§Ø¯Ø©", "Ø¨Ø¯Ø±", "ÙˆØ§Ø¯ÙŠ Ø§Ù„Ù†Ø·Ø±ÙˆÙ†", "Ø§Ù„Ù†ÙˆØ¨Ø§Ø±ÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©"],
            "Ø¯Ù…ÙŠØ§Ø·": ["Ø¯Ù…ÙŠØ§Ø·", "Ø¯Ù…ÙŠØ§Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©", "Ø±Ø£Ø³ Ø§Ù„Ø¨Ø±", "ÙØ§Ø±Ø³ÙƒÙˆØ±", "Ø§Ù„Ø²Ø±Ù‚Ø§", "Ø§Ù„Ø³Ø±Ùˆ", "Ø§Ù„Ø±ÙˆØ¶Ø©", "ÙƒÙØ± Ø§Ù„Ø¨Ø·ÙŠØ®", "Ø¹Ø²Ø¨Ø© Ø§Ù„Ø¨Ø±Ø¬", "Ù…ÙŠØª Ø£Ø¨Ùˆ ØºØ§Ù„Ø¨", "ÙƒÙØ± Ø³Ø¹Ø¯"],
            "Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯": ["Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯", "Ø¨ÙˆØ±ÙØ¤Ø§Ø¯"],
            "Ø§Ù„Ø¥Ø³Ù…Ø§Ø¹ÙŠÙ„ÙŠØ©": ["Ø§Ù„Ø¥Ø³Ù…Ø§Ø¹ÙŠÙ„ÙŠØ©", "Ø§Ù„ØªÙ„ Ø§Ù„ÙƒØ¨ÙŠØ±", "ÙØ§ÙŠØ¯", "Ø§Ù„Ù‚Ù†Ø·Ø±Ø© Ø´Ø±Ù‚", "Ø§Ù„Ù‚Ù†Ø·Ø±Ø© ØºØ±Ø¨", "Ø£Ø¨Ùˆ ØµÙˆÙŠØ±", "Ø§Ù„Ù‚ØµØ§ØµÙŠÙ†"],
            "Ø§Ù„Ø³ÙˆÙŠØ³": ["Ø§Ù„Ø³ÙˆÙŠØ³", "Ø§Ù„Ø£Ø±Ø¨Ø¹ÙŠÙ†", "Ø¹ØªØ§Ù‚Ø©", "Ø§Ù„Ø¬Ù†Ø§ÙŠÙ†", "ÙÙŠØµÙ„"],
            "ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®": ["ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®", "Ø¯Ø³ÙˆÙ‚", "ÙÙˆÙ‡", "Ù…Ø·ÙˆØ¨Ø³", "Ø¨Ù„Ø·ÙŠÙ…", "Ù…ØµÙŠÙ Ø¨Ù„Ø·ÙŠÙ…", "Ø§Ù„Ø­Ø§Ù…ÙˆÙ„", "Ø¨ÙŠÙ„Ø§", "Ø§Ù„Ø±ÙŠØ§Ø¶", "Ø³ÙŠØ¯ÙŠ Ø³Ø§Ù„Ù…", "Ù‚Ù„ÙŠÙ†", "Ø¨Ø±Ø¬ Ø§Ù„Ø¨Ø±Ù„Ø³"],
            "Ø§Ù„ÙÙŠÙˆÙ…": ["Ø§Ù„ÙÙŠÙˆÙ…", "Ø§Ù„ÙÙŠÙˆÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©", "Ø·Ø§Ù…ÙŠØ©", "Ø³Ù†ÙˆØ±Ø³", "Ø¥Ø·Ø³Ø§", "Ø¥Ø¨Ø´ÙˆØ§ÙŠ", "ÙŠÙˆØ³Ù Ø§Ù„ØµØ¯ÙŠÙ‚"],
            "Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ": ["Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ", "Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©", "Ø§Ù„ÙˆØ§Ø³Ø·Ù‰", "Ù†Ø§ØµØ±", "Ø¥Ù‡Ù†Ø§Ø³ÙŠØ§", "Ø¨Ø¨Ø§", "Ø§Ù„ÙØ´Ù†", "Ø³Ù…Ø³Ø·Ø§"],
            "Ø§Ù„Ù…Ù†ÙŠØ§": ["Ø§Ù„Ù…Ù†ÙŠØ§", "Ø§Ù„Ù…Ù†ÙŠØ§ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©", "Ø§Ù„Ø¹Ø¯ÙˆØ©", "Ù…ØºØ§ØºØ©", "Ø¨Ù†ÙŠ Ù…Ø²Ø§Ø±", "Ù…Ø·Ø§ÙŠ", "Ø³Ù…Ø§Ù„ÙˆØ·", "Ø£Ø¨Ùˆ Ù‚Ø±Ù‚Ø§Øµ", "Ù…Ù„ÙˆÙŠ", "Ø¯ÙŠØ± Ù…ÙˆØ§Ø³"],
            "Ø£Ø³ÙŠÙˆØ·": ["Ø£Ø³ÙŠÙˆØ·", "Ø£Ø³ÙŠÙˆØ· Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©", "Ø¯ÙŠØ±ÙˆØ·", "Ø§Ù„Ù‚ÙˆØµÙŠØ©", "Ø£Ø¨Ù†ÙˆØ¨", "Ù…Ù†ÙÙ„ÙˆØ·", "Ø£Ø¨Ùˆ ØªÙŠØ¬", "Ø§Ù„ØºÙ†Ø§ÙŠÙ…", "Ø³Ø§Ø­Ù„ Ø³Ù„ÙŠÙ…", "Ø§Ù„Ø¨Ø¯Ø§Ø±ÙŠ", "ØµØ¯ÙØ§", "Ø§Ù„ÙØªØ­"],
            "Ø³ÙˆÙ‡Ø§Ø¬": ["Ø³ÙˆÙ‡Ø§Ø¬", "Ø³ÙˆÙ‡Ø§Ø¬ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©", "Ø£Ø®Ù…ÙŠÙ…", "Ø£Ø®Ù…ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©", "Ø§Ù„Ø¨Ù„ÙŠÙ†Ø§", "Ø§Ù„Ù…Ø±Ø§ØºØ©", "Ø§Ù„Ù…Ù†Ø´Ø£Ø©", "Ø¯Ø§Ø± Ø§Ù„Ø³Ù„Ø§Ù…", "Ø¬Ø±Ø¬Ø§", "Ø¬Ù‡ÙŠÙ†Ø©", "Ø³Ø§Ù‚Ù„ØªØ©", "Ø·Ù…Ø§", "Ø·Ù‡Ø·Ø§"],
            "Ù‚Ù†Ø§": ["Ù‚Ù†Ø§", "Ù‚Ù†Ø§ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©", "Ø£Ø¨Ùˆ ØªØ´Øª", "Ù†Ø¬Ø¹ Ø­Ù…Ø§Ø¯ÙŠ", "Ø¯Ø´Ù†Ø§", "Ø§Ù„ÙˆÙ‚Ù", "Ù‚ÙØ·", "Ù‚ÙˆØµ", "Ù†Ù‚Ø§Ø¯Ø©", "ÙØ±Ø´ÙˆØ·"],
            "Ø§Ù„Ø£Ù‚ØµØ±": ["Ø§Ù„Ø£Ù‚ØµØ±", "Ø§Ù„Ø£Ù‚ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©", "Ø¥Ø³Ù†Ø§", "Ø·ÙŠØ¨Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©", "Ø§Ù„Ø²ÙŠÙ†ÙŠØ©", "Ø§Ù„Ø¨ÙŠØ§Ø¶ÙŠØ©", "Ø§Ù„Ù‚Ø±Ù†Ø©", "Ø£Ø±Ù…Ù†Øª", "Ø§Ù„Ø·ÙˆØ¯"],
            "Ø£Ø³ÙˆØ§Ù†": ["Ø£Ø³ÙˆØ§Ù†", "Ø£Ø³ÙˆØ§Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©", "Ø¯Ø±Ø§Ùˆ", "ÙƒÙˆÙ… Ø£Ù…Ø¨Ùˆ", "Ù†ØµØ± Ø§Ù„Ù†ÙˆØ¨Ø©", "Ø¥Ø¯ÙÙˆ"],
            "Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ø£Ø­Ù…Ø±": ["Ø§Ù„ØºØ±Ø¯Ù‚Ø©", "Ø±Ø£Ø³ ØºØ§Ø±Ø¨", "Ø³ÙØ§Ø¬Ø§", "Ø§Ù„Ù‚ØµÙŠØ±", "Ù…Ø±Ø³Ù‰ Ø¹Ù„Ù…", "Ø§Ù„Ø´Ù„Ø§ØªÙŠÙ†", "Ø­Ù„Ø§ÙŠØ¨"],
            "Ø§Ù„ÙˆØ§Ø¯ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯": ["Ø§Ù„Ø®Ø§Ø±Ø¬Ø©", "Ø¨Ø§Ø±ÙŠØ³", "Ù…ÙˆØ·", "Ø§Ù„ÙØ±Ø§ÙØ±Ø©", "Ø¨Ù„Ø§Ø·"],
            "Ù…Ø·Ø±ÙˆØ­": ["Ù…Ø±Ø³Ù‰ Ù…Ø·Ø±ÙˆØ­", "Ø§Ù„Ø­Ù…Ø§Ù…", "Ø§Ù„Ø¹Ù„Ù…ÙŠÙ†", "Ø§Ù„Ø¶Ø¨Ø¹Ø©", "Ø§Ù„Ù†Ø¬ÙŠÙ„Ø©", "Ø³ÙŠØ¯ÙŠ Ø¨Ø±Ø§Ù†ÙŠ", "Ø§Ù„Ø³Ù„ÙˆÙ…", "Ø³ÙŠÙˆØ©"],
            "Ø´Ù…Ø§Ù„ Ø³ÙŠÙ†Ø§Ø¡": ["Ø§Ù„Ø¹Ø±ÙŠØ´", "Ø¨Ø¦Ø± Ø§Ù„Ø¹Ø¨Ø¯", "Ù†Ø®Ù„", "Ø§Ù„Ø­Ø³Ù†Ø©", "Ø§Ù„Ø´ÙŠØ® Ø²ÙˆÙŠØ¯", "Ø±ÙØ­"],
            "Ø¬Ù†ÙˆØ¨ Ø³ÙŠÙ†Ø§Ø¡": ["Ø§Ù„Ø·ÙˆØ±", "Ø´Ø±Ù… Ø§Ù„Ø´ÙŠØ®", "Ø¯Ù‡Ø¨", "Ù†ÙˆÙŠØ¨Ø¹", "Ø·Ø§Ø¨Ø§", "Ø³Ø§Ù†Øª ÙƒØ§ØªØ±ÙŠÙ†", "Ø£Ø¨Ùˆ Ø±Ø¯ÙŠØ³", "Ø£Ø¨Ùˆ Ø²Ù†ÙŠÙ…Ø©", "Ø±Ø£Ø³ Ø³Ø¯Ø±"]
        };

        setPersistence(auth, browserLocalPersistence).then(()=>signInAnonymously(auth));
        onAuthStateChanged(auth, (u) => { 
            if(u) { 
                state.user=u; 
                // Removed manual height calculation to let CSS lvh handle it
                loadListings(); 
                checkUserChat(); 
                checkAdminStatus(); 
                renderAmenities(ALL_AMENITIES); 
                initLocations();

                const originalHeight = window.innerHeight;
                window.addEventListener('resize', () => {
                    if (window.innerHeight < originalHeight * 0.8) {
                        document.body.classList.add('keyboard-open');
                    } else {
                        document.body.classList.remove('keyboard-open');
                    }
                });

                document.querySelectorAll('input, textarea').forEach(el => {
                    el.addEventListener('focus', () => document.body.classList.add('keyboard-open'));
                    el.addEventListener('blur', () => document.body.classList.remove('keyboard-open'));
                });
            } 
        });

        function renderAmenities(list) { 
            document.getElementById('amenities-grid').innerHTML = list.map(a => `<label class="amenity-tile cursor-pointer"><input type="checkbox" class="amenity-check hidden" value="${a}"><div class="text-center py-1 border border-slate-200 dark:border-slate-600 rounded-lg text-[8px] font-bold text-slate-600 dark:text-slate-300 transition hover:bg-slate-50 dark:hover:bg-slate-700 truncate">${a}</div></label>`).join(''); 
        }

        function initLocations() {
            const govSelects = ['in-gov', 'filter-gov'];
            govSelects.forEach(id => {
                const sel = document.getElementById(id);
                if(sel) {
                    sel.innerHTML = `<option value="" ${id==='in-gov'?'disabled selected':'selected'}>${id==='in-gov'?'Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©':'ÙƒÙ„ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª'}</option>`;
                    Object.keys(EGYPT_LOCATIONS).forEach(gov => {
                        sel.innerHTML += `<option value="${gov}">${gov}</option>`;
                    });
                }
            });
        }

        window.populateCities = (govId, cityId) => {
            const gov = document.getElementById(govId).value;
            const citySel = document.getElementById(cityId);
            citySel.innerHTML = `<option value="" ${govId==='in-gov'?'disabled selected':'selected'}>${govId==='in-gov'?'Ø§Ù„Ù…Ø±ÙƒØ²/Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©':'ÙƒÙ„ Ø§Ù„Ù…Ø±Ø§ÙƒØ²'}</option>`;

            if(gov && EGYPT_LOCATIONS[gov]) {
                EGYPT_LOCATIONS[gov].forEach(city => {
                    citySel.innerHTML += `<option value="${city}">${city}</option>`;
                });
            }
        };

        window.toggleFilterPanel = () => {
            const p = document.getElementById('filter-panel');
            p.classList.toggle('open');
        };

        window.updateFormFields = () => {
            const cat = document.getElementById('in-category').value;
            const roomFields = document.getElementById('room-fields');
            const furnishedField = document.getElementById('furnished-field');
            const levelInput = document.getElementById('in-level');
            const floorsAltInput = document.getElementById('in-floors-alt');
            const landTypeWrapper = document.getElementById('land-type-wrapper');
            const landFields = document.getElementById('land-fields');
            const buildingFields = document.getElementById('building-fields');
            const extraFields = document.getElementById('extra-fields'); 

            roomFields.classList.remove('hidden');
            furnishedField.classList.remove('hidden');
            levelInput.classList.remove('hidden');
            floorsAltInput.classList.add('hidden');
            landTypeWrapper.classList.add('hidden');
            landFields.classList.add('hidden');
            buildingFields.classList.add('hidden');
            extraFields.classList.remove('hidden');

            if(cat === 'land') {
                renderAmenities(LAND_AMENITIES);
                roomFields.classList.add('hidden');
                furnishedField.classList.add('hidden');
                levelInput.classList.add('hidden');
                extraFields.classList.add('hidden');
                landTypeWrapper.classList.remove('hidden'); 
                landFields.classList.remove('hidden');
            } else {
                renderAmenities(ALL_AMENITIES);
                if (cat === 'building') {
                    roomFields.classList.add('hidden'); 
                    furnishedField.classList.add('hidden');
                    levelInput.classList.add('hidden'); 
                    floorsAltInput.classList.remove('hidden'); 
                    buildingFields.classList.remove('hidden');
                    extraFields.classList.add('hidden');
                } else if (['shop','office','warehouse'].includes(cat)) {
                    roomFields.classList.add('hidden');
                    extraFields.classList.add('hidden');
                }
            }
        }

        function checkAdminStatus() { if(localStorage.getItem('souq_admin') === 'true') { state.isAdmin = true; document.getElementById('btn-admin-top').classList.remove('hidden'); } }
        window.toggleDarkMode = () => { document.documentElement.classList.toggle('dark'); localStorage.setItem('souq_theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light'); }
        if(localStorage.getItem('souq_theme') === 'dark') document.documentElement.classList.add('dark');

        window.showToast=(m,t='s')=>{const d=document.createElement('div');d.className=`toast fixed top-4 left-1/2 -translate-x-1/2 bg-white dark:bg-slate-800 shadow-xl px-4 py-2 rounded-lg border border-${t==='e'?'red':'emerald'}-500 flex items-center gap-2 text-xs font-bold z-[100] text-slate-800 dark:text-white`;d.innerHTML=`<i data-lucide="${t==='e'?'alert-circle':'check-circle'}" class="w-4 h-4 text-${t==='e'?'red':'emerald'}-500"></i> ${m}`;document.getElementById('toast-container').appendChild(d);lucide.createIcons();setTimeout(()=>{d.classList.add('hiding');setTimeout(()=>d.remove(),300)},3000)};

        function normalizeText(t) { return t ? t.toString().toLowerCase().replace(/[Ø£Ø¥Ø¢]/g, 'Ø§').replace(/Ø©/g, 'Ù‡').replace(/Ù‰/g, 'ÙŠ') : ""; }
        function timeAgo(d) { if(!d) return 'Ø¬Ø¯ÙŠØ¯'; const s=Math.floor((new Date()-d.toDate())/1000); if(s<60)return 'Ø§Ù„Ø¢Ù†'; if(s<3600)return `Ù…Ù†Ø° ${Math.floor(s/60)} Ø¯`; if(s<86400)return `Ù…Ù†Ø° ${Math.floor(s/3600)} Ø³`; return `Ù…Ù†Ø° ${Math.floor(s/86400)} ÙŠ`; }
        function showSkeletons() { const c=document.getElementById('grid-container'); c.innerHTML=''; for(let i=0;i<6;i++) c.innerHTML+=`<div class="bg-white dark:bg-slate-800 rounded-lg overflow-hidden shadow-sm border-2 border-navy/10 dark:border-slate-700 h-full"><div class="h-28 skeleton rounded-t-lg"></div><div class="p-2 space-y-2"><div class="h-3 rounded skeleton w-3/4"></div><div class="h-2 rounded skeleton w-1/2"></div></div></div>`; }

        function loadListings() { 
            showSkeletons(); 
            onSnapshot(query(collection(db, COLLECTION_NAME)), (snap) => { 
                state.listings = []; 
                snap.forEach(d => state.listings.push({id:d.id, ...d.data()})); 
                state.listings.sort((a,b) => {
                    if (a.isPinned === b.isPinned) {
                        return (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0);
                    }
                    return (a.isPinned ? -1 : 1);
                });
                performSearch(); 

                document.body.classList.add('app-loaded');
                setTimeout(() => {
                    document.getElementById('splash-screen').classList.add('hidden-splash');
                }, 100);

                const urlParams = new URLSearchParams(window.location.search);
                const sharedId = urlParams.get('id');
                if(sharedId) {
                    const item = state.listings.find(i => i.id === sharedId);
                    if(item) openDetails(sharedId);
                }
            }); 
        }

        window.performSearch = () => { 
            const q = normalizeText(document.getElementById('search-input').value); 
            const filterGov = document.getElementById('filter-gov').value;
            const filterCity = document.getElementById('filter-city').value;
            const filterType = document.getElementById('filter-type').value;
            const minPrice = Number(document.getElementById('filter-min-price').value) || 0;
            const maxPrice = Number(document.getElementById('filter-max-price').value) || Infinity;

            let detectedCat = '';
            for (const [key, val] of Object.entries(CAT_KEYWORDS)) {
                if (q.includes(key)) {
                    detectedCat = val;
                    break; 
                }
            }

            const cont = document.getElementById('grid-container'); 
            const filtered = state.listings.filter(item => { 
                let matchType = true; 
                if (state.currentFilter !== 'all' && item.type !== state.currentFilter) matchType = false;

                if (filterType && item.type !== filterType) matchType = false;

                const catNameAr = CAT_MAP[item.category] || '';
                const itemText = normalizeText(item.title + item.desc + item.phone + item.gov + item.city + item.location + (item.address || '') + catNameAr);
                const matchText = itemText.includes(q);

                const matchCat = !detectedCat || item.category === detectedCat;
                const matchGov = !filterGov || item.gov === filterGov;
                const matchCity = !filterCity || item.city === filterCity;
                const matchPrice = item.price >= minPrice && item.price <= maxPrice;

                return matchType && matchText && matchCat && matchGov && matchCity && matchPrice; 
            }); 

            const visibleItems = filtered.slice(0, state.visibleLimit);
            const loadMoreBtn = document.getElementById('load-more-container');

            if(!filtered.length) { 
                document.getElementById('empty-state').classList.remove('hidden'); 
                cont.innerHTML = ''; 
                loadMoreBtn.classList.add('hidden');
            } else { 
                document.getElementById('empty-state').classList.add('hidden'); 
                cont.innerHTML = visibleItems.map(item => createCard(item)).join(''); 
                lucide.createIcons({ root: cont }); 

                if(filtered.length > state.visibleLimit) {
                    loadMoreBtn.classList.remove('hidden');
                } else {
                    loadMoreBtn.classList.add('hidden');
                }
            } 
        };

        window.loadMore = () => {
            state.visibleLimit += 12;
            performSearch();
        };

        let searchTimeout;
        document.getElementById('search-input').addEventListener('input', () => { clearTimeout(searchTimeout); searchTimeout = setTimeout(performSearch, 200); });
        document.getElementById('search-input').addEventListener('keydown', (e) => { if(e.key === 'Enter') { e.preventDefault(); performSearch(); document.getElementById('search-input').blur(); } });

        window.filter = (t) => { 
            state.currentFilter = t; 
            state.visibleLimit = 12; 
            performSearch(); 
        };

        const getCloudinaryThumb = (url) => {
            if (url && url.includes('cloudinary.com')) {
                return url.replace('/upload/', '/upload/w_512,h_512,c_fill,q_auto/');
            }
            return url;
        };

        function createCard(item) {
            const imgs = Array.isArray(item.images)?item.images:[item.image];
            let badge = item.badge==='hot' ? `<span class="inline-block bg-orange-500 text-white text-[8px] font-bold px-1.5 py-0.5 rounded shadow animate-pulse">ğŸ”¥ Ù„Ù‚Ø·Ø©</span>` : (item.badge==='verified' ? `<span class="inline-block bg-blue-500 text-white text-[8px] font-bold px-1.5 py-0.5 rounded shadow flex items-center gap-0.5"><i data-lucide="check-circle" class="w-2 h-2"></i> Ù…ÙˆØ«ÙˆÙ‚</span>` : '');
            let statusOverlay = ''; 
            if(item.status && item.status !== 'available') { 
                const txt = item.status==='sold'?'ØªÙ… Ø§Ù„Ø¨ÙŠØ¹':'ØªÙ… Ø§Ù„ØªØ£Ø¬ÙŠØ±'; 
                const clr = item.status==='sold'?'bg-red-600':'bg-blue-600'; 
                statusOverlay=`<div class="absolute inset-0 sold-overlay flex items-center justify-center z-30 pointer-events-none"><span class="${clr} text-white font-bold px-3 py-1 rounded-lg shadow-xl transform -rotate-12 text-xs">${txt}</span></div>`; 
            }

            let iconsHtml = '';
            if(item.category === 'land') {
                if(item.feddan || item.qirat) iconsHtml += `<span class="flex items-center gap-0.5"><i data-lucide="maximize" class="w-2.5 h-2.5 text-slate-400"></i> ${item.feddan?item.feddan+' Ù':''} ${item.qirat?item.qirat+' Ù‚':''}</span>`;
            } else if (item.category === 'building') {
                if(item.floors) iconsHtml += `<span class="flex items-center gap-0.5"><i data-lucide="layers" class="w-2.5 h-2.5 text-slate-400"></i> ${item.floors}</span>`;
            } else {
                if(item.rooms) iconsHtml += `<span class="flex items-center gap-0.5"><i data-lucide="bed-double" class="w-2.5 h-2.5 text-slate-400"></i> ${item.rooms}</span>`;
                if(item.baths) iconsHtml += `<span class="flex items-center gap-0.5"><i data-lucide="bath" class="w-2.5 h-2.5 text-slate-400"></i> ${item.baths}</span>`;
            }
            if(item.area) iconsHtml += `<span class="flex items-center gap-0.5"><i data-lucide="ruler" class="w-2.5 h-2.5 text-slate-400"></i> ${item.area}Ù…</span>`;

            const locDisplay = item.gov ? `${item.gov}ØŒ ${item.city}` : item.location;

            // WhatsApp Message - No Image Link
            const waMsg = `Ù…Ù‡ØªÙ… Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø§Ø±: ${item.title} (${Number(item.price).toLocaleString()} Ø¬)`;
            const waLink = `https://wa.me/20${item.phone}?text=${encodeURIComponent(waMsg)}`;

            return `<div class="bg-white dark:bg-slate-800 rounded-lg overflow-hidden shadow-sm border border-black dark:border-slate-500 flex flex-col h-full cursor-pointer active:scale-95 transition-transform group relative transform-gpu" onclick="openDetails('${item.id}')">
                <div class="relative w-full h-28 sm:h-36 bg-gray-200 dark:bg-slate-700 shrink-0">
                    ${statusOverlay}
                    <span class="absolute top-1.5 right-1.5 ${item.type === 'sale' ? 'bg-emerald-600' : 'bg-blue-600'} text-white px-1.5 py-0.5 rounded text-[8px] font-bold shadow z-20 card-overlay-z">${item.type === 'sale' ? 'Ø¨ÙŠØ¹' : 'Ø¥ÙŠØ¬Ø§Ø±'}</span>
                    ${imgs.length > 1 ? `<button onclick="scrollCard(event, '${item.id}', -1)" class="absolute right-1 top-1/2 -translate-y-1/2 bg-black/20 hover:bg-black/40 text-white p-0.5 rounded-full z-10 hidden group-hover:block"><i data-lucide="chevron-right" class="w-3 h-3"></i></button><button onclick="scrollCard(event, '${item.id}', 1)" class="absolute left-1 top-1/2 -translate-y-1/2 bg-black/20 hover:bg-black/40 text-white p-0.5 rounded-full z-10 hidden group-hover:block"><i data-lucide="chevron-left" class="w-3 h-3"></i></button>` : ''}
                    <div id="slider-${item.id}" class="flex w-full h-full overflow-x-auto no-scrollbar snap-x scroll-smooth">${imgs.map(src => {
                        const isVid = src.includes('.mp4') || src.includes('.mov');
                        return isVid ? `<video src="${src}" class="w-full h-full object-cover shrink-0 snap-center ${statusOverlay?'grayscale':''}" muted playsinline></video>` : `<img src="${src}" class="w-full h-full object-cover shrink-0 snap-center ${statusOverlay?'grayscale':''}">`
                    }).join('')}</div>
                </div>
                <div class="p-1.5 flex-1 flex flex-col">
                    <div class="flex-1">
                        <div class="flex justify-between items-start mb-0.5">
                            <h3 class="font-bold text-slate-900 dark:text-white text-[10px] line-clamp-1 leading-tight">${item.title}</h3>
                            <span class="font-black text-emerald-600 dark:text-emerald-400 text-[10px] whitespace-nowrap">${Number(item.price).toLocaleString()} Ø¬</span>
                        </div>
                        <div class="h-3.5 flex justify-end items-center mt-0.5">
                            ${!statusOverlay ? badge : ''}
                        </div>
                        <div class="flex items-center gap-0.5 text-[9px] text-slate-500 dark:text-slate-400 mb-0.5 mt-0.5">
                            <i data-lucide="map-pin" class="w-2.5 h-2.5 text-emerald-500 shrink-0"></i> 
                            <span class="truncate leading-tight">${locDisplay}</span>
                        </div>
                        <div class="flex items-center gap-2 text-[9px] text-slate-600 dark:text-slate-300 font-bold mb-1.5 h-4">
                            ${iconsHtml}
                        </div>
                    </div>
                    <div class="mt-auto flex gap-1 pt-1.5 border-t border-slate-100 dark:border-slate-700">
                        <a href="${waLink}" target="_blank" onclick="event.stopPropagation()" class="flex-1 bg-emerald-600 text-white py-1 rounded flex justify-center items-center gap-1 text-[9px] font-bold"><i data-lucide="message-circle" class="w-2.5 h-2.5"></i> ÙˆØ§ØªØ³</a>
                        <a href="tel:${item.phone}" onclick="event.stopPropagation()" class="bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 p-1 rounded"><i data-lucide="phone" class="w-2.5 h-2.5"></i></a>
                    </div>
                </div>
            </div>`;
        }

        window.openDetails = (id) => {
            try {
                const item = state.listings.find(i => i.id === id); if(!item) return;
                state.currentItem = item; document.getElementById('d-title').innerText = item.title; document.getElementById('d-price').innerText = Number(item.price).toLocaleString() + ' Ø¬Ù†ÙŠÙ‡'; document.getElementById('d-desc').innerText = item.desc; document.getElementById('d-time-badge').innerText = timeAgo(item.createdAt);

                const amCont = document.getElementById('d-amenities'); 
                amCont.innerHTML=''; 
                if(item.amenities && Array.isArray(item.amenities) && item.amenities.length > 0) {
                    item.amenities.forEach(a => {
                        amCont.innerHTML += `<div class="p-1.5 text-center text-[9px] font-bold text-slate-700 dark:text-slate-300 border-r border-b border-slate-200 dark:border-slate-700 last:border-r-0">${a}</div>`;
                    });
                } else {
                    amCont.innerHTML = `<div class="col-span-3 p-2 text-center text-[9px] text-slate-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù…ÙŠØ²Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</div>`;
                }

                const mapBtn = document.getElementById('d-map'); if(item.mapLink) { mapBtn.classList.remove('hidden'); mapBtn.classList.add('flex'); mapBtn.href = item.mapLink; } else { mapBtn.classList.add('hidden'); mapBtn.classList.remove('flex'); }
                const typeEl = document.getElementById('d-type-badge'); typeEl.innerText = item.type === 'sale' ? 'Ù„Ù„Ø¨ÙŠØ¹' : 'Ù„Ù„Ø¥ÙŠØ¬Ø§Ø±'; typeEl.className = `absolute bottom-2 right-2 text-white px-2 py-0.5 rounded text-[10px] font-bold shadow backdrop-blur-sm ${item.type === 'sale' ? 'bg-emerald-600/90' : 'bg-blue-600/90'}`;

                const imgs = Array.isArray(item.images) ? item.images : [item.image]; 

                // WhatsApp Link - No Image Link
                const updateWaLink = () => {
                    const shareUrl = window.location.origin + window.location.pathname + '?id=' + item.id;
                    const waMsg = `Ù…Ù‡ØªÙ… Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø§Ø±: ${item.title} (${Number(item.price).toLocaleString()} Ø¬)\nØ§Ù„Ø±Ø§Ø¨Ø·: ${shareUrl}`;
                    document.getElementById('d-wa').href = `https://wa.me/20${item.phone}?text=${encodeURIComponent(waMsg)}`; 
                };

                updateWaLink();
                document.getElementById('d-call').href = `tel:${item.phone}`;

                const slider = document.getElementById('details-slider'); 
                slider.innerHTML = imgs.map(src => {
                    const isVid = src.includes('.mp4') || src.includes('.mov');
                    return isVid ? `<video src="${src}" controls class="w-full h-full object-contain snap-center shrink-0 bg-black"></video>` : `<img src="${src}" class="w-full h-full object-cover snap-center shrink-0 cursor-pointer" onclick="openLightbox('${src}')">`
                }).join('');
                document.getElementById('details-arrows').style.display = imgs.length > 1 ? 'block' : 'none';

                const locDisplay = item.gov ? `${item.gov}ØŒ ${item.city}` : item.location;

                let tableHtml = `<tr><th class="w-1/3 text-slate-500 dark:text-slate-400 font-normal bg-slate-50 dark:bg-slate-800/50 text-[10px] flex items-center gap-1"><i data-lucide="home" class="w-3 h-3"></i> Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±</th><td class="font-bold text-slate-800 dark:text-slate-200">${CAT_MAP[item.category] || 'Ø¹Ù‚Ø§Ø±'}</td></tr>`;
                tableHtml += `<tr><th class="text-slate-500 dark:text-slate-400 font-normal bg-slate-50 dark:bg-slate-800/50 text-[10px] flex items-center gap-1"><i data-lucide="map-pin" class="w-3 h-3"></i> Ø§Ù„Ù…ÙˆÙ‚Ø¹</th><td class="font-bold text-slate-800 dark:text-slate-200">${locDisplay}</td></tr>`;

                if(item.address) tableHtml += `<tr><th class="text-slate-500 dark:text-slate-400 font-normal bg-slate-50 dark:bg-slate-800/50 text-[10px] flex items-center gap-1"><i data-lucide="map" class="w-3 h-3"></i> Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th><td class="font-bold text-slate-800 dark:text-slate-200">${item.address}</td></tr>`;

                if(item.area) tableHtml += `<tr><th class="text-slate-500 dark:text-slate-400 font-normal bg-slate-50 dark:bg-slate-800/50 text-[10px] flex items-center gap-1"><i data-lucide="ruler" class="w-3 h-3"></i> Ø§Ù„Ù…Ø³Ø§Ø­Ø©</th><td class="font-bold text-slate-800 dark:text-slate-200">${item.area} Ù…Â²</td></tr>`;

                if(item.category === 'land') {
                    if(item.landType) tableHtml += `<tr><th class="text-slate-500 dark:text-slate-400 font-normal bg-slate-50 dark:bg-slate-800/50 text-[10px] flex items-center gap-1"><i data-lucide="sprout" class="w-3 h-3"></i> Ù†ÙˆØ¹ Ø§Ù„Ø£Ø±Ø¶</th><td class="font-bold text-slate-800 dark:text-slate-200">${item.landType==='building'?'Ù…Ø¨Ø§Ù†ÙŠ':'Ø²Ø±Ø§Ø¹ÙŠØ©'}</td></tr>`;
                    if(item.feddan) tableHtml += `<tr><th class="text-slate-500 dark:text-slate-400 font-normal bg-slate-50 dark:bg-slate-800/50 text-[10px] flex items-center gap-1"><i data-lucide="maximize" class="w-3 h-3"></i> ÙØ¯Ø§Ù†</th><td class="font-bold text-slate-800 dark:text-slate-200">${item.feddan}</td></tr>`;
                    if(item.qirat) tableHtml += `<tr><th class="text-slate-500 dark:text-slate-400 font-normal bg-slate-50 dark:bg-slate-800/50 text-[10px] flex items-center gap-1"><i data-lucide="minimize" class="w-3 h-3"></i> Ù‚ÙŠØ±Ø§Ø·</th><td class="font-bold text-slate-800 dark:text-slate-200">${item.qirat}</td></tr>`;
                } else if (item.category === 'building') {
                    if(item.floors) tableHtml += `<tr><th class="text-slate-500 dark:text-slate-400 font-normal bg-slate-50 dark:bg-slate-800/50 text-[10px] flex items-center gap-1"><i data-lucide="layers" class="w-3 h-3"></i> Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±</th><td class="font-bold text-slate-800 dark:text-slate-200">${item.floors}</td></tr>`;
                    if(item.apartments) tableHtml += `<tr><th class="text-slate-500 dark:text-slate-400 font-normal bg-slate-50 dark:bg-slate-800/50 text-[10px] flex items-center gap-1"><i data-lucide="grid" class="w-3 h-3"></i> Ø¹Ø¯Ø¯ Ø§Ù„Ø´Ù‚Ù‚</th><td class="font-bold text-slate-800 dark:text-slate-200">${item.apartments}</td></tr>`;
                } else {
                    if(item.rooms) tableHtml += `<tr><th class="text-slate-500 dark:text-slate-400 font-normal bg-slate-50 dark:bg-slate-800/50 text-[10px] flex items-center gap-1"><i data-lucide="bed-double" class="w-3 h-3"></i> Ø§Ù„ØºØ±Ù</th><td class="font-bold text-slate-800 dark:text-slate-200">${item.rooms}</td></tr>`;
                    if(item.baths) tableHtml += `<tr><th class="text-slate-500 dark:text-slate-400 font-normal bg-slate-50 dark:bg-slate-800/50 text-[10px] flex items-center gap-1"><i data-lucide="bath" class="w-3 h-3"></i> Ø§Ù„Ø­Ù…Ø§Ù…Ø§Øª</th><td class="font-bold text-slate-800 dark:text-slate-200">${item.baths}</td></tr>`;
                    if(item.balconies) tableHtml += `<tr><th class="text-slate-500 dark:text-slate-400 font-normal bg-slate-50 dark:bg-slate-800/50 text-[10px] flex items-center gap-1"><i data-lucide="wind" class="w-3 h-3"></i> Ø§Ù„Ø¨Ù„ÙƒÙˆÙ†Ø§Øª</th><td class="font-bold text-slate-800 dark:text-slate-200">${item.balconies}</td></tr>`;
                    if(item.finishing) tableHtml += `<tr><th class="text-slate-500 dark:text-slate-400 font-normal bg-slate-50 dark:bg-slate-800/50 text-[10px] flex items-center gap-1"><i data-lucide="paint-bucket" class="w-3 h-3"></i> Ø§Ù„ØªØ´Ø·ÙŠØ¨</th><td class="font-bold text-slate-800 dark:text-slate-200">${FINISH_MAP[item.finishing] || item.finishing}</td></tr>`;
                    if(item.level) tableHtml += `<tr><th class="text-slate-500 dark:text-slate-400 font-normal bg-slate-50 dark:bg-slate-800/50 text-[10px] flex items-center gap-1"><i data-lucide="arrow-up-circle" class="w-3 h-3"></i> Ø§Ù„Ø¯ÙˆØ±</th><td class="font-bold text-slate-800 dark:text-slate-200">${item.level}</td></tr>`;
                    if(item.furnished) tableHtml += `<tr><th class="text-slate-500 dark:text-slate-400 font-normal bg-slate-50 dark:bg-slate-800/50 text-[10px] flex items-center gap-1"><i data-lucide="sofa" class="w-3 h-3"></i> Ø§Ù„ÙØ±Ø´</th><td class="font-bold text-slate-800 dark:text-slate-200">${item.furnished==='yes'?'Ù…ÙØ±ÙˆØ´':'ØºÙŠØ± Ù…ÙØ±ÙˆØ´'}</td></tr>`;
                }
                tableHtml += `<tr><th class="text-slate-500 dark:text-slate-400 font-normal bg-slate-50 dark:bg-slate-800/50 text-[10px] flex items-center gap-1"><i data-lucide="info" class="w-3 h-3"></i> Ø§Ù„Ø­Ø§Ù„Ø©</th><td class="font-bold text-slate-800 dark:text-slate-200">Ù…ØªØ§Ø­</td></tr>`;
                document.getElementById('d-table-body').innerHTML = tableHtml;

                const isOwner = state.user && state.user.uid === item.authorId;
                const showControls = state.isAdmin || isOwner;
                const controlsDiv = document.getElementById('d-controls');
                if(showControls) {
                    controlsDiv.classList.remove('hidden');
                    controlsDiv.innerHTML = `<button onclick="del(event,'${item.id}')" class="bg-red-50 text-red-600 border border-red-200 py-1 px-3 rounded text-[9px] font-bold flex items-center justify-center gap-1"><i data-lucide="trash-2" class="w-3 h-3"></i> Ø­Ø°Ù</button><button onclick="toggleStatus(event,'${item.id}','${item.status||'available'}','${item.type}')" class="bg-blue-50 text-blue-600 border border-blue-200 py-1 px-3 rounded text-[9px] font-bold flex items-center justify-center gap-1"><i data-lucide="edit-3" class="w-3 h-3"></i> Ø­Ø§Ù„Ø©</button>${state.isAdmin ? `<button onclick="pin(event,'${item.id}',${item.isPinned})" class="${item.isPinned ? 'bg-yellow-100 text-yellow-600 border-yellow-300' : 'bg-slate-100 text-slate-600 border-slate-200'} border py-1 px-3 rounded text-[9px] font-bold flex items-center justify-center gap-1"><i data-lucide="star" class="w-3 h-3 ${item.isPinned?'fill-current':''}"></i> ØªØ«Ø¨ÙŠØª</button>` : ''}`;
                } else { controlsDiv.classList.add('hidden'); }

                toggleModal('details-modal'); lucide.createIcons();
            } catch(e) { console.error(e); showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„', 'e'); }
        }
        window.closeDetails = () => toggleModal('details-modal');
        window.shareListing = async () => { if(!state.currentItem) return; const d = { title: 'Ø§Ù„Ø³ÙˆÙ‚ ÙˆÙŠØ§Ùƒ', text: `Ø´Ø§Ù‡Ø¯ Ø¹Ù‚Ø§Ø±: ${state.currentItem.title}`, url: window.location.href + '?id=' + state.currentItem.id }; try { await navigator.share(d); showToast('ØªÙ…Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©'); } catch(e) { navigator.clipboard.writeText(d.url); showToast('ØªÙ… Ø§Ù„Ù†Ø³Ø®'); } };

        window.downloadImages = async () => {
            if(!state.currentItem || !state.currentItem.images) return;
            showToast('Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„ØµÙˆØ±...');
            for(let i=0; i<state.currentItem.images.length; i++) {
                const url = state.currentItem.images[i];
                const a = document.createElement('a');
                a.href = url;
                a.target = '_blank';
                a.download = `souq_${state.currentItem.id}_${i+1}`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                await new Promise(r => setTimeout(r, 500)); 
            }
        };

        window.scrollDetails = (dir) => { const s = document.getElementById('details-slider'); s.scrollBy({ left: dir * s.clientWidth, behavior: 'smooth' }); }
        window.scrollCard = (e, id, dir) => { e.stopPropagation(); const s = document.getElementById(`slider-${id}`); s.scrollBy({ left: dir * s.clientWidth, behavior: 'smooth' }); }
        window.openLightbox = (src) => { document.getElementById('lightbox-img').src = src; document.getElementById('lightbox').classList.remove('hidden'); }
        window.closeLightbox = () => document.getElementById('lightbox').classList.add('hidden');

        function toggleModal(id) { const m=document.getElementById(id); m.classList.toggle('hidden'); if(!m.classList.contains('hidden')) document.body.style.overflow='hidden'; else document.body.style.overflow=''; return !m.classList.contains('hidden'); }
        window.toggleAddModal=()=>{if(toggleModal('add-modal')){state.filesToUpload=[];document.getElementById('preview-area').innerHTML=''; updateFormFields();}};

        window.handleUpload=async(input)=>{
            if(input.files.length+state.filesToUpload.length>5)return showToast('5 Ù…Ù„ÙØ§Øª ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰','e');
            for(let f of input.files){
                state.filesToUpload.push(f);
            }
            renderPreview();
        }; 

        function renderPreview() {
            const area = document.getElementById('preview-area');
            area.innerHTML = state.filesToUpload.map((f, idx) => {
                const isVid = f.type.startsWith('video');
                const url = URL.createObjectURL(f);
                return `
                <div class="relative w-12 h-12 shrink-0 group">
                    ${isVid ? `<video src="${url}" class="w-full h-full rounded-lg object-cover border border-gray-200"></video>` : `<img src="${url}" class="w-full h-full rounded-lg object-cover border border-gray-200">`}
                    <button onclick="removeFile(${idx})" class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full p-0.5 shadow-sm"><i data-lucide="x" class="w-3 h-3"></i></button>
                </div>
            `}).join('');
            lucide.createIcons();
        }

        window.removeFile = (idx) => { state.filesToUpload.splice(idx, 1); renderPreview(); }

        async function uploadToCloudinary(file) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', 'souq_upload');
            const res = await fetch('https://api.cloudinary.com/v1_1/db9h7zm1h/auto/upload', { method: 'POST', body: formData });
            const data = await res.json();
            return data.secure_url;
        }

        window.submitListing=async()=>{
            try {
                if(!state.filesToUpload.length)return showToast('Ù…Ø·Ù„ÙˆØ¨ ØµÙˆØ±Ø© Ø£Ùˆ ÙÙŠØ¯ÙŠÙˆ','e');
                const btn = document.getElementById('btn-publish');
                const originalText = btn.innerText;
                btn.innerText='Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹ ÙˆØ§Ù„Ù†Ø´Ø±...';
                btn.disabled = true;

                const uploadedUrls = [];
                for(let f of state.filesToUpload) {
                    const url = await uploadToCloudinary(f);
                    uploadedUrls.push(url);
                }

                const bdg=document.querySelector('input[name="badge"]:checked').value;
                const am=[];document.querySelectorAll('.amenity-check:checked').forEach(c=>am.push(c.value));
                const cat = document.getElementById('in-category').value;
                const furnished = document.querySelector('input[name="furnished"]:checked')?.value;
                const landType = document.getElementById('in-land-type').value;
                const gov = document.getElementById('in-gov').value;
                const city = document.getElementById('in-city').value;

                if(!gov || !city) {
                    showToast('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© ÙˆØ§Ù„Ù…Ø±ÙƒØ²', 'e');
                    btn.innerText = originalText;
                    btn.disabled = false;
                    return;
                }

                await addDoc(collection(db, COLLECTION_NAME),{
                    title:document.getElementById('in-title').value,
                    price:Number(document.getElementById('in-price').value),
                    type:document.getElementById('in-type').value,
                    category: cat,
                    area: Number(document.getElementById('in-area').value) || 0,
                    feddan: Number(document.getElementById('in-feddan').value) || 0,
                    qirat: Number(document.getElementById('in-qirat').value) || 0,
                    landType: landType,
                    floors: Number(cat === 'building' ? document.getElementById('in-floors-alt').value : document.getElementById('in-floors-alt').value) || 0, 
                    apartments: Number(document.getElementById('in-apartments').value) || 0,
                    rooms: Number(document.getElementById('in-rooms').value) || 0,
                    baths: Number(document.getElementById('in-baths').value) || 0,
                    balconies: Number(document.getElementById('in-balconies').value) || 0,
                    finishing: document.getElementById('in-finishing').value,
                    level: document.getElementById('in-level').value,
                    furnished: furnished,
                    gov: gov,
                    city: city,
                    address: document.getElementById('in-address').value,
                    location:document.getElementById('in-loc')?.value || '', 
                    phone:document.getElementById('in-phone').value,
                    desc:document.getElementById('in-desc').value,
                    mapLink:document.getElementById('in-map').value,
                    amenities:am,
                    images:uploadedUrls,
                    image:uploadedUrls[0],
                    badge:bdg,
                    status:'available',
                    isPinned:false,
                    createdAt:serverTimestamp(),
                    authorId:state.user.uid
                });
                showToast('ØªÙ… Ø§Ù„Ù†Ø´Ø± Ø¨Ù†Ø¬Ø§Ø­');
                toggleModal('add-modal');
                btn.innerText = originalText;
                btn.disabled = false;
                location.reload();
            } catch(e) {
                console.error(e);
                showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†Ø´Ø±', 'e');
                document.getElementById('btn-publish').innerText = 'Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†';
                document.getElementById('btn-publish').disabled = false;
            }
        };

        window.del=async(e,id)=>{if(e)e.stopPropagation();if(confirm('Ø­Ø°ÙØŸ')){await deleteDoc(doc(db, COLLECTION_NAME, id));showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù'); closeDetails();}};
        window.pin=async(e,id,s)=>{if(e)e.stopPropagation();await updateDoc(doc(db, COLLECTION_NAME, id),{isPinned:!s});showToast(s?'ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ«Ø¨ÙŠØª':'ØªÙ… Ø§Ù„ØªØ«Ø¨ÙŠØª'); closeDetails();};
        window.toggleStatus=async(e,id,currentStatus,type)=>{if(e)e.stopPropagation();let nextStatus='available';if(currentStatus==='available'){nextStatus=type==='sale'?'sold':'rented'};await updateDoc(doc(db, COLLECTION_NAME, id),{status:nextStatus});showToast(`Ø§Ù„Ø­Ø§Ù„Ø©: ${nextStatus==='available'?'Ù…ØªØ§Ø­':(nextStatus==='sold'?'ØªÙ… Ø§Ù„Ø¨ÙŠØ¹':'ØªÙ… Ø§Ù„ØªØ£Ø¬ÙŠØ±')}`); closeDetails();};

        window.toggleChat=()=>{if(toggleModal('chat-modal')){if(!state.chatId&&state.chatStep===0&&!state.welcomeSent){state.welcomeSent=true;setTimeout(()=>botMsg('Ù…Ø±Ø­Ø¨Ø§Ù‹! ğŸ‘‹<br>Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ø§Ø³Ù…ØŸ'),100)}}};
        window.sendMsg=async()=>{const t=document.getElementById('chat-msg').value.trim();if(!t)return;document.getElementById('chat-msg').value='';userMsg(t);if(!state.chatId){if(state.chatStep===0){state.tempName=t;state.chatStep=1;setTimeout(()=>botMsg(`Ø£Ù‡Ù„Ø§Ù‹ ${t}ØŒ ÙƒÙŠÙ Ù†Ø³Ø§Ø¹Ø¯ÙƒØŸ`),200)}else if(state.chatStep===1){state.chatStep=2;setTimeout(()=>botMsg('Ø¬Ø§Ø±ÙŠ ØªØ­ÙˆÙŠÙ„Ùƒ Ù„Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ...'),200);const r=await addDoc(collection(db,"chats"),{userId:state.user.uid,userName:state.tempName,lastMsg:t,status:'waiting',messages:[{s:'bot',t:`Ø§Ù„Ø§Ø³Ù…: ${state.tempName}`,d:new Date()},{s:'user',t,d:new Date()},{s:'bot',t:'Ø¬Ø§Ø±ÙŠ ØªØ­ÙˆÙŠÙ„Ùƒ Ù„Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ...',d:new Date()}],createdAt:serverTimestamp()});state.chatId=r.id;listenChat(r.id)}}else{const s=await getDocs(query(collection(db,"chats"),where('__name__','==',state.chatId)));if(!s.empty){const m=s.docs[0].data().messages;m.push({s:'user',t,d:new Date()});await updateDoc(doc(db,"chats",state.chatId),{messages:m,lastMsg:t,status:'waiting'})}}};
        function listenChat(id){onSnapshot(doc(db,"chats",id),s=>{if(s.exists()){const d=s.data();if(d.status==='closed'){state.chatId=null;state.chatStep=0;state.welcomeSent=false;document.getElementById('chat-box').innerHTML='';showToast("ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©");toggleModal('chat-modal');return}document.getElementById('chat-box').innerHTML='';d.messages.forEach(m=>{if(!m.t.startsWith('Ø§Ù„Ø§Ø³Ù…'))(m.s==='user'?userMsg:botMsg)(m.t)})}})};
        function checkUserChat(){onSnapshot(query(collection(db,"chats"),where('userId','==',state.user.uid),where('status','!=','closed')),s=>{if(!s.empty){state.chatId=s.docs[0].id;state.chatStep=2;listenChat(state.chatId)}})};
        function userMsg(t){const d=document.createElement('div');d.className="flex justify-start";d.innerHTML=`<div class="bg-emerald-100 text-emerald-900 px-3 py-2 rounded-xl rounded-tr-none shadow-sm text-xs max-w-[85%]">${t}</div>`;document.getElementById('chat-box').appendChild(d);document.getElementById('chat-box').scrollTop=9999}
        function botMsg(t){const d=document.createElement('div');d.className="flex justify-end";d.innerHTML=`<div class="bg-white dark:bg-slate-700 dark:text-white text-slate-800 px-3 py-2 rounded-xl rounded-tl-none shadow-sm text-xs max-w-[85%]">${t}</div>`;document.getElementById('chat-box').appendChild(d);document.getElementById('chat-box').scrollTop=9999}

        window.toggleAdminPanel=()=>{document.getElementById('admin-panel').classList.toggle('hidden');if(!document.getElementById('admin-panel').classList.contains('hidden'))refreshAdmin()};
        document.getElementById('logo-trigger').addEventListener('click',()=>{if(prompt('Code:')==='1532'){state.isAdmin=true;document.getElementById('btn-admin-top').classList.remove('hidden');filter('all');localStorage.setItem('souq_admin', 'true');showToast('Ø£Ø¯Ù…Ù†');}});
        window.refreshAdmin=()=>{onSnapshot(query(collection(db,"chats"),where('status','!=','closed')),s=>{const l=document.getElementById('admin-users-list');l.innerHTML='';s.forEach(d=>{const dt=d.data();l.innerHTML+=`<div onclick="loadAdmin('${d.id}','${dt.userName}')" class="p-3 mb-2 bg-white/5 rounded-xl cursor-pointer border border-white/10"><div class="font-bold text-xs text-white flex justify-between"><span>${dt.userName}</span>${dt.status==='waiting'?'<span class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>':''}</div><div class="text-[10px] text-gray-400 truncate mt-1">${dt.lastMsg}</div></div>`})})};
        window.loadAdmin=(id,n)=>{state.activeAdminChat=id;document.getElementById('admin-chat-header').innerHTML=`<span>${n}</span><button onclick="kickUser()" id="btn-end-chat" class="hidden bg-red-600 text-white text-[10px] font-bold px-2 py-1 rounded flex items-center gap-1"><i data-lucide="slash" class="w-3 h-3"></i> Ø¥Ù†Ù‡Ø§Ø¡</button>`;document.getElementById('btn-end-chat').classList.remove('hidden');onSnapshot(doc(db,"chats",id),s=>{const b=document.getElementById('admin-msg-area');b.innerHTML='';if(!s.exists())return;s.data().messages.forEach(m=>{b.innerHTML+=`<div class="${m.s==='support'?'text-left':'text-right'} mb-2"><span class="inline-block px-3 py-2 rounded-lg text-xs ${m.s==='support'?'bg-slate-900 dark:bg-emerald-600 text-white':'bg-white/10'}">${m.t}</span></div>`});b.scrollTop=9999})};
        window.sendAdminMsg=async()=>{const t=document.getElementById('admin-input').value;if(!t||!state.activeAdminChat)return;document.getElementById('admin-input').value='';const s=await getDocs(query(collection(db,"chats"),where('__name__','==',state.activeAdminChat)));const m=s.docs[0].data().messages;m.push({s:'support',t,d:new Date()});await updateDoc(doc(db,"chats",state.activeAdminChat),{messages:m,status:'active'})};
        window.kickUser=async()=>{if(confirm("Ø¥Ù†Ù‡Ø§Ø¡ØŸ")){await updateDoc(doc(db,"chats",state.activeAdminChat),{status:'closed'});document.getElementById('admin-msg-area').innerHTML='';document.getElementById('btn-end-chat').classList.add('hidden');state.activeAdminChat=null}};
        window.resetFilters=()=>{document.getElementById('search-input').value='';filter('all')};

        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(reg => console.log('SW registered!', reg.scope))
                    .catch(err => console.log('SW failed:', err));
            });
        }

        lucide.createIcons();
    </script>
</body>
</html>

